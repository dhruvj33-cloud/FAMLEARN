<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamLearn Pro - AI Learning Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Razorpay Checkout -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- KaTeX for Math Equations Support -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
            --sidebar-width: 260px;
        }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; min-height: 100vh; }
        
        /* Toast */
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500; z-index: 10000; animation: slideIn 0.3s ease; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--primary); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* Auth Screen */
        .auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .auth-box { background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 420px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        .auth-box h1 { text-align: center; color: var(--primary); margin-bottom: 8px; }
        .auth-box .subtitle { text-align: center; color: var(--gray); margin-bottom: 30px; }
        .tabs { display: flex; margin-bottom: 25px; background: var(--light); border-radius: 10px; padding: 4px; pointer-events: auto; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 8px; font-weight: 500; color: var(--gray); transition: all 0.3s; pointer-events: auto; user-select: none; }
        .tab:hover { background: rgba(102, 126, 234, 0.1); }
        .tab.active { background: var(--primary); color: white; }
        .tab.active:hover { background: var(--primary); }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--dark); font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { background: var(--primary-dark); }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-success { background: var(--success); }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--warning); }
        .btn-secondary { background: var(--gray); }
        
        /* Main Layout */
        .app-container { display: none; min-height: 100vh; }
        .app-container.active { display: flex; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--dark); color: white; min-height: 100vh; position: fixed; left: 0; top: 0; z-index: 100; transition: transform 0.3s; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #374151; flex-shrink: 0; }
        .sidebar-header h2 { font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
        .sidebar-nav { padding: 15px 0; flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: #9ca3af; cursor: pointer; transition: all 0.3s; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #374151; color: white; border-left-color: var(--secondary); }
        .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }
        .nav-section { padding: 10px 20px 5px; font-size: 11px; text-transform: uppercase; color: #6b7280; letter-spacing: 1px; }
        .sidebar-footer { position: absolute; bottom: 0; width: 100%; padding: 15px 20px; border-top: 1px solid #374151; background: var(--dark); }
        .user-info-sidebar { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .user-details { flex: 1; }
        .user-details .name { font-weight: 500; font-size: 14px; }
        .user-details .role { font-size: 12px; color: #9ca3af; }
        
        /* Main Content */
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 20px 30px; }
        .page { display: none; }
        .page.active { display: block; }
        
        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .page-title { font-size: 1.8rem; color: var(--dark); }
        .header-stats { display: flex; gap: 20px; }
        .header-stat { background: white; padding: 12px 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .header-stat .value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .header-stat .label { font-size: 12px; color: var(--gray); }
        
        /* Cards */
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--dark); display: flex; align-items: center; gap: 10px; }
        .card-subtitle { font-size: 13px; color: var(--gray); }
        
        /* Grid */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        @media (max-width: 1200px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 900px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        
        /* Stats Cards */
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .stat-card .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px; }
        .stat-card .stat-icon.blue { background: #dbeafe; }
        .stat-card .stat-icon.green { background: #d1fae5; }
        .stat-card .stat-icon.yellow { background: #fef3c7; }
        .stat-card .stat-icon.purple { background: #ede9fe; }
        .stat-card .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--dark); }
        .stat-card .stat-label { font-size: 13px; color: var(--gray); margin-top: 5px; }
        .stat-card .stat-change { font-size: 12px; margin-top: 8px; }
        .stat-card .stat-change.up { color: var(--success); }
        .stat-card .stat-change.down { color: var(--danger); }
        
        /* Progress Bars */
        .progress-item { margin-bottom: 20px; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .progress-label { font-weight: 500; color: var(--dark); font-size: 14px; }
        .progress-value { font-weight: 600; color: var(--primary); }
        .progress-bar { height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 5px; transition: width 0.5s ease; }
        .progress-fill.blue { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .progress-fill.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .progress-fill.yellow { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .progress-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }
        
        /* Activity List */
        .activity-list { max-height: 400px; overflow-y: auto; }
        .activity-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f3f4f6; gap: 15px; }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
        .activity-icon.cq { background: #dbeafe; color: #3b82f6; }
        .activity-icon.topic { background: #fef3c7; color: #f59e0b; }
        .activity-details { flex: 1; }
        .activity-title { font-weight: 500; color: var(--dark); font-size: 14px; }
        .activity-meta { font-size: 12px; color: var(--gray); margin-top: 3px; }
        .activity-score { font-weight: 600; font-size: 15px; }
        .activity-score.good { color: var(--success); }
        .activity-score.avg { color: var(--warning); }
        .activity-score.poor { color: var(--danger); }
        
        /* Image Upload */
        .image-upload-zone { border: 3px dashed #cbd5e1; border-radius: 15px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f8fafc; }
        .image-upload-zone:hover { border-color: var(--primary); background: #f5f3ff; }
        .image-upload-zone.has-image { border-color: var(--success); background: #f0fdf4; padding: 15px; }
        .upload-icon { font-size: 48px; margin-bottom: 10px; }
        .upload-text { color: var(--gray); font-size: 14px; }
        .image-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .preview-item { position: relative; aspect-ratio: 1; border-radius: 10px; overflow: hidden; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-item .remove-btn { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; font-size: 12px; }
        
        /* Quiz Area */
        .quiz-container { max-width: 800px; margin: 0 auto; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .quiz-timer { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .quiz-timer.warning { color: var(--warning); }
        .quiz-timer.danger { color: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .quiz-progress { flex: 1; margin: 0 30px; }
        .quiz-progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .quiz-progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; }
        .quiz-progress-text { text-align: center; margin-top: 5px; font-size: 13px; color: var(--gray); }
        
        .question-card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .question-number { font-size: 13px; color: var(--primary); font-weight: 600; margin-bottom: 10px; }
        .question-text { font-size: 1.15rem; color: var(--dark); line-height: 1.6; margin-bottom: 25px; }
        .options-list { display: grid; gap: 12px; }
        .option-item { padding: 16px 20px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 15px; }
        .option-item:hover { border-color: var(--primary); background: #f5f3ff; }
        .option-item.selected { border-color: var(--primary); background: var(--primary); color: white; }
        .option-item.correct { border-color: var(--success); background: #d1fae5; color: #065f46; }
        .option-item.incorrect { border-color: var(--danger); background: #fee2e2; color: #991b1b; }
        .option-letter { width: 32px; height: 32px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
        .option-item.selected .option-letter { background: rgba(255,255,255,0.2); }
        
        .quiz-nav { display: flex; justify-content: space-between; margin-top: 20px; }
        .quiz-nav .btn { width: auto; padding: 12px 30px; }
        
        /* Quiz Results */
        .results-container { text-align: center; padding: 40px 20px; }
        .results-score { font-size: 4rem; font-weight: 700; color: var(--primary); }
        .results-label { font-size: 1.2rem; color: var(--gray); margin-bottom: 30px; }
        .results-stats { display: flex; justify-content: center; gap: 40px; margin: 30px 0; flex-wrap: wrap; }
        .result-stat { text-align: center; }
        .result-stat .value { font-size: 1.5rem; font-weight: 600; color: var(--dark); }
        .result-stat .label { font-size: 13px; color: var(--gray); }
        
        /* Quiz History Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; color: var(--dark); font-size: 13px; }
        td { font-size: 14px; color: #374151; }
        tr:hover { background: #f9fafb; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        
        /* Difficulty Filter */
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .filter-tab { padding: 8px 16px; border-radius: 20px; border: 2px solid #e5e7eb; background: white; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s; }
        .filter-tab:hover { border-color: var(--primary); }
        .filter-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Topic Cards */
        .topic-card { background: white; border-radius: 12px; padding: 20px; border-left: 4px solid; margin-bottom: 15px; }
        .topic-card.strong { border-left-color: var(--success); }
        .topic-card.weak { border-left-color: var(--danger); }
        .topic-card.average { border-left-color: var(--warning); }
        .topic-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .topic-name { font-weight: 600; color: var(--dark); }
        .topic-score { font-weight: 700; font-size: 1.2rem; }
        .topic-meta { display: flex; gap: 20px; font-size: 13px; color: var(--gray); }
        
        /* Charts */
        .chart-container { position: relative; height: 250px; }
        
        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: 600; }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); }
        
        /* Loading */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 9999; flex-direction: column; gap: 20px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-overlay p { color: white; font-size: 16px; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--gray); }
        .empty-state .icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { color: var(--dark); margin-bottom: 10px; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .mobile-toggle { display: block !important; }
        }
        .mobile-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 101; background: var(--dark); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingText">Loading...</p>
    </div>

    <!-- Auth Screen -->
    <div class="auth-container" id="authScreen">
        <div class="auth-box">
            <h1>üéì FamLearn Pro</h1>
            <p class="subtitle">AI-Powered Learning Analytics</p>
            
            <div class="tabs">
                <div class="tab active" id="loginTab" onclick="switchToLogin()">Login</div>
                <div class="tab" id="registerTab" onclick="switchToRegister()">Register</div>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
            
            <form id="registerForm" style="display:none;" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Full Name (no spaces allowed)</label>
                    <input type="text" id="regName" required placeholder="JohnDoe" pattern="^\S+$" title="No spaces allowed in username" oninput="this.value = this.value.replace(/\s/g, '')">
                    <small style="color:var(--gray);font-size:11px;">Username cannot contain spaces</small>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="regPhone" required placeholder="9876543210" pattern="[0-9]{10}" title="Enter 10 digit phone number" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" required minlength="6" placeholder="Min 6 characters">
                </div>
                <div class="form-group">
                    <label>I am a...</label>
                    <select id="regRole" onchange="toggleParentFields()">
                        <option value="student">Student</option>
                        <option value="tutor">Tutor / Teacher</option>
                    </select>
                </div>
                <div id="parentFieldsGroup" style="display:none;">
                    <div class="form-group">
                        <label>Parent's Email</label>
                        <input type="email" id="regParentEmail" placeholder="parent@email.com">
                        <small style="color:var(--gray);font-size:11px;">Weekly reports will be sent here</small>
                    </div>
                    <div class="form-group">
                        <label>Parent's Phone</label>
                        <input type="tel" id="regParentPhone" placeholder="9876543210" pattern="[0-9]{10}" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                </div>
                <button type="submit" class="btn">Create Account</button>
            </form>

            <!-- OTP Verification Form -->
            <div id="otpVerificationForm" style="display:none;">
                <div style="text-align:center;margin-bottom:25px;">
                    <div style="font-size:3em;margin-bottom:10px;">üìß</div>
                    <h3 style="margin-bottom:10px;">Verify Your Email</h3>
                    <p style="color:var(--gray);font-size:14px;">We've sent a 6-digit code to<br><strong id="otpEmail"></strong></p>
                </div>

                <div class="form-group">
                    <label>Enter 6-Digit OTP</label>
                    <div style="display:flex;gap:10px;justify-content:center;margin:20px 0;">
                        <input type="text" id="otp1" maxlength="1" class="otp-input" style="width:50px;height:50px;text-align:center;font-size:24px;border:2px solid #e0e0e0;border-radius:8px;" oninput="moveToNext(this, 'otp2')" onkeydown="moveToPrev(event, this, null)">
                        <input type="text" id="otp2" maxlength="1" class="otp-input" style="width:50px;height:50px;text-align:center;font-size:24px;border:2px solid #e0e0e0;border-radius:8px;" oninput="moveToNext(this, 'otp3')" onkeydown="moveToPrev(event, this, 'otp1')">
                        <input type="text" id="otp3" maxlength="1" class="otp-input" style="width:50px;height:50px;text-align:center;font-size:24px;border:2px solid #e0e0e0;border-radius:8px;" oninput="moveToNext(this, 'otp4')" onkeydown="moveToPrev(event, this, 'otp2')">
                        <input type="text" id="otp4" maxlength="1" class="otp-input" style="width:50px;height:50px;text-align:center;font-size:24px;border:2px solid #e0e0e0;border-radius:8px;" oninput="moveToNext(this, 'otp5')" onkeydown="moveToPrev(event, this, 'otp3')">
                        <input type="text" id="otp5" maxlength="1" class="otp-input" style="width:50px;height:50px;text-align:center;font-size:24px;border:2px solid #e0e0e0;border-radius:8px;" oninput="moveToNext(this, 'otp6')" onkeydown="moveToPrev(event, this, 'otp4')">
                        <input type="text" id="otp6" maxlength="1" class="otp-input" style="width:50px;height:50px;text-align:center;font-size:24px;border:2px solid #e0e0e0;border-radius:8px;" oninput="autoSubmitOTP()" onkeydown="moveToPrev(event, this, 'otp5')">
                    </div>
                </div>

                <div style="text-align:center;margin:20px 0;">
                    <p style="color:var(--gray);font-size:14px;">
                        Code expires in: <strong id="otpCountdown" style="color:var(--primary);">5:00</strong>
                    </p>
                </div>

                <button class="btn" onclick="verifyOTP()" style="width:100%;margin-bottom:10px;">Verify OTP</button>
                <button class="btn secondary" onclick="resendOTP()" id="resendBtn" style="width:100%;">Resend Code</button>
                <button class="btn" onclick="cancelOTPVerification()" style="width:100%;margin-top:10px;background:var(--gray);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Student App -->
    <div class="app-container" id="studentApp">
        <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>
        
        <aside class="sidebar" id="studentSidebar">
            <div class="sidebar-header">
                <h2>üéì FamLearn Pro</h2>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">Main</div>
                <div class="nav-item active" onclick="showPage('dashboard', event)">
                    <span class="icon">üìä</span> Dashboard
                </div>
                <div class="nav-item" onclick="showPage('newQuiz', event)">
                    <span class="icon">üìù</span> New Quiz
                </div>
                <div class="nav-item" onclick="showPage('history', event)">
                    <span class="icon">üìö</span> Quiz History
                </div>
                <div class="nav-section">Analytics</div>
                <div class="nav-item" onclick="showPage('performance', event)">
                    <span class="icon">üìà</span> Performance
                </div>
                <div class="nav-item" onclick="showPage('topics', event)">
                    <span class="icon">üéØ</span> Topic Analysis
                </div>
                <div class="nav-item" onclick="showPage('leaderboard', event)">
                    <span class="icon">üèÜ</span> Leaderboard
                </div>
                <div class="nav-section">Account</div>
                <div class="nav-item" onclick="showPage('pricing', event)">
                    <span class="icon">üíé</span> Upgrade Plan
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info-sidebar" style="flex-direction:column;align-items:stretch;gap:8px;padding:12px;position:relative;">
                    <!-- User Header (clickable) -->
                    <div onclick="toggleUserProfilePopup()" style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px;border-radius:8px;transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                        <div class="user-avatar" id="userAvatar">S</div>
                        <div style="flex:1;min-width:0;">
                            <div class="name" id="sidebarUserName" style="font-size:14px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Student</div>
                            <div id="sidebarTierName" style="font-size:11px;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Free Trial</div>
                        </div>
                        <button onclick="event.stopPropagation(); logout()" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:18px;padding:4px;" title="Logout">‚èª</button>
                    </div>

                    <!-- Subscription Info -->
                    <div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;font-size:11px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <span style="color:#9ca3af;">‚è±Ô∏è Time Remaining</span>
                            <span id="sidebarDaysLeft" style="color:#fbbf24;font-weight:600;">3 days</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="color:#9ca3af;">üìù Quizzes Today</span>
                            <span id="sidebarQuizCount" style="color:#10b981;font-weight:600;">0/2</span>
                        </div>
                    </div>

                    <!-- Upgrade Button (hidden for paid users) -->
                    <button id="sidebarUpgradeBtn" onclick="showPage('pricing', event)" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border:none;padding:8px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;display:none;">
                        ‚ö° Upgrade Now
                    </button>

                    <!-- User Profile Popup -->
                    <div id="userProfilePopup" style="display:none;position:absolute;bottom:100%;left:12px;right:12px;margin-bottom:8px;background:#1f2937;border:1px solid #374151;border-radius:12px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,0.5);z-index:1000;">
                        <!-- Profile Header -->
                        <div style="text-align:center;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #374151;">
                            <div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;font-size:32px;font-weight:bold;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;" id="popupAvatar">S</div>
                            <div style="font-size:16px;font-weight:600;color:#fff;margin-bottom:4px;" id="popupFullName">Student Name</div>
                            <div style="font-size:12px;color:#9ca3af;" id="popupEmail">student@example.com</div>
                            <div style="font-size:12px;color:#9ca3af;margin-top:2px;" id="popupPhone">+91 98765 43210</div>
                        </div>

                        <!-- Subscription Details -->
                        <div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:12px;margin-bottom:16px;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                <span style="font-size:24px;">üé´</span>
                                <div style="flex:1;">
                                    <div style="font-size:11px;color:#9ca3af;">Subscription Tier</div>
                                    <div style="font-size:14px;font-weight:600;color:#fff;" id="popupTier">Free Trial</div>
                                </div>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                <span style="font-size:24px;">‚è±Ô∏è</span>
                                <div style="flex:1;">
                                    <div style="font-size:11px;color:#9ca3af;">Expires</div>
                                    <div style="font-size:14px;font-weight:600;color:#fbbf24;" id="popupExpiry">Jan 11, 2026</div>
                                </div>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <span style="font-size:24px;">üìù</span>
                                <div style="flex:1;">
                                    <div style="font-size:11px;color:#9ca3af;">Quizzes This Month</div>
                                    <div style="font-size:14px;font-weight:600;color:#10b981;" id="popupQuizCount">4/5</div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            <button onclick="showPage('pricing', event); toggleUserProfilePopup()" style="background:#374151;color:#fff;border:none;padding:10px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:background 0.2s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#374151'">
                                ‚öôÔ∏è Settings
                            </button>
                            <button onclick="logout()" style="background:#ef4444;color:#fff;border:none;padding:10px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Testing Mode Banner -->
            <div id="testingModeBanner" style="display:none;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:#fff;padding:12px 20px;margin:-20px -20px 20px -20px;border-radius:0;font-size:14px;font-weight:600;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                üß™ TESTING MODE ACTIVE - All features unlocked ‚Ä¢ No payment required ‚Ä¢ Set TESTING_MODE = false to re-enable subscriptions
            </div>

            <!-- Dashboard Page -->
            <div class="page active" id="dashboardPage">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="header-stats">
                        <div class="header-stat">
                            <div class="value" id="totalPoints">0</div>
                            <div class="label">Total Points</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid-4" style="margin-bottom:25px;">
                    <div class="stat-card">
                        <div class="stat-icon blue">üìù</div>
                        <div class="stat-value" id="statTotalQuizzes">0</div>
                        <div class="stat-label">Quizzes Taken</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">üìä</div>
                        <div class="stat-value" id="statAvgScore">0%</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">‚è±Ô∏è</div>
                        <div class="stat-value" id="statAvgTime">0m</div>
                        <div class="stat-label">Avg. Time/Quiz</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">üî•</div>
                        <div class="stat-value" id="statStreak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>

                <!-- Assigned Quizzes Section -->
                <div class="card" style="margin-bottom:25px;" id="assignedQuizzesCard">
                    <div class="card-header">
                        <div class="card-title">üìã Assigned Quizzes</div>
                    </div>
                    <div id="assignedQuizzesContainer">
                        <div style="text-align:center;padding:40px;color:var(--gray);">Loading assigned quizzes...</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìà Score Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="scoreTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üïê Latest Activity</div>
                        </div>
                        <div class="activity-list" id="latestActivity">
                            <div class="empty-state">
                                <div class="icon">üìù</div>
                                <h3>No quizzes yet</h3>
                                <p>Take your first quiz to see activity</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üí™ Strong Topics</div>
                        </div>
                        <div id="strongTopics">
                            <div class="empty-state" style="padding:20px;">
                                <p>Complete more quizzes to see analysis</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">‚ö†Ô∏è Needs Improvement</div>
                        </div>
                        <div id="weakTopics">
                            <div class="empty-state" style="padding:20px;">
                                <p>Complete more quizzes to see analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- New Quiz Page -->
            <div class="page" id="newQuizPage">
                <div class="page-header">
                    <h1 class="page-title">Create New Quiz</h1>
                </div>
                
                <div class="quiz-container">
                    <div class="card" id="quizSetupCard">
                        <div class="card-title" style="margin-bottom:20px;">üì∏ Upload Your Study Material</div>
                        
                        <div class="image-upload-zone" id="imageUploadZone">
                            <div class="upload-icon">üì∏</div>
                            <p class="upload-text">
                                <strong>Paste screenshot (Ctrl+V)</strong> or <strong>click to upload</strong><br>
                                <small>Upload up to 5 images ‚Ä¢ Auto-compressed</small>
                            </p>
                            <input type="file" id="imageInput" accept="image/*" multiple style="display:none">
                            <div class="image-preview-grid" id="imagePreviewGrid"></div>
                        </div>
                        
                        <!-- Subject & Chapter -->
                        <div class="grid-2" style="margin-top:20px;">
                            <div class="form-group">
                                <label>Subject *</label>
                                <select id="quizSubject" onchange="toggleOtherSubject()" required>
                                    <option value="">Select Subject</option>
                                    <option value="English">English</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Political Science">Political Science</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Economics">Economics</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="Other">Other (Enter manually)</option>
                                </select>
                            </div>
                            <div class="form-group" id="otherSubjectGroup" style="display:none;">
                                <label>Enter Subject Name *</label>
                                <input type="text" id="otherSubjectInput" placeholder="e.g., Psychology">
                            </div>
                            <div class="form-group" id="chapterGroup">
                                <label>Chapter / Topic Name *</label>
                                <input type="text" id="quizChapter" placeholder="e.g., Photosynthesis, French Revolution" required>
                            </div>
                        </div>
                        
                        <!-- Difficulty & Questions -->
                        <div class="grid-2" style="margin-top:10px;">
                            <div class="form-group">
                                <label>Difficulty</label>
                                <select id="quizDifficulty">
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Questions</label>
                                <select id="quizCount">
                                    <option value="5">5 Questions</option>
                                    <option value="10" selected>10 Questions</option>
                                    <option value="15">15 Questions</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Quiz Title Preview -->
                        <div class="form-group" style="margin-top:10px;">
                            <label>Quiz Title (auto-generated)</label>
                            <div id="quizTitlePreview" style="padding:12px 15px;background:#f3f4f6;border-radius:10px;color:var(--gray);font-size:14px;">
                                Select subject and enter chapter name...
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="startQuizFromImages()" style="margin-top:15px;">
                            üöÄ Generate Quiz from Images (12 min timer)
                        </button>
                        
                        <div style="text-align:center;margin:25px 0;color:var(--gray);">‚Äî OR generate without images ‚Äî</div>
                        
                        <button class="btn" onclick="startQuizFromTopic()">üìö Generate from Topic Only</button>
                        
                        <!-- Hidden field for backward compatibility -->
                        <input type="hidden" id="quizTopic" value="">
                    </div>
                    
                    <!-- Active Quiz -->
                    <div id="activeQuizArea" style="display:none;">
                        <div class="quiz-header">
                            <div class="quiz-timer" id="quizTimer">‚è±Ô∏è 12:00</div>
                            <div class="quiz-progress">
                                <div class="quiz-progress-bar">
                                    <div class="quiz-progress-fill" id="quizProgressFill" style="width:0%"></div>
                                </div>
                                <div class="quiz-progress-text" id="quizProgressText">Question 1 of 10</div>
                            </div>
                            <div id="quizScoreDisplay" style="font-weight:600;">Score: 0</div>
                        </div>
                        
                        <div class="question-card" id="questionCard">
                            <div class="question-number" id="questionNumber">Question 1</div>
                            <div class="question-text" id="questionText">Loading question...</div>
                            <div class="options-list" id="optionsList"></div>
                            <div id="lifelineContainer" style="margin-top:15px;text-align:center;display:none;">
                                <button class="btn btn-warning" onclick="useFiftyFifty()" id="fiftyFiftyBtn" style="padding:10px 20px;">
                                    ‚ö° 50/50 <span id="lifelineCount">(2 left)</span>
                                </button>
                                <div style="font-size:12px;color:var(--gray);margin-top:8px;">Eliminates 2 wrong answers</div>
                            </div>
                        </div>

                        <div class="quiz-nav">
                            <button class="btn btn-secondary" onclick="skipQuestion()" id="skipBtn">Skip</button>
                            <button class="btn" onclick="nextQuestion()" id="nextBtn" style="display:none;">Next Question ‚Üí</button>
                        </div>
                    </div>
                    
                    <!-- Quiz Results -->
                    <div id="quizResultsArea" style="display:none;">
                        <div class="card">
                            <div class="results-container">
                                <h2 style="margin-bottom:10px;">üéâ Quiz Complete!</h2>
                                <div class="results-score" id="resultScore">0/10</div>
                                <div class="results-label" id="resultPercentage">0%</div>
                                
                                <div class="results-stats">
                                    <div class="result-stat">
                                        <div class="value" id="resultCorrect">0</div>
                                        <div class="label">Correct</div>
                                    </div>
                                    <div class="result-stat">
                                        <div class="value" id="resultWrong">0</div>
                                        <div class="label">Wrong</div>
                                    </div>
                                    <div class="result-stat">
                                        <div class="value" id="resultTime">0:00</div>
                                        <div class="label">Time Taken</div>
                                    </div>
                                    <div class="result-stat">
                                        <div class="value" id="resultPoints">+0</div>
                                        <div class="label">Points Earned</div>
                                    </div>
                                </div>
                                
                                <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:30px;">
                                    <button class="btn" onclick="reviewQuiz()" style="flex:1;min-width:140px;">üìñ Review Answers</button>
                                    <button class="btn btn-success" onclick="resetQuiz()" style="flex:1;min-width:140px;">üîÑ New Quiz</button>
                                </div>
                                
                                <!-- Retake with Options -->
                                <div style="margin-top:25px;padding:20px;background:#f3f4f6;border-radius:12px;">
                                    <div style="font-weight:600;margin-bottom:15px;color:var(--dark);">üîÅ Retake Quiz on Same Topic</div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
                                        <div>
                                            <label style="font-size:13px;color:var(--gray);display:block;margin-bottom:5px;">Difficulty</label>
                                            <select id="retakeDifficulty" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">
                                                <option value="easy">Easy</option>
                                                <option value="medium" selected>Medium</option>
                                                <option value="hard">Hard</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="font-size:13px;color:var(--gray);display:block;margin-bottom:5px;">Questions</label>
                                            <select id="retakeCount" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">
                                                <option value="5">5 Questions</option>
                                                <option value="10" selected>10 Questions</option>
                                                <option value="15">15 Questions</option>
                                                <option value="20">20 Questions</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button class="btn btn-warning" onclick="retakeQuizWithOptions()" style="width:100%;">üöÄ Generate New Questions</button>
                                </div>
                                
                                <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:15px;">
                                    <button class="btn btn-secondary" onclick="shareQuiz()" style="flex:1;min-width:140px;">üì§ Share Quiz</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Join Shared Quiz Section - Add to Quiz Page -->
            <div class="card" id="joinQuizCard" style="margin-top:20px;display:none;">
                <div class="card-title" style="margin-bottom:15px;">üîó Join a Shared Quiz</div>
                <div style="display:flex;gap:10px;">
                    <input type="text" id="joinQuizCode" placeholder="Enter 6-letter code" maxlength="6" 
                           style="flex:1;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px;text-transform:uppercase;">
                    <button class="btn" onclick="joinQuizByCode(document.getElementById('joinQuizCode').value)" style="width:auto;padding:12px 25px;">Join</button>
                </div>
            </div>
            
            <!-- Quiz History Page -->
            <div class="page" id="historyPage">
                <div class="page-header">
                    <h1 class="page-title">Quiz History</h1>
                </div>
                
                <div class="card">
                    <div class="filter-tabs" id="historyFilter">
                        <div class="filter-tab active" data-filter="all">All</div>
                        <div class="filter-tab" data-filter="easy">Easy</div>
                        <div class="filter-tab" data-filter="medium">Medium</div>
                        <div class="filter-tab" data-filter="hard">Hard</div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Topic</th>
                                    <th>Difficulty</th>
                                    <th>Score</th>
                                    <th>Time</th>
                                    <th>Points</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr><td colspan="7" style="text-align:center;color:var(--gray);padding:40px;">No quiz history yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Performance Page -->
            <div class="page" id="performancePage">
                <div class="page-header">
                    <h1 class="page-title">Performance Analysis</h1>
                </div>
                
                <!-- Filters Row -->
                <div class="card" style="margin-bottom:20px;padding:15px;">
                    <div style="display:flex;flex-wrap:wrap;gap:15px;align-items:center;">
                        <div>
                            <label style="font-size:12px;color:var(--gray);display:block;margin-bottom:5px;">Time Period</label>
                            <select id="perfTimeFilter" onchange="loadEnhancedAnalytics()" style="padding:8px 12px;border-radius:8px;border:2px solid #e5e7eb;">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="all">All time</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:var(--gray);display:block;margin-bottom:5px;">Difficulty</label>
                            <select id="perfDifficultyFilter" onchange="loadEnhancedAnalytics()" style="padding:8px 12px;border-radius:8px;border:2px solid #e5e7eb;">
                                <option value="all">All Difficulties</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:var(--gray);display:block;margin-bottom:5px;">Subject</label>
                            <select id="perfSubjectFilter" onchange="loadEnhancedAnalytics(); updateBlockFilter()" style="padding:8px 12px;border-radius:8px;border:2px solid #e5e7eb;">
                                <option value="all">All Subjects</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Physics">Physics</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Biology">Biology</option>
                                <option value="History">History</option>
                                <option value="Geography">Geography</option>
                                <option value="English">English</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Economics">Economics</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:var(--gray);display:block;margin-bottom:5px;">Block/Subtopic</label>
                            <select id="perfBlockFilter" onchange="loadEnhancedAnalytics()" style="padding:8px 12px;border-radius:8px;border:2px solid #e5e7eb;">
                                <option value="all">All Blocks</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:var(--gray);display:block;margin-bottom:5px;">Questions</label>
                            <select id="perfQuestionsFilter" onchange="loadEnhancedAnalytics()" style="padding:8px 12px;border-radius:8px;border:2px solid #e5e7eb;">
                                <option value="all">All Questions</option>
                                <option value="10">Last 10</option>
                                <option value="20">Last 20</option>
                                <option value="30">Last 30</option>
                                <option value="50">Last 50</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="grid-4" style="margin-bottom:20px;">
                    <div class="stat-card">
                        <div class="stat-icon blue">üìù</div>
                        <div class="stat-value" id="perfQuizzesTaken">0</div>
                        <div class="stat-label">Questions Attempted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">üéØ</div>
                        <div class="stat-value" id="perfOverallAccuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">‚è±Ô∏è</div>
                        <div class="stat-value" id="perfAvgTime">0s</div>
                        <div class="stat-label">Avg Time/Question</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">üìä</div>
                        <div class="stat-value" id="perfCorrectCount">0</div>
                        <div class="stat-label">Correct Answers</div>
                    </div>
                </div>
                
                <!-- Performance Trend Chart -->
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header">
                        <div class="card-title">üìà Accuracy Trend (Over Time)</div>
                    </div>
                    <div class="chart-container" style="height:280px;">
                        <canvas id="performanceOverTimeChart"></canvas>
                    </div>
                </div>
                
                <!-- Block-wise Performance -->
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header">
                        <div class="card-title">üß© Block-wise Performance</div>
                    </div>
                    <div id="blockPerformanceContainer">
                        <div class="empty-state" style="padding:30px;">
                            <p>Select a subject to see block-wise breakdown</p>
                        </div>
                    </div>
                </div>
                
                <!-- Difficulty Breakdown -->
                <div class="grid-2" style="margin-bottom:20px;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üéØ Accuracy by Difficulty</div>
                        </div>
                        <div class="chart-container" style="height:200px;">
                            <canvas id="accuracyChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">‚è±Ô∏è Avg Time by Difficulty</div>
                        </div>
                        <div class="chart-container" style="height:200px;">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Breakdown Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìä Detailed Breakdown</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Difficulty</th>
                                    <th>Questions</th>
                                    <th>Correct</th>
                                    <th>Accuracy</th>
                                    <th>Avg Time/Q</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="difficultyBreakdownTable">
                                <tr><td colspan="6" style="text-align:center;color:var(--gray);padding:20px;">Take quizzes to see breakdown</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Topics Page -->
            <div class="page" id="topicsPage">
                <div class="page-header">
                    <h1 class="page-title">Topic Analysis</h1>
                </div>
                
                <div class="grid-2" style="margin-bottom:20px;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üí™ Strong Topics</div>
                            <span class="card-subtitle">70%+ accuracy</span>
                        </div>
                        <div id="strongTopicsDetailed">
                            <div class="empty-state" style="padding:20px;">
                                <p>Complete more quizzes to identify strengths</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìà Needs Improvement</div>
                            <span class="card-subtitle">Below 60% accuracy</span>
                        </div>
                        <div id="weakTopicsDetailed">
                            <div class="empty-state" style="padding:20px;">
                                <p>Great job! No weak areas detected</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìö All Topics Performance</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Topic</th>
                                    <th>Quizzes</th>
                                    <th>Questions</th>
                                    <th>Accuracy</th>
                                    <th>Avg Time</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody id="topicsTableBody">
                                <tr><td colspan="6" style="text-align:center;color:var(--gray);padding:30px;">Complete quizzes to see topic analysis</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard Page -->
            <div class="page" id="leaderboardPage">
                <div class="page-header">
                    <h1 class="page-title">üèÜ Leaderboard</h1>
                </div>

                <!-- Time Filter Tabs -->
                <div class="card" style="margin-bottom:20px;">
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn" id="leaderboard-today" onclick="loadLeaderboard('today')" style="flex:1;min-width:120px;">Today</button>
                        <button class="btn" id="leaderboard-week" onclick="loadLeaderboard('week')" style="flex:1;min-width:120px;">This Week</button>
                        <button class="btn" id="leaderboard-month" onclick="loadLeaderboard('month')" style="flex:1;min-width:120px;">This Month</button>
                        <button class="btn btn-success" id="leaderboard-all" onclick="loadLeaderboard('all')" style="flex:1;min-width:120px;">All Time</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Score ‚≠ê</th>
                                    <th>Points</th>
                                    <th>Quizzes</th>
                                    <th>Avg %</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody">
                                <tr><td colspan="6" style="text-align:center;color:var(--gray);padding:40px;">Loading...</td></tr>
                            </tbody>
                        </table>
                        <div style="margin-top:15px;padding:15px;background:#f0f9ff;border-radius:8px;font-size:13px;color:#0369a1;">
                            <strong>‚≠ê Ranking Score Formula:</strong> (Avg Score √ó 50%) + (Points √ó 30%) + (Quizzes √ó 20%)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing Page -->
            <div class="page" id="pricingPage">
                <div class="page-header">
                    <h1 class="page-title">üíé Upgrade Your Plan</h1>
                </div>

                <!-- Current Plan Banner -->
                <div class="card" id="currentPlanBanner" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;margin-bottom:30px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h3 style="color:white;margin-bottom:5px;">Current Plan: <span id="currentTierName">Free Trial</span></h3>
                            <p style="opacity:0.9;margin:0;" id="currentPlanDetails">3 days remaining ‚Ä¢ 2/5 quizzes used</p>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:14px;opacity:0.8;">Daily Limit</div>
                            <div style="font-size:24px;font-weight:bold;" id="dailyLimitDisplay">2/2</div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Cards -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:30px;">

                    <!-- Learner Plan -->
                    <div class="card" style="border:3px solid var(--primary);position:relative;">
                        <div style="position:absolute;top:-15px;right:20px;background:var(--secondary);color:white;padding:5px 15px;border-radius:20px;font-size:12px;font-weight:bold;">
                            POPULAR
                        </div>
                        <h3 style="color:var(--primary);margin-bottom:10px;">üìö Learner</h3>
                        <div style="display:flex;align-items:baseline;margin-bottom:20px;">
                            <span style="font-size:2.5rem;font-weight:bold;color:var(--dark);">‚Çπ149</span>
                            <span style="color:var(--gray);margin-left:8px;">/month</span>
                        </div>
                        <div style="margin-bottom:20px;">
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 3 quizzes per day</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 25 quizzes per month</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Store up to 25 quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 2 lifelines per quiz</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Full analytics access</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Leaderboard access</div>
                            <div style="padding:8px 0;">‚úÖ Answer explanations</div>
                        </div>
                        <button class="btn btn-primary" onclick="initiatePurchase('learner', 149, 'monthly')" style="width:100%;">
                            Upgrade Now
                        </button>
                    </div>

                    <!-- Pro Student Plan -->
                    <div class="card" style="border:2px solid #e5e7eb;">
                        <h3 style="color:var(--success);margin-bottom:10px;">üöÄ Pro Student</h3>
                        <div style="display:flex;align-items:baseline;margin-bottom:20px;">
                            <span style="font-size:2.5rem;font-weight:bold;color:var(--dark);">‚Çπ299</span>
                            <span style="color:var(--gray);margin-left:8px;">/month</span>
                        </div>
                        <div style="margin-bottom:20px;">
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 5 quizzes per day</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ <strong>Unlimited</strong> monthly quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Store up to 50 quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 2 lifelines per quiz</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Full analytics access</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Leaderboard access</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Answer explanations</div>
                            <div style="padding:8px 0;">‚úÖ Priority support</div>
                        </div>
                        <button class="btn btn-success" onclick="initiatePurchase('pro_student', 299, 'monthly')" style="width:100%;">
                            Upgrade Now
                        </button>
                    </div>

                    <!-- Pro Tutor Plan -->
                    <div class="card" id="tutorPlanCard" style="border:2px solid #e5e7eb;display:none;">
                        <h3 style="color:var(--warning);margin-bottom:10px;">üë®‚Äçüè´ Pro Tutor</h3>
                        <div style="margin-bottom:20px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                <div>
                                    <div style="font-size:1.8rem;font-weight:bold;color:var(--dark);">‚Çπ1,499</div>
                                    <div style="color:var(--gray);font-size:14px;">/quarter</div>
                                </div>
                                <div>
                                    <div style="font-size:1.8rem;font-weight:bold;color:var(--dark);">‚Çπ4,999</div>
                                    <div style="color:var(--gray);font-size:14px;">/year</div>
                                    <div style="background:var(--success);color:white;padding:2px 8px;border-radius:4px;font-size:11px;margin-top:4px;">Save 17%</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom:20px;">
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 5 quizzes per day</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ <strong>Unlimited</strong> monthly quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Store up to 25 quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Batch management</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Student progress tracking</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Quiz assignments</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Full analytics</div>
                            <div style="padding:8px 0;">‚úÖ Priority support</div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <button class="btn btn-warning" onclick="initiatePurchase('pro_tutor', 1499, 'quarterly')" style="width:100%;">
                                Quarterly
                            </button>
                            <button class="btn btn-warning" onclick="initiatePurchase('pro_tutor', 4999, 'yearly')" style="width:100%;">
                                Yearly
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Features Comparison Table -->
                <div class="card">
                    <h3 style="margin-bottom:20px;">üìä Feature Comparison</h3>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:var(--light);">
                                    <th style="padding:12px;text-align:left;">Feature</th>
                                    <th style="padding:12px;text-align:center;">Free Trial</th>
                                    <th style="padding:12px;text-align:center;">Learner</th>
                                    <th style="padding:12px;text-align:center;">Pro Student</th>
                                    <th style="padding:12px;text-align:center;">Pro Tutor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Daily Quiz Limit</td>
                                    <td style="padding:12px;text-align:center;">2</td>
                                    <td style="padding:12px;text-align:center;">3</td>
                                    <td style="padding:12px;text-align:center;">5</td>
                                    <td style="padding:12px;text-align:center;">5</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Monthly Quiz Limit</td>
                                    <td style="padding:12px;text-align:center;">5</td>
                                    <td style="padding:12px;text-align:center;">25</td>
                                    <td style="padding:12px;text-align:center;">Unlimited</td>
                                    <td style="padding:12px;text-align:center;">Unlimited</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Quiz Library</td>
                                    <td style="padding:12px;text-align:center;">5</td>
                                    <td style="padding:12px;text-align:center;">25</td>
                                    <td style="padding:12px;text-align:center;">50</td>
                                    <td style="padding:12px;text-align:center;">25</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">50/50 Lifelines</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ 2/quiz</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ 2/quiz</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ 2/quiz</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Analytics</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Leaderboard</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Answer Explanations</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Batch Management</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                                <tr>
                                    <td style="padding:12px;">Priority Support</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- FAQ Section -->
                <div class="card">
                    <h3 style="margin-bottom:20px;">‚ùì Frequently Asked Questions</h3>
                    <div style="space-y:15px;">
                        <div style="margin-bottom:15px;">
                            <h4 style="color:var(--primary);margin-bottom:5px;">What happens when my trial ends?</h4>
                            <p style="color:var(--gray);margin:0;">Your account remains active, but you'll have limited access. Students can access their last 3 quizzes, while tutors will need to upgrade to continue creating quizzes.</p>
                        </div>
                        <div style="margin-bottom:15px;">
                            <h4 style="color:var(--primary);margin-bottom:5px;">Can I cancel anytime?</h4>
                            <p style="color:var(--gray);margin:0;">Yes! You can cancel your subscription anytime. You'll retain access until the end of your billing period.</p>
                        </div>
                        <div style="margin-bottom:15px;">
                            <h4 style="color:var(--primary);margin-bottom:5px;">What payment methods do you accept?</h4>
                            <p style="color:var(--gray);margin:0;">We accept UPI, Credit/Debit Cards, Net Banking, and Wallets through Razorpay's secure payment gateway.</p>
                        </div>
                        <div>
                            <h4 style="color:var(--primary);margin-bottom:5px;">Do you offer refunds?</h4>
                            <p style="color:var(--gray);margin:0;">Yes, we offer a 7-day money-back guarantee if you're not satisfied with your subscription.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Tutor App -->
    <div class="app-container" id="tutorApp">
        <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>
        
        <aside class="sidebar" id="tutorSidebar">
            <div class="sidebar-header">
                <h2>üéì FamLearn Pro</h2>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">Main</div>
                <div class="nav-item active" onclick="showTutorPage('tutorDashboard')">
                    <span class="icon">üìä</span> Dashboard
                </div>
                <div class="nav-item" onclick="showTutorPage('createQuiz')">
                    <span class="icon">üìù</span> Create Quiz
                </div>
                <div class="nav-item" onclick="showTutorPage('savedQuizzes')">
                    <span class="icon">üíæ</span> Saved Quizzes
                </div>
                <div class="nav-section">Manage</div>
                <div class="nav-item" onclick="showTutorPage('batches')">
                    <span class="icon">üë•</span> Batches
                </div>
                <div class="nav-item" onclick="showTutorPage('students')">
                    <span class="icon">üéì</span> Students
                </div>
                <div class="nav-section">Analytics</div>
                <div class="nav-item" onclick="showTutorPage('analytics')">
                    <span class="icon">üìà</span> Analytics
                </div>
                <div class="nav-section">Settings</div>
                <div class="nav-item" onclick="showTutorPage('settings')">
                    <span class="icon">‚öôÔ∏è</span> Institute Settings
                </div>
                <div class="nav-item" onclick="showTutorPage('pricing')">
                    <span class="icon">üíé</span> Upgrade Plan
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info-sidebar">
                    <div class="user-avatar" id="tutorAvatar">T</div>
                    <div class="user-details">
                        <div class="name" id="tutorSidebarName">Tutor</div>
                        <div class="role">Tutor</div>
                    </div>
                    <button onclick="logout()" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:18px;">‚èª</button>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Tutor Dashboard -->
            <div class="page active" id="tutorDashboardPage">
                <div class="page-header">
                    <h1 class="page-title">Tutor Dashboard</h1>
                </div>
                
                <div class="grid-4" style="margin-bottom:25px;">
                    <div class="stat-card">
                        <div class="stat-icon blue">üë•</div>
                        <div class="stat-value" id="tutorStatBatches">0</div>
                        <div class="stat-label">Total Batches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">üéì</div>
                        <div class="stat-value" id="tutorStatStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">üìù</div>
                        <div class="stat-value" id="tutorStatQuizzes">0</div>
                        <div class="stat-label">Quizzes Created</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">üìä</div>
                        <div class="stat-value" id="tutorStatAvgScore">0%</div>
                        <div class="stat-label">Avg Student Score</div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Batch Performance</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="batchPerformanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üïê Recent Student Activity</div>
                        </div>
                        <div class="activity-list" id="tutorRecentActivity">
                            <div class="empty-state" style="padding:20px;">
                                <p>No student activity yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Batch Leaderboard Section -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header">
                        <div class="card-title">üèÜ Batch Leaderboard</div>
                        <select id="dashboardBatchSelect" onchange="loadBatchLeaderboard()" style="padding:8px 15px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;">
                            <option value="">Select Batch</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Student</th>
                                    <th>Score ‚≠ê</th>
                                    <th>Quizzes</th>
                                    <th>Avg</th>
                                    <th>Best</th>
                                </tr>
                            </thead>
                            <tbody id="batchLeaderboardBody">
                                <tr><td colspan="6" style="text-align:center;color:var(--gray);padding:30px;">Select a batch to view leaderboard</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Create Quiz Page -->
            <div class="page" id="createQuizPage">
                <div class="page-header">
                    <h1 class="page-title">Create Quiz</h1>
                </div>
                
                <div class="grid-2">
                    <div class="card">
                        <div class="card-title" style="margin-bottom:20px;">üì∏ Upload Content</div>
                        
                        <div class="image-upload-zone" id="tutorImageUploadZone" onclick="document.getElementById('tutorImageInput').click()">
                            <div class="upload-icon">üì∏</div>
                            <p class="upload-text">
                                <strong>Click to upload</strong> or <strong>Ctrl+V to paste</strong><br>
                                <small>Upload textbook pages, worksheets, notes</small>
                            </p>
                            <input type="file" id="tutorImageInput" accept="image/*" multiple style="display:none">
                        </div>
                        <div class="image-preview-grid" id="tutorImagePreviewGrid"></div>
                        
                        <div style="text-align:center;margin:15px 0;color:var(--gray);font-size:14px;">‚Äî OR ‚Äî</div>
                        
                        <div class="form-group">
                            <label>Generate from Topic</label>
                            <input type="text" id="tutorQuizTopic" placeholder="e.g., Photosynthesis, World War 2, Algebra">
                        </div>
                        
                        <div class="form-group">
                            <label>Subject</label>
                            <select id="tutorQuizSubject" onchange="toggleTutorOtherSubject()">
                                <option value="Mathematics">Mathematics</option>
                                <option value="Physics">Physics</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Biology">Biology</option>
                                <option value="History">History</option>
                                <option value="Geography">Geography</option>
                                <option value="English">English</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Economics">Economics</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="tutorOtherSubjectGroup" style="display:none;">
                            <label>Specify Subject</label>
                            <input type="text" id="tutorOtherSubject" placeholder="Enter subject name">
                        </div>
                        
                        <div class="form-group">
                            <label>Quiz Title</label>
                            <input type="text" id="tutorQuizTitle" placeholder="e.g., Chapter 5 Quiz">
                        </div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Difficulty</label>
                                <select id="tutorQuizDifficulty">
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Questions</label>
                                <select id="tutorQuizCount">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="15">15</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Assign to Batch</label>
                            <select id="tutorQuizBatch">
                                <option value="">Select Batch (optional)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Deadline (optional)</label>
                            <input type="datetime-local" id="tutorQuizDeadline">
                        </div>
                        
                        <button class="btn btn-success" onclick="generateTutorQuiz()">üöÄ Generate Quiz</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-title" style="margin-bottom:20px;">üìã Preview</div>
                        <div id="tutorQuizPreview">
                            <div class="empty-state">
                                <div class="icon">üìù</div>
                                <h3>Quiz Preview</h3>
                                <p>Generated questions will appear here</p>
                            </div>
                        </div>
                        <div id="tutorQuizActions" style="display:none;margin-top:20px;">
                            <button class="btn btn-success" onclick="saveTutorQuiz()">üíæ Save Quiz</button>
                            <button class="btn btn-secondary" onclick="clearTutorQuiz()" style="margin-top:10px;">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Saved Quizzes Page -->
            <div class="page" id="savedQuizzesPage">
                <div class="page-header">
                    <h1 class="page-title">My Quiz Library</h1>
                    <button class="btn" style="width:auto;padding:10px 20px;" onclick="showTutorPage('createQuiz')">+ Create New</button>
                </div>
                
                <!-- Summary Stats -->
                <div class="grid-4" style="margin-bottom:20px;">
                    <div class="stat-card">
                        <div class="stat-icon blue">üìù</div>
                        <div class="stat-value" id="quizLibraryTotal">0</div>
                        <div class="stat-label">Total Quizzes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">‚úÖ</div>
                        <div class="stat-value" id="quizLibraryAssigned">0</div>
                        <div class="stat-label">Assigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">üìã</div>
                        <div class="stat-value" id="quizLibraryUnassigned">0</div>
                        <div class="stat-label">Unassigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">üîÑ</div>
                        <div class="stat-value" id="quizLibraryReused">0</div>
                        <div class="stat-label">Multi-Batch</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="filter-tabs">
                            <div class="filter-tab active" onclick="filterQuizzes('all', this)">All</div>
                            <div class="filter-tab" onclick="filterQuizzes('assigned', this)">Assigned</div>
                            <div class="filter-tab" onclick="filterQuizzes('unassigned', this)">Unassigned</div>
                        </div>
                        <input type="text" id="quizSearchInput" placeholder="üîç Search quizzes..." oninput="searchQuizzes()" style="padding:8px 15px;border-radius:8px;border:2px solid #e5e7eb;width:200px;">
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Topic</th>
                                    <th>Difficulty</th>
                                    <th>Questions</th>
                                    <th>Assigned To</th>
                                    <th>Times Used</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="savedQuizzesBody">
                                <tr><td colspan="8" style="text-align:center;color:var(--gray);padding:40px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Quiz Usage History -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header">
                        <div class="card-title">üìú Quiz Usage History</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Quiz</th>
                                    <th>Batch</th>
                                    <th>Assigned Date</th>
                                    <th>Deadline</th>
                                    <th>Students Completed</th>
                                    <th>Avg Score</th>
                                </tr>
                            </thead>
                            <tbody id="quizUsageHistoryBody">
                                <tr><td colspan="6" style="text-align:center;color:var(--gray);padding:30px;">No usage history yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Batches Page -->
            <div class="page" id="batchesPage">
                <div class="page-header">
                    <h1 class="page-title">Manage Batches</h1>
                    <button class="btn" style="width:auto;padding:10px 20px;" onclick="showCreateBatchModal()">+ Create Batch</button>
                </div>
                
                <div class="grid-3" id="batchesGrid">
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <h3>No batches yet</h3>
                        <p>Create your first batch to get started</p>
                    </div>
                </div>
            </div>
            
            <!-- Batch Detail Page -->
            <div class="page" id="batchDetailPage">
                <div class="page-header">
                    <button class="btn btn-secondary" style="width:auto;padding:8px 15px;margin-right:15px;" onclick="showTutorPage('batches')">‚Üê Back</button>
                    <h1 class="page-title" id="batchDetailTitle">Batch Details</h1>
                    <button class="btn" style="width:auto;padding:10px 20px;" onclick="showAddStudentModal()">+ Add Student</button>
                </div>
                
                <div class="grid-4" style="margin-bottom:25px;">
                    <div class="stat-card">
                        <div class="stat-icon blue">üéì</div>
                        <div class="stat-value" id="batchStudentCount">0</div>
                        <div class="stat-label">Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">üìù</div>
                        <div class="stat-value" id="batchQuizCount">0</div>
                        <div class="stat-label">Assigned Quizzes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">üìä</div>
                        <div class="stat-value" id="batchAvgScore">0%</div>
                        <div class="stat-label">Avg Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">‚úÖ</div>
                        <div class="stat-value" id="batchCompletion">0%</div>
                        <div class="stat-label">Completion Rate</div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üéì Students in Batch</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Quizzes Done</th>
                                        <th>Avg Score</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="batchStudentsBody">
                                    <tr><td colspan="4" style="text-align:center;color:var(--gray);padding:20px;">No students yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìù Assigned Quizzes</div>
                        </div>
                        <div id="batchAssignedQuizzes">
                            <div class="empty-state" style="padding:20px;">
                                <p>No quizzes assigned</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Students Page -->
            <div class="page" id="studentsPage">
                <div class="page-header">
                    <h1 class="page-title">All Students</h1>
                </div>
                
                <div class="card">
                    <div class="form-group" style="margin-bottom:20px;">
                        <input type="text" id="studentSearch" placeholder="üîç Search by name or email..." oninput="searchStudents()">
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Batch</th>
                                    <th>Quizzes</th>
                                    <th>Avg Score</th>
                                    <th>Points</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr><td colspan="7" style="text-align:center;color:var(--gray);padding:40px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Student Detail Page -->
            <div class="page" id="studentDetailPage">
                <div class="page-header">
                    <button class="btn btn-secondary" style="width:auto;padding:8px 15px;margin-right:15px;" onclick="showTutorPage('students')">‚Üê Back</button>
                    <h1 class="page-title" id="studentDetailTitle">Student Details</h1>
                </div>
                
                <div class="grid-4" style="margin-bottom:25px;">
                    <div class="stat-card">
                        <div class="stat-icon blue">üìù</div>
                        <div class="stat-value" id="studentQuizCount">0</div>
                        <div class="stat-label">Quizzes Taken</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">üìä</div>
                        <div class="stat-value" id="studentAvgScore">0%</div>
                        <div class="stat-label">Avg Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">‚≠ê</div>
                        <div class="stat-value" id="studentPoints">0</div>
                        <div class="stat-label">Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">üî•</div>
                        <div class="stat-value" id="studentStreak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìà Performance Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="studentTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üéØ Topic Performance</div>
                        </div>
                        <div id="studentTopicPerformance">
                            <div class="empty-state" style="padding:20px;">
                                <p>No data yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìö Quiz History</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Topic</th>
                                    <th>Difficulty</th>
                                    <th>Score</th>
                                    <th>Time</th>
                                    <th>Points</th>
                                </tr>
                            </thead>
                            <tbody id="studentQuizHistoryBody">
                                <tr><td colspan="6" style="text-align:center;color:var(--gray);padding:20px;">No quizzes yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Page -->
            <div class="page" id="analyticsPage">
                <div class="page-header">
                    <h1 class="page-title">Analytics Dashboard</h1>
                    <div class="filter-tabs">
                        <select id="analyticsBatchFilter" onchange="loadAnalytics()" style="padding:8px 15px;border-radius:8px;border:2px solid #e5e7eb;">
                            <option value="all">All Batches</option>
                        </select>
                        <select id="analyticsTimeFilter" onchange="loadAnalytics()" style="padding:8px 15px;border-radius:8px;border:2px solid #e5e7eb;">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                </div>
                
                <!-- Quick Weakness Finder (2-3 clicks) -->
                <div class="card" style="margin-bottom:20px;border:2px solid #fbbf24;background:linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);">
                    <div class="card-header">
                        <div class="card-title">üîç Quick Weakness Finder</div>
                        <span style="font-size:12px;color:var(--gray);">Find struggling students in 2-3 clicks</span>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:15px;align-items:flex-end;margin-bottom:15px;">
                        <div>
                            <label style="font-size:12px;color:var(--gray);display:block;margin-bottom:5px;">1. Subject</label>
                            <select id="weaknessSubject" onchange="updateWeaknessBlocks()" style="padding:10px 15px;border-radius:8px;border:2px solid #e5e7eb;min-width:150px;">
                                <option value="">Select Subject</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Physics">Physics</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Biology">Biology</option>
                                <option value="History">History</option>
                                <option value="Geography">Geography</option>
                                <option value="English">English</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Economics">Economics</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:var(--gray);display:block;margin-bottom:5px;">2. Block/Subtopic</label>
                            <select id="weaknessBlock" style="padding:10px 15px;border-radius:8px;border:2px solid #e5e7eb;min-width:180px;">
                                <option value="">All Blocks</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:var(--gray);display:block;margin-bottom:5px;">3. Accuracy Below</label>
                            <select id="weaknessThreshold" style="padding:10px 15px;border-radius:8px;border:2px solid #e5e7eb;">
                                <option value="50">50%</option>
                                <option value="60" selected>60%</option>
                                <option value="70">70%</option>
                            </select>
                        </div>
                        <button class="btn" onclick="findWeakStudents()" style="padding:10px 25px;">üîé Find Students</button>
                    </div>
                    <div id="weakStudentsResults" style="display:none;">
                        <div style="font-weight:600;margin-bottom:10px;color:#92400e;">‚ö†Ô∏è Students Needing Help:</div>
                        <div id="weakStudentsList"></div>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="grid-4" style="margin-bottom:25px;">
                    <div class="stat-card">
                        <div class="stat-icon blue">üìù</div>
                        <div class="stat-value" id="analyticsQuizzesTaken">0</div>
                        <div class="stat-label">Quizzes Taken</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">üìä</div>
                        <div class="stat-value" id="analyticsAvgAccuracy">0%</div>
                        <div class="stat-label">Avg Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">‚è±Ô∏è</div>
                        <div class="stat-value" id="analyticsAvgTime">0m</div>
                        <div class="stat-label">Avg Time/Quiz</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">üéØ</div>
                        <div class="stat-value" id="analyticsActiveStudents">0</div>
                        <div class="stat-label">Active Students</div>
                    </div>
                </div>
                
                <!-- Accuracy by Difficulty (Scholaranium Style) -->
                <div class="grid-2" style="margin-bottom:20px;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üéØ Accuracy by Difficulty</div>
                        </div>
                        <div class="chart-container" style="height:200px;">
                            <canvas id="accuracyByDifficultyChart"></canvas>
                        </div>
                        <div id="difficultyBreakdown" style="margin-top:20px;">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">‚è±Ô∏è Avg Time by Difficulty</div>
                        </div>
                        <div class="chart-container" style="height:200px;">
                            <canvas id="timeByDifficultyChart"></canvas>
                        </div>
                        <div id="timeBreakdown" style="margin-top:20px;">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Score Trend Over Time -->
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header">
                        <div class="card-title">üìà Performance Trend</div>
                    </div>
                    <div class="chart-container" style="height:300px;">
                        <canvas id="performanceTrendChart"></canvas>
                    </div>
                </div>
                
                <div class="grid-2">
                    <!-- Topic/Block Analysis (Scholaranium Style) -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìö Topic-Level Analysis</div>
                        </div>
                        <div id="topicAnalysis" style="max-height:400px;overflow-y:auto;">
                            <!-- Will show progress bars for each topic -->
                        </div>
                    </div>
                    
                    <!-- Students Needing Attention -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">‚ö†Ô∏è Students Needing Attention</div>
                            <span class="card-subtitle">Below 50% accuracy</span>
                        </div>
                        <div id="strugglingStudents" style="max-height:400px;overflow-y:auto;">
                            <div class="empty-state" style="padding:20px;">
                                <p>No data available yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Performers -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header">
                        <div class="card-title">üèÜ Top Performers</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Student</th>
                                    <th>Batch</th>
                                    <th>Quizzes</th>
                                    <th>Accuracy</th>
                                    <th>Avg Time</th>
                                    <th>Points</th>
                                </tr>
                            </thead>
                            <tbody id="topPerformersBody">
                                <tr><td colspan="7" style="text-align:center;color:var(--gray);padding:20px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page" id="settingsPage">
                <div class="page-header">
                    <h1 class="page-title">‚öôÔ∏è Institute Settings</h1>
                </div>

                <!-- White Label Settings -->
                <div class="card">
                    <h3 style="margin-bottom:20px;">üè´ Institute Branding</h3>
                    <p style="color:var(--gray);margin-bottom:20px;">Customize how your institute appears to students</p>
                    
                    <div class="form-group">
                        <label>Institute / Coaching Name</label>
                        <input type="text" id="instituteName" placeholder="e.g., Excel Academy, Bright Future Coaching">
                    </div>
                    
                    <div class="form-group">
                        <label>Tagline (Optional)</label>
                        <input type="text" id="instituteTagline" placeholder="e.g., Excellence in Education, Learn. Grow. Succeed.">
                    </div>
                    
                    <div style="background:#f0f9ff;padding:15px;border-radius:8px;margin:20px 0;">
                        <strong>Preview:</strong>
                        <div id="brandingPreview" style="margin-top:10px;padding:15px;background:var(--dark);border-radius:8px;color:white;">
                            <div id="previewInstituteName" style="font-size:18px;font-weight:600;">üéì FamLearn Pro</div>
                            <div id="previewTagline" style="font-size:12px;color:#9ca3af;">AI-Powered Learning Analytics</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveBrandingSettings()" style="width:100%;">
                        üíæ Save Branding Settings
                    </button>
                </div>

                <!-- Non-Attempt Tracking -->
                <div class="card" style="margin-top:20px;">
                    <h3 style="margin-bottom:20px;">üìã Quiz Attempt Tracking</h3>
                    <p style="color:var(--gray);margin-bottom:20px;">See which students haven't attempted assigned quizzes</p>
                    
                    <div class="form-group">
                        <label>Select Batch</label>
                        <select id="trackingBatchSelect" onchange="loadNonAttemptStudents()">
                            <option value="">Select Batch</option>
                        </select>
                    </div>
                    
                    <div id="nonAttemptList" style="margin-top:15px;">
                        <div style="text-align:center;padding:30px;color:var(--gray);">Select a batch to view tracking</div>
                    </div>
                </div>

                <!-- Student Progress Reports -->
                <div class="card" style="margin-top:20px;">
                    <h3 style="margin-bottom:20px;">üìä Student Progress Reports</h3>
                    <p style="color:var(--gray);margin-bottom:20px;">Generate detailed progress reports for students</p>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div class="form-group">
                            <label>Select Batch</label>
                            <select id="reportBatchSelect" onchange="loadStudentsForReport()">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Select Student</label>
                            <select id="reportStudentSelect">
                                <option value="">Select Student</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Report Period</label>
                        <select id="reportPeriod">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" onclick="generateProgressReport()" style="width:100%;">
                        üìÑ Generate Report
                    </button>
                    
                    <div id="reportPreview" style="margin-top:20px;display:none;"></div>
                </div>
            </div>

            <!-- Pricing Page -->
            <div class="page" id="pricingPage">
                <div class="page-header">
                    <h1 class="page-title">üíé Upgrade Your Plan</h1>
                </div>

                <!-- Current Plan Banner -->
                <div class="card" id="currentPlanBanner" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;margin-bottom:30px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h3 style="color:white;margin-bottom:5px;">Current Plan: <span id="currentTierName">Free Trial</span></h3>
                            <p style="opacity:0.9;margin:0;" id="currentPlanDetails">3 days remaining ‚Ä¢ 2/5 quizzes used</p>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:14px;opacity:0.8;">Daily Limit</div>
                            <div style="font-size:24px;font-weight:bold;" id="dailyLimitDisplay">2/2</div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Cards -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:30px;">

                    <!-- Learner Plan -->
                    <div class="card" style="border:3px solid var(--primary);position:relative;">
                        <div style="position:absolute;top:-15px;right:20px;background:var(--secondary);color:white;padding:5px 15px;border-radius:20px;font-size:12px;font-weight:bold;">
                            POPULAR
                        </div>
                        <h3 style="color:var(--primary);margin-bottom:10px;">üìö Learner</h3>
                        <div style="display:flex;align-items:baseline;margin-bottom:20px;">
                            <span style="font-size:2.5rem;font-weight:bold;color:var(--dark);">‚Çπ149</span>
                            <span style="color:var(--gray);margin-left:8px;">/month</span>
                        </div>
                        <div style="margin-bottom:20px;">
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 3 quizzes per day</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 25 quizzes per month</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Store up to 25 quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 2 lifelines per quiz</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Full analytics access</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Leaderboard access</div>
                            <div style="padding:8px 0;">‚úÖ Answer explanations</div>
                        </div>
                        <button class="btn btn-primary" onclick="initiatePurchase('learner', 149, 'monthly')" style="width:100%;">
                            Upgrade Now
                        </button>
                    </div>

                    <!-- Pro Student Plan -->
                    <div class="card" style="border:2px solid #e5e7eb;">
                        <h3 style="color:var(--success);margin-bottom:10px;">üöÄ Pro Student</h3>
                        <div style="display:flex;align-items:baseline;margin-bottom:20px;">
                            <span style="font-size:2.5rem;font-weight:bold;color:var(--dark);">‚Çπ299</span>
                            <span style="color:var(--gray);margin-left:8px;">/month</span>
                        </div>
                        <div style="margin-bottom:20px;">
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 5 quizzes per day</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ <strong>Unlimited</strong> monthly quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Store up to 50 quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 2 lifelines per quiz</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Full analytics access</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Leaderboard access</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Answer explanations</div>
                            <div style="padding:8px 0;">‚úÖ Priority support</div>
                        </div>
                        <button class="btn btn-success" onclick="initiatePurchase('pro_student', 299, 'monthly')" style="width:100%;">
                            Upgrade Now
                        </button>
                    </div>

                    <!-- Pro Tutor Plan -->
                    <div class="card" id="tutorPlanCard" style="border:2px solid #e5e7eb;display:none;">
                        <h3 style="color:var(--warning);margin-bottom:10px;">üë®‚Äçüè´ Pro Tutor</h3>
                        <div style="margin-bottom:20px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                <div>
                                    <div style="font-size:1.8rem;font-weight:bold;color:var(--dark);">‚Çπ1,499</div>
                                    <div style="color:var(--gray);font-size:14px;">/quarter</div>
                                </div>
                                <div>
                                    <div style="font-size:1.8rem;font-weight:bold;color:var(--dark);">‚Çπ4,999</div>
                                    <div style="color:var(--gray);font-size:14px;">/year</div>
                                    <div style="background:var(--success);color:white;padding:2px 8px;border-radius:4px;font-size:11px;margin-top:4px;">Save 17%</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom:20px;">
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ 5 quizzes per day</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ <strong>Unlimited</strong> monthly quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Store up to 25 quizzes</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Batch management</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Student progress tracking</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Quiz assignments</div>
                            <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;">‚úÖ Full analytics</div>
                            <div style="padding:8px 0;">‚úÖ Priority support</div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <button class="btn btn-warning" onclick="initiatePurchase('pro_tutor', 1499, 'quarterly')" style="width:100%;">
                                Quarterly
                            </button>
                            <button class="btn btn-warning" onclick="initiatePurchase('pro_tutor', 4999, 'yearly')" style="width:100%;">
                                Yearly
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Features Comparison Table -->
                <div class="card">
                    <h3 style="margin-bottom:20px;">üìä Feature Comparison</h3>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:var(--light);">
                                    <th style="padding:12px;text-align:left;">Feature</th>
                                    <th style="padding:12px;text-align:center;">Free Trial</th>
                                    <th style="padding:12px;text-align:center;">Learner</th>
                                    <th style="padding:12px;text-align:center;">Pro Student</th>
                                    <th style="padding:12px;text-align:center;">Pro Tutor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Daily Quiz Limit</td>
                                    <td style="padding:12px;text-align:center;">2</td>
                                    <td style="padding:12px;text-align:center;">3</td>
                                    <td style="padding:12px;text-align:center;">5</td>
                                    <td style="padding:12px;text-align:center;">5</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Monthly Quiz Limit</td>
                                    <td style="padding:12px;text-align:center;">5</td>
                                    <td style="padding:12px;text-align:center;">25</td>
                                    <td style="padding:12px;text-align:center;">Unlimited</td>
                                    <td style="padding:12px;text-align:center;">Unlimited</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Quiz Library</td>
                                    <td style="padding:12px;text-align:center;">5</td>
                                    <td style="padding:12px;text-align:center;">25</td>
                                    <td style="padding:12px;text-align:center;">50</td>
                                    <td style="padding:12px;text-align:center;">25</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">50/50 Lifelines</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ 2/quiz</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ 2/quiz</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ 2/quiz</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Analytics</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Leaderboard</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Answer Explanations</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <td style="padding:12px;">Batch Management</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                                <tr>
                                    <td style="padding:12px;">Priority Support</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚ùå</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                    <td style="padding:12px;text-align:center;">‚úÖ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- FAQ Section -->
                <div class="card">
                    <h3 style="margin-bottom:20px;">‚ùì Frequently Asked Questions</h3>
                    <div style="space-y:15px;">
                        <div style="margin-bottom:15px;">
                            <h4 style="color:var(--primary);margin-bottom:5px;">What happens when my trial ends?</h4>
                            <p style="color:var(--gray);margin:0;">Your account remains active, but you'll have limited access. Students can access their last 3 quizzes, while tutors will need to upgrade to continue creating quizzes.</p>
                        </div>
                        <div style="margin-bottom:15px;">
                            <h4 style="color:var(--primary);margin-bottom:5px;">Can I cancel anytime?</h4>
                            <p style="color:var(--gray);margin:0;">Yes! You can cancel your subscription anytime. You'll retain access until the end of your billing period.</p>
                        </div>
                        <div style="margin-bottom:15px;">
                            <h4 style="color:var(--primary);margin-bottom:5px;">What payment methods do you accept?</h4>
                            <p style="color:var(--gray);margin:0;">We accept UPI, Credit/Debit Cards, Net Banking, and Wallets through Razorpay's secure payment gateway.</p>
                        </div>
                        <div>
                            <h4 style="color:var(--primary);margin-bottom:5px;">Do you offer refunds?</h4>
                            <p style="color:var(--gray);margin:0;">Yes, we offer a 7-day money-back guarantee if you're not satisfied with your subscription.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Batch Modal -->
    <div class="modal" id="createBatchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Batch</h3>
                <button class="close-modal" onclick="closeModal('createBatchModal')">&times;</button>
            </div>
            <form onsubmit="createBatch(event)">
                <div class="form-group">
                    <label>Batch Name</label>
                    <input type="text" id="batchName" required placeholder="e.g., Grade 10 Science">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="batchDescription" placeholder="Optional description">
                </div>
                <button type="submit" class="btn">Create Batch</button>
            </form>
        </div>
    </div>
    
    <!-- Add Student Modal -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Student to Batch</h3>
                <button class="close-modal" onclick="closeModal('addStudentModal')">&times;</button>
            </div>
            <form onsubmit="addStudentToBatch(event)">
                <div class="form-group">
                    <label>Student Email</label>
                    <input type="email" id="addStudentEmail" required placeholder="student@example.com">
                    <small style="color:var(--gray);font-size:12px;">Student must already be registered</small>
                </div>
                <button type="submit" class="btn">Add Student</button>
            </form>
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb;">
                <p style="font-size:13px;color:var(--gray);margin-bottom:10px;">Or add multiple students:</p>
                <textarea id="bulkStudentEmails" rows="4" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;" placeholder="Enter emails, one per line"></textarea>
                <button type="button" class="btn btn-secondary" style="margin-top:10px;" onclick="bulkAddStudents()">Add All</button>
            </div>
        </div>
    </div>
    
    <!-- Assign Quiz Modal -->
    <div class="modal" id="assignQuizModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Assign Quiz to Batch</h3>
                <button class="close-modal" onclick="closeModal('assignQuizModal')">&times;</button>
            </div>
            <form onsubmit="assignQuizToBatch(event)">
                <input type="hidden" id="assignQuizId">
                <div class="form-group">
                    <label>Select Batch</label>
                    <select id="assignBatchSelect" required>
                        <option value="">Select a batch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="datetime-local" id="assignDueDate" required>
                </div>
                <div class="form-group">
                    <label>Instructions (optional)</label>
                    <textarea id="assignInstructions" rows="3" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;" placeholder="Add any instructions for students..."></textarea>
                </div>
                <div style="display:flex;gap:10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assignQuizModal')" style="flex:1;">Cancel</button>
                    <button type="submit" class="btn" style="flex:1;">Assign Quiz</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quiz Leaderboard Modal -->
    <div class="modal" id="quizLeaderboardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="quizLeaderboardTitle">Quiz Leaderboard</h3>
                <button class="close-modal" onclick="closeModal('quizLeaderboardModal')">&times;</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Student</th>
                            <th>Score</th>
                            <th>Time</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="quizLeaderboardBody">
                        <tr><td colspan="5" style="text-align:center;padding:20px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Completion Details Modal -->
    <div class="modal" id="completionDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="completionDetailsTitle">Quiz Completion Status</h3>
                <button class="close-modal" onclick="closeModal('completionDetailsModal')">&times;</button>
            </div>
            <div id="completionDetailsContent">
                <div style="margin-bottom:20px;">
                    <h4 style="color:var(--success);margin-bottom:10px;">‚úÖ Completed (<span id="completedCount">0</span> students)</h4>
                    <div id="completedList" style="background:#f0fdf4;padding:15px;border-radius:8px;"></div>
                </div>
                <div>
                    <h4 style="color:var(--danger);margin-bottom:10px;">‚ùå Not Completed (<span id="notCompletedCount">0</span> students)</h4>
                    <div id="notCompletedList" style="background:#fef2f2;padding:15px;border-radius:8px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Quiz Modal -->
    <div class="modal" id="viewQuizModal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="viewQuizTitle">Quiz Details</h3>
                <button class="close-modal" onclick="closeModal('viewQuizModal')">&times;</button>
            </div>
            <div id="viewQuizContent">
                <!-- Quiz questions will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div class="modal" id="upgradeModal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h3 class="modal-title">üíé Upgrade Required</h3>
                <button class="close-modal" onclick="closeModal('upgradeModal')">&times;</button>
            </div>
            <div style="text-align:center;padding:20px;">
                <div style="font-size:4rem;margin-bottom:15px;">üöÄ</div>
                <p id="upgradeModalMessage" style="font-size:16px;color:var(--dark);margin-bottom:25px;">
                    You've reached your limit. Upgrade to continue!
                </p>
                <button class="btn btn-primary" onclick="closeModal('upgradeModal'); showPage('pricing', event);" style="width:100%;margin-bottom:10px;">
                    View Pricing Plans
                </button>
                <button class="btn btn-secondary" onclick="closeModal('upgradeModal')" style="width:100%;">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        // API keys are stored in localStorage for security
        // Set them once in browser console: localStorage.setItem('SUPABASE_URL', 'your-url')
        const SUPABASE_URL = localStorage.getItem('SUPABASE_URL') || 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = localStorage.getItem('SUPABASE_KEY') || 'YOUR_SUPABASE_ANON_KEY';
        const GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY') || 'YOUR_GROQ_API_KEY';
        const BREVO_API_KEY = localStorage.getItem('BREVO_API_KEY') || 'YOUR_BREVO_API_KEY';
        const BREVO_SENDER_EMAIL = localStorage.getItem('BREVO_SENDER_EMAIL') || 'noreply@famlearn.com';
        const BREVO_SENDER_NAME = localStorage.getItem('BREVO_SENDER_NAME') || 'FamLearn Pro';
        const MAX_IMAGES_PER_QUIZ = 5;
        const MAX_IMAGE_SIZE_MB = 5;
        const IMAGE_COMPRESSION_QUALITY = 0.7;
        const IMAGE_MAX_DIMENSION = 1200;

        // ========================================
        // üß™ TESTING MODE CONFIGURATION
        // ========================================
        // Set to TRUE to unlock all features for testing without payment
        // Set to FALSE to re-enable payment/subscription checks for production
        const TESTING_MODE = true;

        // When TESTING_MODE is true:
        // ‚úÖ All premium features unlocked (analytics, leaderboard, lifelines, explanations)
        // ‚úÖ Unlimited quiz creation (no daily/monthly limits)
        // ‚úÖ No subscription expiry checks
        // ‚úÖ Upgrade modals disabled
        // ‚úÖ Payment flows show "Testing Mode" message instead of processing
        // ‚ö†Ô∏è Set to FALSE before deploying to production!

        // ========================================
        // SUBJECT BLOCKS DEFINITION
        // ========================================
        const SUBJECT_BLOCKS = {
            'Mathematics': ['Algebra & Equations', 'Geometry & Mensuration', 'Arithmetic & Numbers', 'Statistics & Probability'],
            'Physics': ['Mechanics & Motion', 'Electricity & Magnetism', 'Waves & Optics', 'Thermodynamics & Modern Physics'],
            'Chemistry': ['Physical Chemistry', 'Organic Chemistry', 'Inorganic Chemistry', 'Environmental Chemistry'],
            'Biology': ['Cell Biology & Genetics', 'Human Physiology', 'Plant Biology & Ecology', 'Evolution & Biotechnology'],
            'History': ['Ancient History', 'Medieval History', 'Modern History', 'World Wars & Contemporary'],
            'Geography': ['Physical Geography', 'Human Geography', 'Indian Geography', 'World Geography & Maps'],
            'English': ['Grammar & Vocabulary', 'Reading Comprehension', 'Writing & Essays', 'Literature & Poetry'],
            'Computer Science': ['Programming Basics', 'Data Structures & Algorithms', 'Databases & Networking', 'Web & Software Development'],
            'Economics': ['Microeconomics', 'Macroeconomics', 'Indian Economy', 'International Trade & Finance']
        };
        
        function getBlocksForSubject(subject) {
            return SUBJECT_BLOCKS[subject] || ['General'];
        }

        // ========================================
        // SUBSCRIPTION TIER CONFIGURATION
        // ========================================
        const SUBSCRIPTION_TIERS = {
            free: {
                name: 'Free Trial',
                price: 0,
                trialDays: 3,
                dailyQuizLimit: 2,
                monthlyQuizLimit: 5,
                libraryLimit: 5,
                features: {
                    lifelines: 2,
                    analytics: false,
                    leaderboard: false,
                    explanations: false,
                    prioritySupport: false
                }
            },
            learner: {
                name: 'Learner',
                price: 149,
                period: 'month',
                dailyQuizLimit: 3,
                monthlyQuizLimit: 25,
                libraryLimit: 25,
                features: {
                    lifelines: 2,
                    analytics: true,
                    leaderboard: true,
                    explanations: true,
                    prioritySupport: false
                }
            },
            pro_student: {
                name: 'Pro Student',
                price: 299,
                period: 'month',
                dailyQuizLimit: 5,
                monthlyQuizLimit: 999999,
                libraryLimit: 50,
                features: {
                    lifelines: 2,
                    analytics: true,
                    leaderboard: true,
                    explanations: true,
                    prioritySupport: true
                }
            },
            pro_tutor: {
                name: 'Pro Tutor',
                priceQuarterly: 1499,
                priceYearly: 4999,
                dailyQuizLimit: 5,
                monthlyQuizLimit: 999999,
                libraryLimit: 25,
                features: {
                    lifelines: 2,
                    analytics: true,
                    leaderboard: true,
                    explanations: true,
                    batchManagement: true,
                    prioritySupport: true
                }
            }
        };

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let quizScore = 0;
        let uploadedImages = [];
        let uploadedImageUrls = []; // Supabase Storage URLs
        let tutorUploadedImages = [];
        let quizTimer = null;
        let quizTimeRemaining = 720; // 12 minutes in seconds
        let quizStartTime = null;
        let questionTimes = [];
        let charts = {};

        // Lifeline tracking
        let lifelinesUsed = 0;
        let lifelinesAvailable = 2;
        let currentQuizId = null;

        // OTP verification variables
        let pendingRegistration = null;
        let otpTimer = null;
        let otpExpiryTime = null;
        
        // Quiz state for resume functionality
        const QUIZ_STATE_KEY = 'famlearn_quiz_state';
        const IMAGE_STATE_KEY = 'famlearn_image_state';
        const TUTOR_IMAGE_STATE_KEY = 'famlearn_tutor_image_state';

        // ========================================
        // SUBSCRIPTION UTILITY FUNCTIONS
        // ========================================

        // Check if user's trial or subscription has expired
        function isSubscriptionExpired() {
            if (!currentUser) return true;

            // üß™ TESTING MODE: Never expired
            if (TESTING_MODE) {
                return false;
            }

            const now = new Date();

            // Check trial expiry
            if (currentUser.subscription_tier === 'free' && currentUser.trial_end_date) {
                const trialEnd = new Date(currentUser.trial_end_date);
                if (now > trialEnd) return true;
            }

            // Check subscription expiry
            if (currentUser.subscription_end_date) {
                const subEnd = new Date(currentUser.subscription_end_date);
                if (now > subEnd) return true;
            }

            return false;
        }

        // Check if user is in grace period (students only)
        function isInGracePeriod() {
            if (!currentUser || currentUser.role !== 'student') return false;
            if (!currentUser.grace_period_end_date) return false;

            const now = new Date();
            const graceEnd = new Date(currentUser.grace_period_end_date);
            return now <= graceEnd;
        }

        // Get user's current tier configuration
        function getUserTierConfig() {
            const tier = currentUser?.subscription_tier || 'free';
            return SUBSCRIPTION_TIERS[tier] || SUBSCRIPTION_TIERS.free;
        }

        // Initialize/fix subscription fields for existing users
        async function ensureSubscriptionFields(user) {
            if (!user) return user;

            // Check if subscription fields need initialization
            const needsInit = user.subscription_tier === undefined ||
                            user.subscription_tier === null ||
                            user.trial_end_date === undefined ||
                            user.trial_end_date === null;

            if (needsInit) {
                console.log('‚ö†Ô∏è User missing subscription fields, initializing...');

                // Set default values
                const now = new Date();
                const trialEnd = new Date(user.created_at || now);
                trialEnd.setDate(trialEnd.getDate() + 3); // 3 day trial

                const updates = {
                    subscription_tier: 'free',
                    subscription_status: trialEnd > now ? 'trial' : 'expired',
                    trial_start_date: user.created_at || now.toISOString(),
                    trial_end_date: trialEnd.toISOString(),
                    quizzes_created_today: 0,
                    quizzes_created_this_month: 0,
                    quiz_library_count: 0,
                    last_quiz_creation_date: null,
                    monthly_reset_date: now.toISOString()
                };

                console.log('üìù Applying updates:', updates);

                // Update database
                const { data, error } = await supabaseClient
                    .from('users')
                    .update(updates)
                    .eq('id', user.id)
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Failed to initialize subscription fields:', error);
                    // Apply to local object even if DB update fails
                    Object.assign(user, updates);
                } else {
                    console.log('‚úÖ Subscription fields initialized');
                    return data;
                }
            }

            // Ensure numeric fields have default values
            user.quizzes_created_today = user.quizzes_created_today ?? 0;
            user.quizzes_created_this_month = user.quizzes_created_this_month ?? 0;
            user.quiz_library_count = user.quiz_library_count ?? 0;

            return user;
        }

        // Check if user can create a quiz (daily + monthly limits)
        function canCreateQuiz() {
            if (!currentUser) return false;

            // üß™ TESTING MODE: Bypass all limits
            if (TESTING_MODE) {
                return { canCreate: true, testingMode: true };
            }

            const tierConfig = getUserTierConfig();
            const today = new Date().toDateString();
            const lastCreationDate = currentUser.last_quiz_creation_date ? new Date(currentUser.last_quiz_creation_date).toDateString() : null;

            // Reset daily count if it's a new day
            let dailyCount = currentUser.quizzes_created_today || 0;
            if (lastCreationDate !== today) {
                dailyCount = 0;
            }

            const monthlyCount = currentUser.quizzes_created_this_month || 0;

            // Check daily limit
            if (dailyCount >= tierConfig.dailyQuizLimit) {
                return { canCreate: false, reason: 'daily_limit', limit: tierConfig.dailyQuizLimit };
            }

            // Check monthly limit
            if (monthlyCount >= tierConfig.monthlyQuizLimit) {
                return { canCreate: false, reason: 'monthly_limit', limit: tierConfig.monthlyQuizLimit };
            }

            // Check library limit
            const libraryCount = currentUser.quiz_library_count || 0;
            if (libraryCount >= tierConfig.libraryLimit) {
                return { canCreate: false, reason: 'library_limit', limit: tierConfig.libraryLimit };
            }

            return { canCreate: true };
        }

        // Check if feature is available for user's tier
        function hasFeatureAccess(featureName) {
            if (!currentUser) return false;

            // üß™ TESTING MODE: Grant access to all features
            if (TESTING_MODE) {
                return true;
            }

            const tierConfig = getUserTierConfig();
            return tierConfig.features[featureName] === true;
        }

        // Get days remaining in trial/subscription
        function getDaysRemaining() {
            if (!currentUser) return 0;

            const now = new Date();
            let endDate;

            if (currentUser.subscription_tier === 'free' && currentUser.trial_end_date) {
                endDate = new Date(currentUser.trial_end_date);
            } else if (currentUser.subscription_end_date) {
                endDate = new Date(currentUser.subscription_end_date);
            } else {
                return 0;
            }

            const diffTime = endDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }

        // Update sidebar user info with subscription details
        function updateSidebarUserInfo() {
            if (!currentUser) return;

            // Update name and avatar
            const nameEl = document.getElementById('sidebarUserName');
            const avatarEl = document.getElementById('userAvatar');
            const tierNameEl = document.getElementById('sidebarTierName');
            const daysLeftEl = document.getElementById('sidebarDaysLeft');
            const quizCountEl = document.getElementById('sidebarQuizCount');
            const upgradeBtn = document.getElementById('sidebarUpgradeBtn');

            if (nameEl) nameEl.textContent = currentUser.name;
            if (avatarEl) avatarEl.textContent = currentUser.name.charAt(0).toUpperCase();

            // Get tier config
            const tierConfig = getUserTierConfig();
            const tier = currentUser.subscription_tier || 'free';

            // Update tier name with emoji
            if (tierNameEl) {
                const tierEmojis = {
                    'free': 'üé´',
                    'learner': 'üìö',
                    'pro_student': '‚≠ê',
                    'pro_tutor': 'üë®‚Äçüè´'
                };
                tierNameEl.textContent = `${tierEmojis[tier] || 'üé´'} ${tierConfig.name}`;
            }

            // Update days remaining
            if (daysLeftEl) {
                const daysLeft = getDaysRemaining();
                if (daysLeft === 0) {
                    daysLeftEl.textContent = 'Expired';
                    daysLeftEl.style.color = '#ef4444'; // Red
                } else if (daysLeft <= 3) {
                    daysLeftEl.textContent = `${daysLeft} day${daysLeft === 1 ? '' : 's'}`;
                    daysLeftEl.style.color = '#f59e0b'; // Orange warning
                } else {
                    daysLeftEl.textContent = `${daysLeft} days`;
                    daysLeftEl.style.color = '#10b981'; // Green
                }
            }

            // Update quiz count
            if (quizCountEl) {
                const today = currentUser.quizzes_created_today || 0;
                const limit = tierConfig.dailyQuizLimit;
                quizCountEl.textContent = `${today}/${limit}`;

                // Color based on usage
                if (today >= limit) {
                    quizCountEl.style.color = '#ef4444'; // Red - limit reached
                } else if (today >= limit - 1) {
                    quizCountEl.style.color = '#f59e0b'; // Orange - almost at limit
                } else {
                    quizCountEl.style.color = '#10b981'; // Green
                }
            }

            // Show upgrade button for free and learner tiers only
            if (upgradeBtn) {
                if (tier === 'free' || tier === 'learner') {
                    upgradeBtn.style.display = 'block';
                } else {
                    upgradeBtn.style.display = 'none';
                }
            }

            // Update popup data as well
            updateUserProfilePopup();
        }

        // Toggle user profile popup
        function toggleUserProfilePopup() {
            const popup = document.getElementById('userProfilePopup');
            if (!popup) return;

            if (popup.style.display === 'none') {
                updateUserProfilePopup();
                popup.style.display = 'block';
            } else {
                popup.style.display = 'none';
            }
        }

        // Update user profile popup with current user data
        function updateUserProfilePopup() {
            if (!currentUser) return;

            const tierConfig = getUserTierConfig();
            const tier = currentUser.subscription_tier || 'free';

            // Update popup avatar
            const popupAvatar = document.getElementById('popupAvatar');
            if (popupAvatar) {
                popupAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            }

            // Update popup name
            const popupFullName = document.getElementById('popupFullName');
            if (popupFullName) {
                popupFullName.textContent = currentUser.name;
            }

            // Update popup email
            const popupEmail = document.getElementById('popupEmail');
            if (popupEmail) {
                popupEmail.textContent = `üìß ${currentUser.email}`;
            }

            // Update popup phone
            const popupPhone = document.getElementById('popupPhone');
            if (popupPhone) {
                if (currentUser.phone) {
                    popupPhone.textContent = `üì± ${currentUser.phone}`;
                    popupPhone.style.display = 'block';
                } else {
                    popupPhone.style.display = 'none';
                }
            }

            // Update popup tier
            const popupTier = document.getElementById('popupTier');
            if (popupTier) {
                const tierEmojis = {
                    'free': 'üé´',
                    'learner': 'üìö',
                    'pro_student': '‚≠ê',
                    'pro_tutor': 'üë®‚Äçüè´'
                };
                popupTier.textContent = `${tierEmojis[tier] || 'üé´'} ${tierConfig.name}`;
            }

            // Update popup expiry
            const popupExpiry = document.getElementById('popupExpiry');
            if (popupExpiry) {
                let endDate;
                if (tier === 'free' && currentUser.trial_end_date) {
                    endDate = new Date(currentUser.trial_end_date);
                } else if (currentUser.subscription_end_date) {
                    endDate = new Date(currentUser.subscription_end_date);
                }

                if (endDate) {
                    const options = { year: 'numeric', month: 'short', day: 'numeric' };
                    popupExpiry.textContent = endDate.toLocaleDateString('en-US', options);

                    // Color based on expiry
                    const daysLeft = getDaysRemaining();
                    if (daysLeft === 0) {
                        popupExpiry.style.color = '#ef4444'; // Red
                    } else if (daysLeft <= 3) {
                        popupExpiry.style.color = '#f59e0b'; // Orange
                    } else {
                        popupExpiry.style.color = '#10b981'; // Green
                    }
                } else {
                    popupExpiry.textContent = 'N/A';
                    popupExpiry.style.color = '#9ca3af';
                }
            }

            // Update popup quiz count
            const popupQuizCount = document.getElementById('popupQuizCount');
            if (popupQuizCount) {
                const monthlyCount = currentUser.quizzes_created_this_month || 0;
                const monthlyLimit = tierConfig.monthlyQuizLimit;
                popupQuizCount.textContent = `${monthlyCount}/${monthlyLimit === 999999 ? '‚àû' : monthlyLimit}`;

                // Color based on usage
                if (monthlyLimit !== 999999 && monthlyCount >= monthlyLimit) {
                    popupQuizCount.style.color = '#ef4444'; // Red
                } else if (monthlyLimit !== 999999 && monthlyCount >= monthlyLimit * 0.8) {
                    popupQuizCount.style.color = '#f59e0b'; // Orange
                } else {
                    popupQuizCount.style.color = '#10b981'; // Green
                }
            }
        }

        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            const popup = document.getElementById('userProfilePopup');
            const sidebar = document.querySelector('.user-info-sidebar');

            if (popup && sidebar && popup.style.display === 'block') {
                if (!sidebar.contains(event.target)) {
                    popup.style.display = 'none';
                }
            }
        });

        // Increment quiz creation counters
        async function incrementQuizCounters() {
            if (!currentUser) {
                console.warn('‚ö†Ô∏è incrementQuizCounters: No current user');
                return;
            }

            try {
                const today = new Date().toDateString();
                const lastCreationDate = currentUser.last_quiz_creation_date ? new Date(currentUser.last_quiz_creation_date).toDateString() : null;

                let dailyCount = currentUser.quizzes_created_today || 0;
                let monthlyCount = currentUser.quizzes_created_this_month || 0;

                // Reset daily count if it's a new day
                if (lastCreationDate !== today) {
                    dailyCount = 0;
                }

                dailyCount++;
                monthlyCount++;

                console.log('üìä Updating quiz counters:', { dailyCount, monthlyCount });

                const { error } = await supabaseClient
                    .from('users')
                    .update({
                        quizzes_created_today: dailyCount,
                        quizzes_created_this_month: monthlyCount,
                        last_quiz_creation_date: new Date().toISOString(),
                        quiz_library_count: (currentUser.quiz_library_count || 0) + 1
                    })
                    .eq('id', currentUser.id);

                if (error) {
                    console.error('‚ùå Failed to update quiz counters in database:', error);
                    throw error; // Re-throw to be caught by caller
                } else {
                    currentUser.quizzes_created_today = dailyCount;
                    currentUser.quizzes_created_this_month = monthlyCount;
                    currentUser.last_quiz_creation_date = new Date().toISOString();
                    currentUser.quiz_library_count = (currentUser.quiz_library_count || 0) + 1;
                    console.log('‚úÖ Quiz counters updated successfully');

                    // Update sidebar to reflect new counter values
                    updateSidebarUserInfo();
                }
            } catch (error) {
                console.error('‚ùå Exception in incrementQuizCounters:', error);
                throw error; // Re-throw to be caught by caller
            }
        }

        // Show upgrade modal
        function showUpgradeModal(reason = 'limit_reached') {
            // üß™ TESTING MODE: Don't show upgrade modal
            if (TESTING_MODE) {
                console.log('üß™ Testing Mode: Upgrade modal bypassed');
                return;
            }

            const modal = document.getElementById('upgradeModal');
            if (!modal) return;

            const tierConfig = getUserTierConfig();
            let message = '';

            switch(reason) {
                case 'daily_limit':
                    message = `You've reached your daily limit of ${tierConfig.dailyQuizLimit} quizzes. Upgrade to create more!`;
                    break;
                case 'monthly_limit':
                    message = `You've reached your monthly limit of ${tierConfig.monthlyQuizLimit} quizzes. Upgrade for unlimited access!`;
                    break;
                case 'library_limit':
                    message = `Your quiz library is full (${tierConfig.libraryLimit} quizzes). Upgrade to store more!`;
                    break;
                case 'expired':
                    message = `Your ${currentUser.subscription_tier === 'free' ? 'trial' : 'subscription'} has expired. Upgrade to continue!`;
                    break;
                case 'feature_locked':
                    message = `This feature is only available on paid plans. Upgrade now!`;
                    break;
                default:
                    message = `Upgrade your plan to unlock more features!`;
            }

            document.getElementById('upgradeModalMessage').textContent = message;
            modal.style.display = 'flex';
        }

        // ========================================
        // PRICING & PAYMENT FUNCTIONS
        // ========================================

        function loadPricingPageData() {
            // Update current plan banner
            const tierConfig = getUserTierConfig();
            document.getElementById('currentTierName').textContent = tierConfig.name;

            const daysLeft = getDaysRemaining();
            const dailyUsed = currentUser.quizzes_created_today || 0;
            const monthlyUsed = currentUser.quizzes_created_this_month || 0;

            document.getElementById('currentPlanDetails').textContent =
                `${daysLeft} days remaining ‚Ä¢ ${monthlyUsed}/${tierConfig.monthlyQuizLimit} quizzes used`;

            document.getElementById('dailyLimitDisplay').textContent =
                `${dailyUsed}/${tierConfig.dailyQuizLimit}`;

            // Show/hide tutor plan based on role
            if (currentUser.role === 'tutor') {
                document.getElementById('tutorPlanCard').style.display = 'block';
            }
        }

        async function initiatePurchase(tier, amount, period) {
            console.log('========================================');
            console.log('üí≥ INITIATING PAYMENT FLOW');
            console.log('========================================');
            console.log('Tier:', tier);
            console.log('Amount:', amount);
            console.log('Period:', period);

            // üß™ TESTING MODE: Show message instead of processing payment
            if (TESTING_MODE) {
                console.log('üß™ Testing Mode: Payment bypassed');
                showToast('üß™ Testing Mode Active - All features are unlocked for free!', 'info');
                console.log('üí° To enable payments, set TESTING_MODE = false in the code (line 2423)');
                return;
            }

            // Check if Razorpay script is loaded
            if (typeof Razorpay === 'undefined') {
                console.error('‚ùå Razorpay script not loaded!');
                showToast('Payment system not loaded. Please refresh the page.', 'error');
                return;
            }
            console.log('‚úÖ Razorpay script loaded');

            // Check if Razorpay is configured
            const razorpayKeyId = localStorage.getItem('RAZORPAY_KEY_ID');
            console.log('Razorpay Key ID:', razorpayKeyId ? `${razorpayKeyId.substring(0, 12)}...` : 'NOT SET');

            if (!razorpayKeyId || razorpayKeyId === 'YOUR_RAZORPAY_KEY_ID') {
                console.error('‚ùå Razorpay API key not configured');
                showToast('Payment system not configured. Please set RAZORPAY_KEY_ID in localStorage.', 'error');
                console.log('üí° To configure: localStorage.setItem("RAZORPAY_KEY_ID", "rzp_test_XXXX")');
                return;
            }
            console.log('‚úÖ Razorpay key configured');

            // Check if user is logged in
            if (!currentUser || !currentUser.id) {
                console.error('‚ùå User not logged in');
                showToast('Please login to make a purchase', 'error');
                return;
            }
            console.log('‚úÖ User logged in:', currentUser.email);

            // Create order record in database first
            const periodMonths = period === 'yearly' ? 12 : period === 'quarterly' ? 3 : 1;
            const subscriptionEndDate = new Date();
            subscriptionEndDate.setMonth(subscriptionEndDate.getMonth() + periodMonths);

            console.log('üìù Creating transaction record...');
            const orderData = {
                user_id: currentUser.id,
                tier: tier,
                amount: amount,
                currency: 'INR',
                payment_status: 'pending',
                subscription_period_start: new Date().toISOString(),
                subscription_period_end: subscriptionEndDate.toISOString()
            };
            console.log('Order data:', orderData);

            try {
                const { data: transaction, error } = await supabaseClient
                    .from('subscription_transactions')
                    .insert([orderData])
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Database error:', error);
                    throw error;
                }

                console.log('‚úÖ Transaction record created:', transaction.id);

                // Initialize Razorpay checkout
                console.log('üöÄ Opening Razorpay checkout...');
                const options = {
                    key: razorpayKeyId,
                    amount: amount * 100, // Convert to paise
                    currency: 'INR',
                    name: 'FamLearn Pro',
                    description: `${SUBSCRIPTION_TIERS[tier].name} - ${period}`,
                    image: 'https://your-logo-url.com/logo.png',
                    handler: async function(response) {
                        console.log('‚úÖ Payment successful:', response);
                        await handlePaymentSuccess(transaction.id, response, tier, subscriptionEndDate);
                    },
                    prefill: {
                        name: currentUser.name,
                        email: currentUser.email,
                        contact: currentUser.phone || ''
                    },
                    theme: {
                        color: '#4f46e5'
                    },
                    modal: {
                        ondismiss: function() {
                            console.log('‚ö†Ô∏è Payment modal dismissed');
                            showToast('Payment cancelled', 'info');
                        }
                    }
                };

                console.log('Razorpay options:', {
                    ...options,
                    key: razorpayKeyId.substring(0, 12) + '...'
                });

                const rzp = new Razorpay(options);

                rzp.on('payment.failed', function(response) {
                    console.error('‚ùå Payment failed:', response.error);
                    showToast('Payment Failed: ' + response.error.description, 'error');
                });

                console.log('üì± Opening Razorpay popup...');
                rzp.open();
                console.log('‚úÖ Razorpay popup opened');

            } catch (error) {
                console.error('‚ùå Error in payment flow:', error);
                console.error('Error details:', error.message, error.stack);
                showToast('Failed to initiate payment: ' + error.message, 'error');
            }
            console.log('========================================');
        }

        async function handlePaymentSuccess(transactionId, paymentResponse, tier, endDate) {
            showLoading('Processing payment...');

            try {
                // Update transaction record
                await supabaseClient
                    .from('subscription_transactions')
                    .update({
                        payment_status: 'completed',
                        razorpay_payment_id: paymentResponse.razorpay_payment_id,
                        razorpay_order_id: paymentResponse.razorpay_order_id,
                        razorpay_signature: paymentResponse.razorpay_signature
                    })
                    .eq('id', transactionId);

                // Update user subscription
                await supabaseClient
                    .from('users')
                    .update({
                        subscription_tier: tier,
                        subscription_status: 'active',
                        subscription_start_date: new Date().toISOString(),
                        subscription_end_date: endDate.toISOString(),
                        quizzes_created_today: 0,
                        quizzes_created_this_month: 0
                    })
                    .eq('id', currentUser.id);

                // Update local user object
                currentUser.subscription_tier = tier;
                currentUser.subscription_status = 'active';
                currentUser.subscription_end_date = endDate.toISOString();

                hideLoading();
                showToast('üéâ Payment successful! Your account has been upgraded!', 'success');

                // Refresh the page to show new features
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                hideLoading();
                console.error('Error updating subscription:', error);
                showToast('Payment received but subscription update failed. Please contact support.', 'error');
            }
        }

        // Toggle parent fields based on role selection
        function toggleParentFields() {
            const role = document.getElementById('regRole').value;
            const parentFields = document.getElementById('parentFieldsGroup');
            if (role === 'student') {
                parentFields.style.display = 'block';
            } else {
                parentFields.style.display = 'none';
            }
        }

        // Save uploaded images state (before quiz generation)
        function saveImageState() {
            if (!uploadedImages || uploadedImages.length === 0) return;
            
            // uploadedImages already contains base64 strings from compression
            const state = {
                images: uploadedImages.map((img, i) => ({
                    data: img,
                    name: `image_${i}.jpg`
                })),
                metadata: {
                    subject: document.getElementById('quizSubject')?.value,
                    chapter: document.getElementById('quizChapter')?.value,
                    difficulty: document.getElementById('quizDifficulty')?.value,
                    count: document.getElementById('quizCount')?.value
                },
                userId: currentUser?.id,
                savedAt: Date.now()
            };
            
            try {
                localStorage.setItem(IMAGE_STATE_KEY, JSON.stringify(state));
                console.log('üì∑ Image state saved');
            } catch (e) {
                console.warn('Could not save image state (storage full?):', e);
            }
        }
        
        function loadImageState() {
            try {
                const saved = localStorage.getItem(IMAGE_STATE_KEY);
                if (!saved) return null;
                
                const state = JSON.parse(saved);
                
                // Check if state is for current user and not too old (24 hours)
                if (state.userId !== currentUser?.id) return null;
                if (Date.now() - state.savedAt > 86400000) {
                    clearImageState();
                    return null;
                }
                
                return state;
            } catch (e) {
                console.error('Error loading image state:', e);
                return null;
            }
        }
        
        function clearImageState() {
            localStorage.removeItem(IMAGE_STATE_KEY);
            console.log('üóëÔ∏è Image state cleared');
        }
        
        function checkForSavedImages() {
            const state = loadImageState();
            if (state && state.images && state.images.length > 0) {
                const hoursAgo = Math.round((Date.now() - state.savedAt) / 3600000);
                if (confirm(`You have ${state.images.length} uploaded images from ${hoursAgo} hour(s) ago. Restore them?`)) {
                    restoreImageState(state);
                } else {
                    clearImageState();
                }
            }
        }
        
        function restoreImageState(state) {
            // Restore form fields
            if (state.metadata) {
                if (state.metadata.subject) document.getElementById('quizSubject').value = state.metadata.subject;
                if (state.metadata.chapter) document.getElementById('quizChapter').value = state.metadata.chapter;
                if (state.metadata.difficulty) document.getElementById('quizDifficulty').value = state.metadata.difficulty;
                if (state.metadata.count) document.getElementById('quizCount').value = state.metadata.count;
            }
            
            // Restore images to preview
            const grid = document.getElementById('imagePreviewGrid');
            const zone = document.getElementById('imageUploadZone');
            if (grid) grid.innerHTML = '';
            uploadedImages = [];
            
            state.images.forEach((imgData, index) => {
                // Store base64 string directly
                uploadedImages.push(imgData.data);
                
                // Create preview
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `
                    <img src="${imgData.data}" alt="Restored image">
                    <button class="remove-btn" onclick="removeImage(${index}, false)">&times;</button>
                `;
                if (grid) grid.appendChild(item);
            });
            
            if (zone && uploadedImages.length > 0) zone.classList.add('has-image');
            showToast(`${state.images.length} images restored!`, 'success');
            
            // Navigate to New Quiz page
            showPage('newQuizPage');
        }

        // ========================================
        // TUTOR IMAGE STATE (for recovery)
        // ========================================
        function saveTutorImageState() {
            if (!tutorUploadedImages || tutorUploadedImages.length === 0) return;
            
            const state = {
                images: tutorUploadedImages.map((img, i) => ({
                    data: img,
                    name: `tutor_image_${i}.jpg`
                })),
                metadata: {
                    topic: document.getElementById('tutorQuizTopic')?.value,
                    difficulty: document.getElementById('tutorQuizDifficulty')?.value,
                    count: document.getElementById('tutorQuizCount')?.value
                },
                userId: currentUser?.id,
                savedAt: Date.now()
            };
            
            try {
                localStorage.setItem(TUTOR_IMAGE_STATE_KEY, JSON.stringify(state));
                console.log('üì∑ Tutor image state saved');
            } catch (e) {
                console.warn('Could not save tutor image state:', e);
            }
        }
        
        function loadTutorImageState() {
            try {
                const saved = localStorage.getItem(TUTOR_IMAGE_STATE_KEY);
                if (!saved) return null;
                
                const state = JSON.parse(saved);
                
                if (state.userId !== currentUser?.id) return null;
                if (Date.now() - state.savedAt > 86400000) {
                    clearTutorImageState();
                    return null;
                }
                
                return state;
            } catch (e) {
                console.error('Error loading tutor image state:', e);
                return null;
            }
        }
        
        function clearTutorImageState() {
            localStorage.removeItem(TUTOR_IMAGE_STATE_KEY);
            console.log('üóëÔ∏è Tutor image state cleared');
        }
        
        function checkForSavedTutorImages() {
            const state = loadTutorImageState();
            if (state && state.images && state.images.length > 0) {
                const hoursAgo = Math.round((Date.now() - state.savedAt) / 3600000);
                if (confirm(`You have ${state.images.length} uploaded images from ${hoursAgo} hour(s) ago. Restore them?`)) {
                    restoreTutorImageState(state);
                } else {
                    clearTutorImageState();
                }
            }
        }
        
        function restoreTutorImageState(state) {
            // Restore form fields
            if (state.metadata) {
                if (state.metadata.topic) document.getElementById('tutorQuizTopic').value = state.metadata.topic;
                if (state.metadata.difficulty) document.getElementById('tutorQuizDifficulty').value = state.metadata.difficulty;
                if (state.metadata.count) document.getElementById('tutorQuizCount').value = state.metadata.count;
            }
            
            // Restore images to preview
            const grid = document.getElementById('tutorImagePreviewGrid');
            const zone = document.getElementById('tutorImageUploadZone');
            if (grid) grid.innerHTML = '';
            tutorUploadedImages = [];
            
            state.images.forEach((imgData, index) => {
                tutorUploadedImages.push(imgData.data);
                
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `
                    <img src="${imgData.data}" alt="Restored image">
                    <button class="remove-btn" onclick="removeTutorImage(${index})">&times;</button>
                `;
                if (grid) grid.appendChild(item);
            });
            
            if (zone && tutorUploadedImages.length > 0) zone.classList.add('has-image');
            showToast(`${state.images.length} tutor images restored!`, 'success');
            
            // Navigate to Create Quiz page
            showTutorPage('createQuizPage');
        }

        // ========================================
        // UTILITIES
        // ========================================
        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Generate unique share code
        function generateShareCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // Render math equations using KaTeX
        function renderMathInElement(element) {
            if (typeof window.renderMathInElement === 'function') {
                window.renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\[', right: '\\]', display: true},
                        {left: '\\(', right: '\\)', display: false}
                    ],
                    throwOnError: false
                });
            }
        }
        
        // ========================================
        // QUIZ STATE PERSISTENCE (Resume on Reload)
        // ========================================
        function saveQuizState() {
            if (!currentQuiz || currentQuiz.length === 0) return;
            
            const state = {
                quiz: currentQuiz,
                questionIndex: currentQuestionIndex,
                score: quizScore,
                timeRemaining: quizTimeRemaining,
                startTime: quizStartTime,
                metadata: window.currentQuizMetadata,
                imageUrls: uploadedImageUrls,
                userId: currentUser?.id,
                savedAt: Date.now()
            };
            
            localStorage.setItem(QUIZ_STATE_KEY, JSON.stringify(state));
            console.log('üíæ Quiz state saved');
        }
        
        function loadQuizState() {
            try {
                const saved = localStorage.getItem(QUIZ_STATE_KEY);
                if (!saved) return null;
                
                const state = JSON.parse(saved);
                
                // Check if state is for current user and not too old (1 hour max)
                if (state.userId !== currentUser?.id) return null;
                if (Date.now() - state.savedAt > 3600000) {
                    clearQuizState();
                    return null;
                }
                
                return state;
            } catch (e) {
                console.error('Error loading quiz state:', e);
                return null;
            }
        }
        
        function clearQuizState() {
            localStorage.removeItem(QUIZ_STATE_KEY);
            console.log('üóëÔ∏è Quiz state cleared');
        }
        
        function checkForResumeableQuiz() {
            const state = loadQuizState();
            if (state && state.quiz && state.quiz.length > 0) {
                const minutesAgo = Math.round((Date.now() - state.savedAt) / 60000);
                if (confirm(`You have an unfinished quiz (${state.quiz.length} questions, ${minutesAgo} minutes ago). Resume?`)) {
                    resumeQuiz(state);
                } else {
                    clearQuizState();
                }
            }
        }
        
        function resumeQuiz(state) {
            currentQuiz = state.quiz;
            currentQuestionIndex = state.questionIndex;
            quizScore = state.score;
            quizTimeRemaining = state.timeRemaining;
            quizStartTime = state.startTime;
            window.currentQuizMetadata = state.metadata;
            uploadedImageUrls = state.imageUrls || [];
            
            document.getElementById('quizSetupCard').style.display = 'none';
            document.getElementById('activeQuizArea').style.display = 'block';
            
            startTimer();
            showCurrentQuestion();
            showToast('Quiz resumed!', 'success');
        }
        
        // ========================================
        // IMAGE COMPRESSION & UPLOAD TO SUPABASE
        // ========================================
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                // Check file size
                if (file.size > MAX_IMAGE_SIZE_MB * 1024 * 1024) {
                    reject(new Error(`Image too large. Max size is ${MAX_IMAGE_SIZE_MB}MB`));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        
                        // Resize if too large
                        if (w > IMAGE_MAX_DIMENSION || h > IMAGE_MAX_DIMENSION) {
                            if (w > h) {
                                h = (h / w) * IMAGE_MAX_DIMENSION;
                                w = IMAGE_MAX_DIMENSION;
                            } else {
                                w = (w / h) * IMAGE_MAX_DIMENSION;
                                h = IMAGE_MAX_DIMENSION;
                            }
                        }
                        
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        // Compress
                        const compressedBase64 = canvas.toDataURL('image/jpeg', IMAGE_COMPRESSION_QUALITY);
                        const originalSize = file.size;
                        const compressedSize = Math.round(compressedBase64.length * 0.75);
                        
                        console.log(`üì∏ Compressed: ${Math.round(originalSize/1024)}KB ‚Üí ${Math.round(compressedSize/1024)}KB`);
                        resolve(compressedBase64);
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }
        
        async function uploadImageToSupabase(base64Data, index) {
            try {
                // Convert base64 to blob
                const base64Content = base64Data.split(',')[1];
                const byteCharacters = atob(base64Content);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'image/jpeg' });
                
                // Generate unique filename
                const filename = `${currentUser.id}/${Date.now()}_${index}.jpg`;
                
                // Upload to Supabase Storage
                const { data, error } = await supabaseClient.storage
                    .from('quiz-images')
                    .upload(filename, blob, {
                        contentType: 'image/jpeg',
                        upsert: false
                    });
                
                if (error) {
                    console.error('Upload error:', error);
                    return null;
                }
                
                // Get public URL
                const { data: urlData } = supabaseClient.storage
                    .from('quiz-images')
                    .getPublicUrl(filename);
                
                console.log('‚úÖ Image uploaded:', urlData.publicUrl);
                return urlData.publicUrl;
                
            } catch (e) {
                console.error('Exception uploading image:', e);
                return null;
            }
        }
        
        async function uploadAllImagesToSupabase() {
            if (uploadedImages.length === 0) return [];
            
            showLoading('Uploading images to cloud...');
            const urls = [];
            
            for (let i = 0; i < uploadedImages.length; i++) {
                const url = await uploadImageToSupabase(uploadedImages[i], i);
                if (url) urls.push(url);
            }
            
            hideLoading();
            uploadedImageUrls = urls;
            return urls;
        }
        
        // ========================================
        // STREAK SYSTEM (Duolingo-style)
        // ========================================
        async function updateStreak() {
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0];
            const lastActivity = currentUser.last_activity_date;
            
            let newStreak = currentUser.current_streak || 0;
            
            if (lastActivity === today) {
                // Already logged today, no change
                return;
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (lastActivity === yesterdayStr) {
                // Consecutive day - increase streak
                newStreak++;
                showToast(`üî• ${newStreak} day streak!`, 'success');
            } else if (lastActivity && lastActivity < yesterdayStr) {
                // Streak broken
                newStreak = 1;
                showToast('Streak reset. Start a new one!', 'info');
            } else {
                // First activity
                newStreak = 1;
            }
            
            // Update longest streak if needed
            const longestStreak = Math.max(newStreak, currentUser.longest_streak || 0);
            
            // Update database
            await supabaseClient.from('users').update({
                current_streak: newStreak,
                longest_streak: longestStreak,
                last_activity_date: today
            }).eq('id', currentUser.id);
            
            // Update streak history
            await supabaseClient.from('streak_history').upsert({
                user_id: currentUser.id,
                activity_date: today,
                quizzes_completed: 1
            }, { onConflict: 'user_id,activity_date' });
            
            currentUser.current_streak = newStreak;
            currentUser.longest_streak = longestStreak;
            currentUser.last_activity_date = today;
            
            // Check for streak milestones
            checkStreakMilestones(newStreak);
        }
        
        async function checkStreakMilestones(streak) {
            const streakMilestones = [3, 7, 14, 30, 60, 100];
            
            if (streakMilestones.includes(streak)) {
                showToast(`üèÜ ${streak}-day streak milestone!`, 'success');
                await awardMilestone('streak_days', streak);
            }
        }
        
        // ========================================
        // DAILY CHALLENGES
        // ========================================
        async function loadDailyChallenges() {
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0];
            
            // Check if challenges exist for today
            const { data: existing } = await supabaseClient.from('daily_challenges')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('challenge_date', today);
            
            if (!existing || existing.length === 0) {
                // Create new daily challenges
                await createDailyChallenges(today);
            }
            
            // Load and display challenges
            const { data: challenges } = await supabaseClient.from('daily_challenges')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('challenge_date', today);
            
            return challenges || [];
        }
        
        async function createDailyChallenges(date) {
            const challengeTypes = [
                { type: 'quiz_count', target: 3, description: 'Complete 3 quizzes', reward: 20 },
                { type: 'score_target', target: 80, description: 'Score 80%+ on a quiz', reward: 15 },
                { type: 'time_challenge', target: 300, description: 'Complete a quiz in under 5 minutes', reward: 25 }
            ];
            
            const challenges = challengeTypes.map(c => ({
                user_id: currentUser.id,
                challenge_date: date,
                challenge_type: c.type,
                target_value: c.target,
                reward_coins: c.reward
            }));
            
            await supabaseClient.from('daily_challenges').insert(challenges);
        }
        
        async function updateDailyChallengeProgress(quizResult) {
            const today = new Date().toISOString().split('T')[0];
            
            // Update quiz_count challenge
            await supabaseClient.rpc('increment_challenge_progress', {
                p_user_id: currentUser.id,
                p_date: today,
                p_type: 'quiz_count'
            }).catch(() => {
                // Fallback if RPC doesn't exist
                console.log('Challenge RPC not available');
            });
            
            // Check score_target
            const scorePercent = Math.round(quizResult.score / quizResult.total * 100);
            if (scorePercent >= 80) {
                await supabaseClient.from('daily_challenges')
                    .update({ is_completed: true })
                    .eq('user_id', currentUser.id)
                    .eq('challenge_date', today)
                    .eq('challenge_type', 'score_target')
                    .eq('is_completed', false);
            }
            
            // Check time_challenge
            if (quizResult.time < 300) {
                await supabaseClient.from('daily_challenges')
                    .update({ is_completed: true })
                    .eq('user_id', currentUser.id)
                    .eq('challenge_date', today)
                    .eq('challenge_type', 'time_challenge')
                    .eq('is_completed', false);
            }
        }
        
        // ========================================
        // MILESTONES SYSTEM
        // ========================================
        async function checkAndAwardMilestones() {
            if (!currentUser) return;
            
            // Get user's stats
            const { data: results } = await supabaseClient.from('quiz_results')
                .select('*')
                .eq('user_id', currentUser.id);
            
            const totalQuizzes = results?.length || 0;
            const perfectScores = results?.filter(r => r.score === r.total_questions).length || 0;
            const uniqueTopics = new Set(results?.map(r => r.topic)).size || 0;
            
            // Check quiz count milestones
            await checkMilestone('quizzes_taken', totalQuizzes);
            await checkMilestone('perfect_scores', perfectScores);
            await checkMilestone('topics_mastered', uniqueTopics);
        }
        
        async function checkMilestone(type, currentValue) {
            // Get milestones of this type that user hasn't earned
            const { data: milestones } = await supabaseClient.from('milestones')
                .select('*')
                .eq('milestone_type', type)
                .lte('target_value', currentValue);
            
            if (!milestones) return;
            
            for (const milestone of milestones) {
                // Check if already earned
                const { data: existing } = await supabaseClient.from('user_milestones')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('milestone_id', milestone.id)
                    .single();
                
                if (!existing) {
                    // Award milestone
                    await awardMilestone(milestone);
                }
            }
        }
        
        async function awardMilestone(milestone) {
            // Insert into user_milestones
            await supabaseClient.from('user_milestones').insert({
                user_id: currentUser.id,
                milestone_id: milestone.id
            });
            
            // Award coins
            const newCoins = (currentUser.virtual_coins || 0) + milestone.reward_coins;
            await supabaseClient.from('users').update({
                virtual_coins: newCoins,
                total_milestones: (currentUser.total_milestones || 0) + 1
            }).eq('id', currentUser.id);
            
            currentUser.virtual_coins = newCoins;
            
            showToast(`${milestone.badge_emoji} Milestone: ${milestone.name}! +${milestone.reward_coins} coins`, 'success');
        }
        
        // ========================================
        // SHARE QUIZ FUNCTIONALITY
        // ========================================
        async function shareQuiz() {
            if (!currentQuiz || currentQuiz.length === 0) {
                showToast('No quiz to share', 'error');
                return;
            }
            
            const metadata = window.currentQuizMetadata || {};
            const shareCode = generateShareCode();
            
            showLoading('Creating shareable quiz...');
            
            try {
                // Upload images if not already uploaded
                if (uploadedImages.length > 0 && uploadedImageUrls.length === 0) {
                    await uploadAllImagesToSupabase();
                }
                
                const sharedQuiz = {
                    creator_id: currentUser.id,
                    title: metadata.title || `${metadata.topic} Quiz`,
                    subject: metadata.subject || 'General',
                    topic: metadata.topic || 'General',
                    difficulty: metadata.difficulty || 'medium',
                    questions: currentQuiz,
                    image_urls: uploadedImageUrls,
                    share_code: shareCode,
                    is_public: true
                };
                
                const { data, error } = await supabaseClient.from('shared_quizzes')
                    .insert([sharedQuiz])
                    .select();
                
                if (error) throw error;
                
                hideLoading();
                
                // Show share modal with code
                showShareModal(shareCode, data[0].id);
                
            } catch (e) {
                hideLoading();
                console.error('Error sharing quiz:', e);
                showToast('Failed to share quiz: ' + e.message, 'error');
            }
        }
        
        function showShareModal(code, quizId) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="text-align:center;">
                    <h2 style="margin-bottom:20px;">üéâ Quiz Shared!</h2>
                    <p style="color:var(--gray);margin-bottom:20px;">Share this code with friends:</p>
                    <div style="font-size:2.5rem;font-weight:700;color:var(--primary);letter-spacing:8px;padding:20px;background:var(--light);border-radius:12px;margin-bottom:20px;">
                        ${code}
                    </div>
                    <button class="btn" onclick="copyShareCode('${code}')" style="margin-bottom:15px;">üìã Copy Code</button>
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function copyShareCode(code) {
            navigator.clipboard.writeText(code);
            showToast('Code copied!', 'success');
        }
        
        async function joinQuizByCode(code) {
            showLoading('Finding quiz...');
            
            const { data: quiz, error } = await supabaseClient.from('shared_quizzes')
                .select('*')
                .eq('share_code', code.toUpperCase())
                .single();
            
            hideLoading();
            
            if (error || !quiz) {
                showToast('Quiz not found. Check the code.', 'error');
                return;
            }
            
            // Start the shared quiz
            currentQuiz = quiz.questions;
            window.currentQuizMetadata = {
                subject: quiz.subject,
                topic: quiz.topic,
                difficulty: quiz.difficulty,
                title: quiz.title,
                sharedQuizId: quiz.id
            };
            uploadedImageUrls = quiz.image_urls || [];
            
            startQuizUI();
            showToast(`Starting: ${quiz.title}`, 'success');
        }

        // ========================================
        // AUTH
        // ========================================
        function switchToLogin() {
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }
        
        function switchToRegister() {
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }
        
        function switchAuthTab(tab, event) {
            console.log('=== Register tab clicked ===');
            console.log('Tab requested:', tab);
            console.log('Event target:', event.target);
            console.log('Event target text:', event.target.textContent);

            const tabs = document.querySelectorAll('.auth-container .tab');
            console.log('Found tabs:', tabs.length);

            tabs.forEach(t => {
                console.log('Removing active from tab:', t.textContent);
                t.classList.remove('active');
            });

            console.log('Adding active to clicked tab');
            event.target.classList.add('active');

            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            console.log('Login form element:', loginForm);
            console.log('Register form element:', registerForm);

            if (tab === 'login') {
                console.log('Switching to LOGIN form');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                console.log('Switching to REGISTER form');
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }

            console.log('Login form display:', loginForm.style.display);
            console.log('Register form display:', registerForm.style.display);
            console.log('=== Tab switch complete ===');
        }

        async function handleRegister(e) {
            e.preventDefault();
            console.log('=== REGISTRATION WITH OTP STARTED ===');
            showLoading('Sending verification code...');

            // Step 1: Get form values
            let name = document.getElementById('regName').value.trim();
            name = name.replace(/\s/g, '');

            if (!name || name.length < 2) {
                hideLoading();
                showToast('Username must be at least 2 characters (no spaces)', 'error');
                return;
            }

            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const phone = document.getElementById('regPhone').value.trim();
            const password = document.getElementById('regPassword').value;
            const role = document.getElementById('regRole').value;

            const parentEmail = role === 'student' ? document.getElementById('regParentEmail')?.value.trim() : null;
            const parentPhone = role === 'student' ? document.getElementById('regParentPhone')?.value.trim() : null;

            // Validate phone
            if (!phone || phone.length !== 10) {
                hideLoading();
                showToast('Please enter a valid 10-digit phone number', 'error');
                return;
            }

            try {
                // Generate and send OTP
                const otp = generateOTP();
                console.log('Generated OTP (for testing):', otp);

                await sendOTPEmail(email, otp);
                storeOTP(email, otp);

                // Store registration data for later
                pendingRegistration = {
                    name,
                    email,
                    phone,
                    password,
                    role,
                    parentEmail,
                    parentPhone
                };

                // Switch to OTP verification screen
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('otpVerificationForm').style.display = 'block';
                document.getElementById('otpEmail').textContent = email;

                clearOTPInputs();
                startOTPCountdown();

                hideLoading();
                showToast('Verification code sent to your email!', 'success');
                console.log('=== OTP SENT SUCCESSFULLY ===');
            } catch (error) {
                console.error('=== OTP SEND FAILED ===');
                console.error('Error details:', error);
                hideLoading();
                showToast(error.message || 'Failed to send verification code. Please try again.', 'error');
            }
        }

        // ========================================
        // OTP VERIFICATION FUNCTIONS
        // ========================================

        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function sendOTPEmail(email, otp) {
            try {
                const response = await fetch('https://api.brevo.com/v3/smtp/email', {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'api-key': BREVO_API_KEY,
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender: {
                            name: BREVO_SENDER_NAME,
                            email: BREVO_SENDER_EMAIL
                        },
                        to: [{
                            email: email,
                            name: email.split('@')[0]
                        }],
                        subject: 'Your FamLearn Verification Code',
                        htmlContent: `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <style>
                                    body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; }
                                    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                                    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                                    .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
                                    .otp-box { background: white; border: 2px solid #667eea; padding: 20px; text-align: center; font-size: 32px; font-weight: bold; letter-spacing: 8px; color: #667eea; margin: 20px 0; border-radius: 10px; }
                                    .footer { text-align: center; margin-top: 20px; color: #999; font-size: 12px; }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <div class="header">
                                        <h1>üéì FamLearn Pro</h1>
                                        <p>Email Verification</p>
                                    </div>
                                    <div class="content">
                                        <p>Hello!</p>
                                        <p>Thank you for registering with FamLearn Pro. Please use the following verification code to complete your registration:</p>
                                        <div class="otp-box">${otp}</div>
                                        <p><strong>This code will expire in 5 minutes.</strong></p>
                                        <p>If you didn't request this code, please ignore this email.</p>
                                    </div>
                                    <div class="footer">
                                        <p>&copy; 2026 FamLearn Pro - AI-Powered Learning Analytics</p>
                                    </div>
                                </div>
                            </body>
                            </html>
                        `
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to send OTP email');
                }

                return true;
            } catch (error) {
                console.error('Brevo API Error:', error);
                throw error;
            }
        }

        function storeOTP(email, otp) {
            const otpData = {
                email: email,
                otp: otp,
                expiresAt: Date.now() + (5 * 60 * 1000) // 5 minutes
            };
            localStorage.setItem('pending_otp', JSON.stringify(otpData));
        }

        function getStoredOTP(email) {
            const stored = localStorage.getItem('pending_otp');
            if (!stored) return null;

            const otpData = JSON.parse(stored);
            if (otpData.email !== email || Date.now() > otpData.expiresAt) {
                localStorage.removeItem('pending_otp');
                return null;
            }

            return otpData.otp;
        }

        function moveToNext(current, nextId) {
            if (current.value.length === 1 && nextId) {
                document.getElementById(nextId).focus();
            }
        }

        function moveToPrev(event, current, prevId) {
            if (event.key === 'Backspace' && current.value === '' && prevId) {
                document.getElementById(prevId).focus();
            }
        }

        function startOTPCountdown() {
            otpExpiryTime = Date.now() + (5 * 60 * 1000);

            if (otpTimer) clearInterval(otpTimer);

            otpTimer = setInterval(() => {
                const remaining = Math.max(0, Math.floor((otpExpiryTime - Date.now()) / 1000));
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;

                document.getElementById('otpCountdown').textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (remaining === 0) {
                    clearInterval(otpTimer);
                    showToast('OTP expired. Please request a new code.', 'error');
                    document.getElementById('resendBtn').disabled = false;
                }
            }, 1000);
        }

        function clearOTPInputs() {
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`otp${i}`).value = '';
            }
            document.getElementById('otp1').focus();
        }

        function getOTPFromInputs() {
            let otp = '';
            for (let i = 1; i <= 6; i++) {
                otp += document.getElementById(`otp${i}`).value;
            }
            return otp;
        }

        function autoSubmitOTP() {
            const otp = getOTPFromInputs();
            if (otp.length === 6) {
                setTimeout(() => verifyOTP(), 300);
            }
        }

        async function verifyOTP() {
            const enteredOTP = getOTPFromInputs();

            if (enteredOTP.length !== 6) {
                showToast('Please enter all 6 digits', 'error');
                return;
            }

            if (!pendingRegistration) {
                showToast('No pending registration found', 'error');
                return;
            }

            const storedOTP = getStoredOTP(pendingRegistration.email);

            if (!storedOTP) {
                showToast('OTP expired. Please request a new code.', 'error');
                return;
            }

            if (enteredOTP !== storedOTP) {
                showToast('Invalid OTP. Please try again.', 'error');
                clearOTPInputs();
                return;
            }

            // OTP verified! Now create the account
            showLoading('Creating your account...');
            clearInterval(otpTimer);

            try {
                const { name, email, phone, password, role, parentEmail, parentPhone } = pendingRegistration;

                // Create auth user
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email, password, options: { data: { name, role } }
                });

                if (authError) throw authError;
                if (!authData || !authData.user) throw new Error('Failed to create user account');

                // Insert user into database
                const now = new Date();
                const trialEndDate = new Date(now.getTime() + (3 * 24 * 60 * 60 * 1000)); // 3 days from now

                const userRecord = {
                    id: authData.user.id,
                    email,
                    name,
                    phone,
                    role,
                    points: 0,
                    quiz_attempts: 0,
                    role_locked: false,
                    total_time: 0,
                    streak: 0,
                    parent_email: parentEmail || null,
                    parent_phone: parentPhone || null,
                    // Subscription fields
                    subscription_tier: 'free',
                    subscription_status: 'trial',
                    trial_start_date: now.toISOString(),
                    trial_end_date: trialEndDate.toISOString(),
                    quizzes_created_today: 0,
                    quizzes_created_this_month: 0,
                    quiz_library_count: 0,
                    account_status: 'active'
                };

                const { error: insertError } = await supabaseClient.from('users').insert([userRecord]);
                if (insertError) throw new Error('Failed to create user profile: ' + insertError.message);

                // Auto-login
                const { data: loginData, error: loginError } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (loginError) throw new Error('Account created but login failed: ' + loginError.message);

                if (loginData.user) {
                    const { data: profile } = await supabaseClient.from('users').select('*').eq('email', email).single();
                    currentUser = profile;
                    initApp();
                }

                // Clean up
                localStorage.removeItem('pending_otp');
                pendingRegistration = null;

                hideLoading();
                document.getElementById('otpVerificationForm').style.display = 'none';
                showToast('Account created successfully! Welcome to FamLearn!', 'success');
            } catch (error) {
                hideLoading();
                showToast(error.message || 'Registration failed. Please try again.', 'error');
                cancelOTPVerification();
            }
        }

        async function resendOTP() {
            if (!pendingRegistration) {
                showToast('No pending registration found', 'error');
                return;
            }

            document.getElementById('resendBtn').disabled = true;
            showLoading('Sending new code...');

            try {
                const newOTP = generateOTP();
                await sendOTPEmail(pendingRegistration.email, newOTP);
                storeOTP(pendingRegistration.email, newOTP);

                clearOTPInputs();
                startOTPCountdown();

                hideLoading();
                showToast('New code sent to your email!', 'success');

                setTimeout(() => {
                    document.getElementById('resendBtn').disabled = false;
                }, 30000); // 30 seconds cooldown
            } catch (error) {
                hideLoading();
                document.getElementById('resendBtn').disabled = false;
                showToast('Failed to resend code. Please try again.', 'error');
            }
        }

        function cancelOTPVerification() {
            clearInterval(otpTimer);
            localStorage.removeItem('pending_otp');
            pendingRegistration = null;

            document.getElementById('otpVerificationForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearOTPInputs();
        }

        async function handleLogin(e) {
            e.preventDefault();
            showLoading('Logging in...');
            
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                // Get user profile
                const { data: profile, error: profileError } = await supabaseClient.from('users').select('*').eq('email', email).single();

                // If profile doesn't exist, create it
                if (profileError || !profile) {
                    console.log('Profile not found, creating one...');
                    const { data: newProfile, error: insertError } = await supabaseClient.from('users').insert([{
                        id: data.user.id,
                        email: email,
                        name: email.split('@')[0],
                        role: 'student',
                        points: 0,
                        quiz_attempts: 0,
                        role_locked: false
                    }]).select().single();

                    if (insertError) {
                        console.error('Error creating profile:', insertError);
                        throw new Error('Could not create user profile');
                    }
                    currentUser = await ensureSubscriptionFields(newProfile);
                } else {
                    currentUser = await ensureSubscriptionFields(profile);
                }

                initApp();
                
                hideLoading();
                showToast('Welcome back!', 'success');
            } catch (error) {
                hideLoading();
                showToast(error.message, 'error');
            }
        }

        function logout() {
            if (!confirm('Are you sure you want to logout?')) {
                return;
            }
            supabaseClient.auth.signOut();
            currentUser = null;
            document.getElementById('studentApp').classList.remove('active');
            document.getElementById('tutorApp').classList.remove('active');
            document.getElementById('authScreen').style.display = 'flex';
        }

        // ========================================
        // APP INITIALIZATION
        // ========================================
        function initApp() {
            document.getElementById('authScreen').style.display = 'none';

            // üß™ Show testing mode banner if active
            if (TESTING_MODE) {
                const banner = document.getElementById('testingModeBanner');
                if (banner) {
                    banner.style.display = 'block';
                    console.log('üß™ TESTING MODE ACTIVE - All premium features unlocked');
                    console.log('üí° To disable testing mode, set TESTING_MODE = false (line 2423)');
                }
            }

            if (currentUser.role === 'tutor') {
                document.getElementById('tutorApp').classList.add('active');
                document.getElementById('tutorSidebarName').textContent = currentUser.name;
                document.getElementById('tutorAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
                initTutorDashboard();
            } else {
                document.getElementById('studentApp').classList.add('active');
                document.getElementById('totalPoints').textContent = currentUser.points || 0;
                updateSidebarUserInfo(); // Update sidebar with subscription info
                initStudentDashboard();
            }

            setupImageUpload();
        }

        async function initStudentDashboard() {
            await loadStudentStats();
            await loadQuizHistory();
            await loadLeaderboard();
            await loadAssignedQuizzes();
            initCharts();
            
            // Check for resumeable quiz first
            setTimeout(() => checkForResumeableQuiz(), 500);
            
            // Then check for saved images (if no quiz to resume)
            setTimeout(() => {
                const quizState = loadQuizState();
                if (!quizState) {
                    checkForSavedImages();
                }
            }, 1000);
            
            // Load daily challenges
            await loadDailyChallenges();
            
            // Update streak display
            updateStreakDisplay();
        }
        
        function updateStreakDisplay() {
            // Add streak to header if element exists
            const streakEl = document.getElementById('streakDisplay');
            if (streakEl && currentUser) {
                streakEl.innerHTML = `üî• ${currentUser.current_streak || 0} day streak`;
            }
        }

        // ========================================
        // STUDENT STATS
        // ========================================
        async function loadStudentStats() {
            console.log('üìä Loading student stats for user:', currentUser.id);

            const { data: quizzes, error } = await supabaseClient.from('quiz_results')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('‚ùå Error loading student stats:', error);
                return;
            }

            console.log('‚úÖ Loaded', quizzes?.length || 0, 'quiz records for stats');

            if (!quizzes || quizzes.length === 0) {
                console.log('‚ö†Ô∏è No quiz data available for stats');
                return;
            }
            
            const totalQuizzes = quizzes.length;
            const avgScore = Math.round(quizzes.reduce((a, q) => a + (q.score / q.total_questions * 100), 0) / totalQuizzes);
            const avgTime = Math.round(quizzes.reduce((a, q) => a + (q.time_taken || 0), 0) / totalQuizzes / 60);
            
            document.getElementById('statTotalQuizzes').textContent = totalQuizzes;
            document.getElementById('statAvgScore').textContent = avgScore + '%';
            document.getElementById('statAvgTime').textContent = avgTime + 'm';
            document.getElementById('statStreak').textContent = currentUser.streak || 0;
            
            // Latest activity
            const activityHtml = quizzes.slice(0, 5).map(q => {
                const percent = Math.round(q.score / q.total_questions * 100);
                const scoreClass = percent >= 70 ? 'good' : percent >= 50 ? 'avg' : 'poor';
                return `
                    <div class="activity-item">
                        <div class="activity-icon ${q.difficulty === 'hard' ? 'topic' : 'cq'}">${q.difficulty?.charAt(0).toUpperCase() || 'Q'}</div>
                        <div class="activity-details">
                            <div class="activity-title">${q.topic || 'Quiz'}</div>
                            <div class="activity-meta">${formatDate(q.created_at)} ‚Ä¢ ${q.total_questions} questions</div>
                        </div>
                        <div class="activity-score ${scoreClass}">${percent}%</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('latestActivity').innerHTML = activityHtml || '<div class="empty-state"><p>No activity yet</p></div>';
            
            // Topic analysis
            const topicStats = {};
            quizzes.forEach(q => {
                if (!q.topic) return;
                if (!topicStats[q.topic]) topicStats[q.topic] = { total: 0, correct: 0, count: 0 };
                topicStats[q.topic].total += q.total_questions;
                topicStats[q.topic].correct += q.score;
                topicStats[q.topic].count++;
            });
            
            const topics = Object.entries(topicStats).map(([name, stats]) => ({
                name,
                accuracy: Math.round(stats.correct / stats.total * 100),
                count: stats.count
            })).sort((a, b) => b.accuracy - a.accuracy);
            
            const strong = topics.filter(t => t.accuracy >= 70).slice(0, 3);
            const weak = topics.filter(t => t.accuracy < 60).slice(0, 3);
            
            document.getElementById('strongTopics').innerHTML = strong.length ? strong.map(t => `
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">${t.name}</span>
                        <span class="progress-value">${t.accuracy}%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill green" style="width:${t.accuracy}%"></div></div>
                </div>
            `).join('') : '<p style="color:var(--gray);text-align:center;padding:20px;">Not enough data</p>';
            
            document.getElementById('weakTopics').innerHTML = weak.length ? weak.map(t => `
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">${t.name}</span>
                        <span class="progress-value">${t.accuracy}%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill red" style="width:${t.accuracy}%"></div></div>
                </div>
            `).join('') : '<p style="color:var(--gray);text-align:center;padding:20px;">Great job! No weak areas</p>';
        }
        
        // ========================================
        // STUDENT PERFORMANCE ANALYTICS (Scholaranium-style)
        // ========================================
        async function loadStudentPerformanceAnalytics() {
            const timeFilter = document.getElementById('studentTimeFilter')?.value || '30';
            
            // Build date filter
            let dateFilter = null;
            if (timeFilter !== 'all') {
                const days = parseInt(timeFilter);
                dateFilter = new Date();
                dateFilter.setDate(dateFilter.getDate() - days);
            }
            
            // Get quiz results
            let query = supabaseClient.from('quiz_results')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            if (dateFilter) {
                query = query.gte('created_at', dateFilter.toISOString());
            }
            
            const { data: results } = await query;
            
            if (!results || results.length === 0) {
                showEmptyStudentAnalytics();
                return;
            }
            
            // Calculate summary stats
            const totalQuizzes = results.length;
            const totalQuestions = results.reduce((sum, r) => sum + r.total_questions, 0);
            const totalCorrect = results.reduce((sum, r) => sum + r.score, 0);
            const overallAccuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            const avgTimePerQuestion = totalQuestions > 0 ? Math.round(results.reduce((a, r) => a + (r.time_taken || 0), 0) / totalQuestions) : 0;
            const bestScore = Math.max(...results.map(r => Math.round(r.score / r.total_questions * 100)));

            document.getElementById('perfQuizzesTaken').textContent = totalQuestions;
            document.getElementById('perfOverallAccuracy').textContent = overallAccuracy + '%';
            document.getElementById('perfAvgTime').textContent = avgTimePerQuestion + 's';
            document.getElementById('perfCorrectCount') && (document.getElementById('perfCorrectCount').textContent = totalCorrect);
            
            // Render charts and breakdowns
            renderStudentAccuracyByDifficulty(results);
            renderStudentTimeByDifficulty(results);
            renderStudentPerformanceTrend(results);
            renderDifficultyBreakdownTable(results);
        }
        
        function showEmptyStudentAnalytics() {
            document.getElementById('perfQuizzesTaken').textContent = '0';
            document.getElementById('perfOverallAccuracy').textContent = '0%';
            document.getElementById('perfAvgTime').textContent = '0m';
            document.getElementById('perfBestScore').textContent = '0%';
            document.getElementById('studentAccuracyBreakdown').innerHTML = '<p style="color:var(--gray);text-align:center;">Take quizzes to see data</p>';
            document.getElementById('studentTimeBreakdown').innerHTML = '<p style="color:var(--gray);text-align:center;">Take quizzes to see data</p>';
            document.getElementById('difficultyBreakdownTable').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:20px;">Take quizzes to see breakdown</td></tr>';
        }
        
        function renderStudentAccuracyByDifficulty(results) {
            const byDifficulty = { easy: { total: 0, correct: 0, count: 0 }, medium: { total: 0, correct: 0, count: 0 }, hard: { total: 0, correct: 0, count: 0 } };
            
            results.forEach(r => {
                const diff = r.difficulty || 'medium';
                if (byDifficulty[diff]) {
                    byDifficulty[diff].total += r.total_questions;
                    byDifficulty[diff].correct += r.score;
                    byDifficulty[diff].count++;
                }
            });
            
            const easyAcc = byDifficulty.easy.total > 0 ? Math.round(byDifficulty.easy.correct / byDifficulty.easy.total * 100) : 0;
            const mediumAcc = byDifficulty.medium.total > 0 ? Math.round(byDifficulty.medium.correct / byDifficulty.medium.total * 100) : 0;
            const hardAcc = byDifficulty.hard.total > 0 ? Math.round(byDifficulty.hard.correct / byDifficulty.hard.total * 100) : 0;
            
            // Chart
            const ctx = document.getElementById('accuracyChart');
            if (charts.studentAccuracy) charts.studentAccuracy.destroy();
            
            charts.studentAccuracy = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Easy', 'Medium', 'Hard'],
                    datasets: [{
                        label: 'Accuracy %',
                        data: [easyAcc, mediumAcc, hardAcc],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
            
            // Breakdown boxes
            document.getElementById('studentAccuracyBreakdown').innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;">
                    <div style="padding:12px;background:#d1fae5;border-radius:10px;">
                        <div style="font-size:1.5rem;font-weight:700;color:#065f46;">${easyAcc}%</div>
                        <div style="font-size:12px;color:#065f46;">Easy</div>
                        <div style="font-size:11px;color:#065f46;margin-top:4px;">${byDifficulty.easy.count} quizzes</div>
                    </div>
                    <div style="padding:12px;background:#fef3c7;border-radius:10px;">
                        <div style="font-size:1.5rem;font-weight:700;color:#92400e;">${mediumAcc}%</div>
                        <div style="font-size:12px;color:#92400e;">Medium</div>
                        <div style="font-size:11px;color:#92400e;margin-top:4px;">${byDifficulty.medium.count} quizzes</div>
                    </div>
                    <div style="padding:12px;background:#fee2e2;border-radius:10px;">
                        <div style="font-size:1.5rem;font-weight:700;color:#991b1b;">${hardAcc}%</div>
                        <div style="font-size:12px;color:#991b1b;">Hard</div>
                        <div style="font-size:11px;color:#991b1b;margin-top:4px;">${byDifficulty.hard.count} quizzes</div>
                    </div>
                </div>
            `;
        }
        
        function renderStudentTimeByDifficulty(results) {
            const byDifficulty = { easy: { time: 0, questions: 0, count: 0 }, medium: { time: 0, questions: 0, count: 0 }, hard: { time: 0, questions: 0, count: 0 } };
            
            results.forEach(r => {
                const diff = r.difficulty || 'medium';
                if (byDifficulty[diff]) {
                    byDifficulty[diff].time += r.time_taken || 0;
                    byDifficulty[diff].questions += r.total_questions;
                    byDifficulty[diff].count++;
                }
            });
            
            // Calculate avg time per question for each difficulty
            const easyTime = byDifficulty.easy.questions > 0 ? Math.round(byDifficulty.easy.time / byDifficulty.easy.questions) : 0;
            const mediumTime = byDifficulty.medium.questions > 0 ? Math.round(byDifficulty.medium.time / byDifficulty.medium.questions) : 0;
            const hardTime = byDifficulty.hard.questions > 0 ? Math.round(byDifficulty.hard.time / byDifficulty.hard.questions) : 0;
            
            // Chart
            const ctx = document.getElementById('timeChart');
            if (charts.studentTime) charts.studentTime.destroy();
            
            charts.studentTime = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Easy', 'Medium', 'Hard'],
                    datasets: [{
                        label: 'Seconds/Question',
                        data: [easyTime, mediumTime, hardTime],
                        backgroundColor: ['#60a5fa', '#a78bfa', '#f472b6'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            
            // Breakdown boxes
            document.getElementById('studentTimeBreakdown').innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;">
                    <div style="padding:12px;background:#dbeafe;border-radius:10px;">
                        <div style="font-size:1.5rem;font-weight:700;color:#1e40af;">${easyTime}s</div>
                        <div style="font-size:12px;color:#1e40af;">Per Question</div>
                        <div style="font-size:11px;color:#1e40af;margin-top:4px;">Easy</div>
                    </div>
                    <div style="padding:12px;background:#ede9fe;border-radius:10px;">
                        <div style="font-size:1.5rem;font-weight:700;color:#5b21b6;">${mediumTime}s</div>
                        <div style="font-size:12px;color:#5b21b6;">Per Question</div>
                        <div style="font-size:11px;color:#5b21b6;margin-top:4px;">Medium</div>
                    </div>
                    <div style="padding:12px;background:#fce7f3;border-radius:10px;">
                        <div style="font-size:1.5rem;font-weight:700;color:#9d174d;">${hardTime}s</div>
                        <div style="font-size:12px;color:#9d174d;">Per Question</div>
                        <div style="font-size:11px;color:#9d174d;margin-top:4px;">Hard</div>
                    </div>
                </div>
            `;
        }
        
        function renderStudentPerformanceTrend(results) {
            // Group by date
            const byDate = {};
            results.forEach(r => {
                const date = new Date(r.created_at).toLocaleDateString();
                if (!byDate[date]) byDate[date] = { total: 0, correct: 0, count: 0 };
                byDate[date].total += r.total_questions;
                byDate[date].correct += r.score;
                byDate[date].count++;
            });
            
            const dates = Object.keys(byDate).reverse().slice(-14);
            const accuracies = dates.map(d => Math.round(byDate[d].correct / byDate[d].total * 100));
            const counts = dates.map(d => byDate[d].count);
            
            const ctx = document.getElementById('performanceOverTimeChart');
            if (charts.studentPerformanceTrend) charts.studentPerformanceTrend.destroy();
            
            charts.studentPerformanceTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Accuracy %',
                            data: accuracies,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Quizzes',
                            data: counts,
                            borderColor: '#10b981',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { type: 'linear', position: 'left', beginAtZero: true, max: 100, title: { display: true, text: 'Accuracy %' } },
                        y1: { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Quiz Count' } }
                    }
                }
            });
        }
        
        function renderDifficultyBreakdownTable(results) {
            const byDifficulty = { 
                easy: { total: 0, correct: 0, time: 0, count: 0 }, 
                medium: { total: 0, correct: 0, time: 0, count: 0 }, 
                hard: { total: 0, correct: 0, time: 0, count: 0 } 
            };
            
            results.forEach(r => {
                const diff = r.difficulty || 'medium';
                if (byDifficulty[diff]) {
                    byDifficulty[diff].total += r.total_questions;
                    byDifficulty[diff].correct += r.score;
                    byDifficulty[diff].time += r.time_taken || 0;
                    byDifficulty[diff].count++;
                }
            });
            
            // Weighted score: Easy=1x, Medium=1.5x, Hard=2x
            const weights = { easy: 1, medium: 1.5, hard: 2 };
            let totalWeighted = 0;
            let totalWeight = 0;
            
            const rows = ['easy', 'medium', 'hard'].map(diff => {
                const d = byDifficulty[diff];
                const accuracy = d.total > 0 ? Math.round(d.correct / d.total * 100) : 0;
                const avgTimePerQ = d.total > 0 ? Math.round(d.time / d.total) : 0;
                const weighted = Math.round(accuracy * weights[diff]);
                
                if (d.total > 0) {
                    totalWeighted += accuracy * weights[diff] * d.total;
                    totalWeight += weights[diff] * d.total;
                }
                
                const badgeClass = diff === 'easy' ? 'success' : diff === 'medium' ? 'warning' : 'danger';
                
                return `
                    <tr>
                        <td><span class="badge badge-${badgeClass}">${diff.charAt(0).toUpperCase() + diff.slice(1)}</span></td>
                        <td>${d.total}</td>
                        <td>${d.correct}</td>
                        <td><strong>${accuracy}%</strong></td>
                        <td>${avgTimePerQ}s</td>
                        <td><strong>${weighted}</strong></td>
                    </tr>
                `;
            }).join('');
            
            const overallWeighted = totalWeight > 0 ? Math.round(totalWeighted / totalWeight) : 0;
            
            document.getElementById('difficultyBreakdownTable').innerHTML = rows + `
                <tr style="background:#f8fafc;font-weight:600;">
                    <td>Overall Weighted</td>
                    <td>${byDifficulty.easy.total + byDifficulty.medium.total + byDifficulty.hard.total}</td>
                    <td>${byDifficulty.easy.correct + byDifficulty.medium.correct + byDifficulty.hard.correct}</td>
                    <td>-</td>
                    <td>-</td>
                    <td style="color:var(--primary);font-size:1.1rem;">${overallWeighted}</td>
                </tr>
            `;
        }
        
        // ========================================
        // ENHANCED ANALYTICS WITH FILTERS
        // ========================================
        function updateBlockFilter() {
            const subject = document.getElementById('perfSubjectFilter')?.value;
            const blockSelect = document.getElementById('perfBlockFilter');
            if (!blockSelect) return;
            
            blockSelect.innerHTML = '<option value="all">All Blocks</option>';
            
            if (subject && subject !== 'all' && SUBJECT_BLOCKS[subject]) {
                SUBJECT_BLOCKS[subject].forEach(block => {
                    blockSelect.innerHTML += `<option value="${block}">${block}</option>`;
                });
            }
        }
        
        async function loadEnhancedAnalytics() {
            const timeFilter = document.getElementById('perfTimeFilter')?.value || '30';
            const difficultyFilter = document.getElementById('perfDifficultyFilter')?.value || 'all';
            const subjectFilter = document.getElementById('perfSubjectFilter')?.value || 'all';
            const blockFilter = document.getElementById('perfBlockFilter')?.value || 'all';
            const questionsFilter = document.getElementById('perfQuestionsFilter')?.value || 'all';
            
            console.log('üìä Loading enhanced analytics:', { timeFilter, difficultyFilter, subjectFilter, blockFilter, questionsFilter });
            
            // Build date filter
            let dateFilter = null;
            if (timeFilter !== 'all') {
                const days = parseInt(timeFilter);
                dateFilter = new Date();
                dateFilter.setDate(dateFilter.getDate() - days);
            }
            
            // Get quiz results
            let query = supabaseClient.from('quiz_results')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            if (dateFilter) {
                query = query.gte('created_at', dateFilter.toISOString());
            }
            
            if (difficultyFilter !== 'all') {
                query = query.eq('difficulty', difficultyFilter);
            }
            
            if (subjectFilter !== 'all') {
                query = query.eq('subject', subjectFilter);
            }
            
            const { data: results, error } = await query;
            
            if (error) {
                console.error('Error loading analytics:', error);
                return;
            }
            
            if (!results || results.length === 0) {
                showEmptyEnhancedAnalytics();
                return;
            }
            
            // Extract all questions from quiz results for detailed analysis
            let allQuestions = [];
            results.forEach(r => {
                if (r.questions && Array.isArray(r.questions)) {
                    r.questions.forEach((q, idx) => {
                        allQuestions.push({
                            ...q,
                            quizId: r.id,
                            difficulty: r.difficulty,
                            subject: r.subject,
                            block: q.block || 'General',
                            createdAt: r.created_at,
                            timePerQuestion: r.time_taken ? Math.round(r.time_taken / r.total_questions) : 0
                        });
                    });
                }
            });
            
            // Apply block filter
            if (blockFilter !== 'all') {
                allQuestions = allQuestions.filter(q => q.block === blockFilter);
            }
            
            // Apply questions limit filter
            if (questionsFilter !== 'all') {
                const limit = parseInt(questionsFilter);
                allQuestions = allQuestions.slice(0, limit);
            }
            
            // Calculate stats
            const totalQuestions = allQuestions.length;
            const correctAnswers = allQuestions.filter(q => q.userAnswer === q.correct).length;
            const accuracy = totalQuestions > 0 ? Math.round(correctAnswers / totalQuestions * 100) : 0;
            const avgTimePerQuestion = totalQuestions > 0 ? Math.round(allQuestions.reduce((a, q) => a + (q.timePerQuestion || 0), 0) / totalQuestions) : 0;
            
            // Update UI
            document.getElementById('perfQuizzesTaken').textContent = totalQuestions;
            document.getElementById('perfOverallAccuracy').textContent = accuracy + '%';
            document.getElementById('perfAvgTime').textContent = avgTimePerQuestion + 's';
            document.getElementById('perfCorrectCount').textContent = correctAnswers;
            
            // Render block-wise performance
            renderBlockPerformance(allQuestions, subjectFilter);
            
            // Render difficulty breakdown
            renderEnhancedDifficultyBreakdown(results);
            
            // Render trend chart
            renderEnhancedTrendChart(results);
        }
        
        function showEmptyEnhancedAnalytics() {
            document.getElementById('perfQuizzesTaken').textContent = '0';
            document.getElementById('perfOverallAccuracy').textContent = '0%';
            document.getElementById('perfAvgTime').textContent = '0s';
            document.getElementById('perfCorrectCount').textContent = '0';
            document.getElementById('blockPerformanceContainer').innerHTML = '<div class="empty-state" style="padding:30px;"><p>No data for selected filters</p></div>';
            document.getElementById('difficultyBreakdownTable').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:20px;">No data available</td></tr>';
        }
        
        function renderBlockPerformance(questions, subject) {
            const container = document.getElementById('blockPerformanceContainer');
            
            if (!subject || subject === 'all') {
                container.innerHTML = '<div class="empty-state" style="padding:30px;"><p>Select a subject to see block-wise breakdown</p></div>';
                return;
            }
            
            const blocks = SUBJECT_BLOCKS[subject] || ['General'];
            const blockStats = {};
            
            blocks.forEach(block => {
                blockStats[block] = { total: 0, correct: 0, time: 0 };
            });
            
            questions.forEach(q => {
                const block = q.block || 'General';
                if (blockStats[block]) {
                    blockStats[block].total++;
                    if (q.userAnswer === q.correct) blockStats[block].correct++;
                    blockStats[block].time += q.timePerQuestion || 0;
                }
            });
            
            // Generate HTML
            const html = blocks.map(block => {
                const stats = blockStats[block];
                const accuracy = stats.total > 0 ? Math.round(stats.correct / stats.total * 100) : 0;
                const avgTime = stats.total > 0 ? Math.round(stats.time / stats.total) : 0;
                const barColor = accuracy >= 70 ? '#10b981' : accuracy >= 50 ? '#f59e0b' : '#ef4444';
                
                return `
                    <div style="margin-bottom:15px;padding:15px;background:#f9fafb;border-radius:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="font-weight:600;color:var(--dark);">${block}</span>
                            <span style="font-size:13px;color:var(--gray);">${stats.total} questions</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:15px;">
                            <div style="flex:1;background:#e5e7eb;border-radius:10px;height:12px;overflow:hidden;">
                                <div style="width:${accuracy}%;height:100%;background:${barColor};border-radius:10px;transition:width 0.3s;"></div>
                            </div>
                            <div style="min-width:50px;text-align:right;font-weight:700;color:${barColor};">${accuracy}%</div>
                            <div style="min-width:60px;text-align:right;font-size:13px;color:var(--gray);">‚è±Ô∏è ${avgTime}s</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html || '<div class="empty-state" style="padding:30px;"><p>No data available</p></div>';
        }
        
        function renderEnhancedDifficultyBreakdown(results) {
            const byDifficulty = { 
                easy: { total: 0, correct: 0, time: 0, prevAcc: 0 }, 
                medium: { total: 0, correct: 0, time: 0, prevAcc: 0 }, 
                hard: { total: 0, correct: 0, time: 0, prevAcc: 0 } 
            };
            
            results.forEach(r => {
                const diff = r.difficulty || 'medium';
                if (byDifficulty[diff]) {
                    byDifficulty[diff].total += r.total_questions;
                    byDifficulty[diff].correct += r.score;
                    byDifficulty[diff].time += r.time_taken || 0;
                }
            });
            
            const rows = ['easy', 'medium', 'hard'].map(diff => {
                const d = byDifficulty[diff];
                const accuracy = d.total > 0 ? Math.round(d.correct / d.total * 100) : 0;
                const avgTimePerQ = d.total > 0 ? Math.round(d.time / d.total) : 0;
                const badgeClass = diff === 'easy' ? 'success' : diff === 'medium' ? 'warning' : 'danger';
                const trend = '‚Üí'; // TODO: Calculate actual trend from historical data
                
                return `
                    <tr>
                        <td><span class="badge badge-${badgeClass}">${diff.charAt(0).toUpperCase() + diff.slice(1)}</span></td>
                        <td>${d.total}</td>
                        <td>${d.correct}</td>
                        <td><strong>${accuracy}%</strong></td>
                        <td>${avgTimePerQ}s</td>
                        <td>${trend}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('difficultyBreakdownTable').innerHTML = rows || '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:20px;">No data</td></tr>';
            
            // Update charts
            renderStudentAccuracyByDifficulty(results);
            renderStudentTimeByDifficulty(results);
        }
        
        function renderEnhancedTrendChart(results) {
            // Group by date
            const byDate = {};
            results.forEach(r => {
                const date = new Date(r.created_at).toLocaleDateString();
                if (!byDate[date]) byDate[date] = { total: 0, correct: 0, count: 0 };
                byDate[date].total += r.total_questions;
                byDate[date].correct += r.score;
                byDate[date].count++;
            });
            
            const dates = Object.keys(byDate).slice(-10); // Last 10 data points
            const accuracies = dates.map(d => Math.round(byDate[d].correct / byDate[d].total * 100));
            
            const ctx = document.getElementById('performanceOverTimeChart');
            if (charts.studentPerformanceTrend) charts.studentPerformanceTrend.destroy();
            
            charts.studentPerformanceTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Accuracy %',
                        data: accuracies,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }
        
        // ========================================
        // STUDENT TOPICS ANALYSIS
        // ========================================
        async function loadStudentTopicsAnalysis() {
            const { data: results } = await supabaseClient.from('quiz_results')
                .select('*')
                .eq('user_id', currentUser.id);
            
            if (!results || results.length === 0) {
                document.getElementById('strongTopicsDetailed').innerHTML = '<div class="empty-state" style="padding:20px;"><p>Complete quizzes to see strengths</p></div>';
                document.getElementById('weakTopicsDetailed').innerHTML = '<div class="empty-state" style="padding:20px;"><p>No weak areas detected</p></div>';
                document.getElementById('topicsTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:30px;">Complete quizzes to see topic analysis</td></tr>';
                return;
            }
            
            // Build topic stats
            const topicStats = {};
            results.forEach(r => {
                const topic = r.topic || 'General';
                if (!topicStats[topic]) topicStats[topic] = { total: 0, correct: 0, time: 0, count: 0 };
                topicStats[topic].total += r.total_questions;
                topicStats[topic].correct += r.score;
                topicStats[topic].time += r.time_taken || 0;
                topicStats[topic].count++;
            });
            
            const topics = Object.entries(topicStats)
                .map(([name, stats]) => ({
                    name,
                    accuracy: Math.round(stats.correct / stats.total * 100),
                    avgTime: Math.round(stats.time / stats.count / 60),
                    questions: stats.total,
                    count: stats.count
                }))
                .sort((a, b) => b.accuracy - a.accuracy);
            
            // Strong topics (70%+)
            const strong = topics.filter(t => t.accuracy >= 70);
            document.getElementById('strongTopicsDetailed').innerHTML = strong.length > 0 
                ? strong.map(t => `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-label">${t.name}</span>
                            <span class="progress-value" style="color:#065f46;">${t.accuracy}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill green" style="width:${t.accuracy}%"></div></div>
                        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--gray);margin-top:4px;">
                            <span>${t.count} quizzes ‚Ä¢ ${t.questions} questions</span>
                            <span>Avg ${t.avgTime}m</span>
                        </div>
                    </div>
                `).join('')
                : '<div class="empty-state" style="padding:20px;"><p>Complete more quizzes to identify strengths</p></div>';
            
            // Weak topics (<60%)
            const weak = topics.filter(t => t.accuracy < 60);
            document.getElementById('weakTopicsDetailed').innerHTML = weak.length > 0 
                ? weak.map(t => `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-label">${t.name}</span>
                            <span class="progress-value" style="color:#991b1b;">${t.accuracy}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill red" style="width:${t.accuracy}%"></div></div>
                        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--gray);margin-top:4px;">
                            <span>${t.count} quizzes ‚Ä¢ ${t.questions} questions</span>
                            <span>Avg ${t.avgTime}m</span>
                        </div>
                    </div>
                `).join('')
                : '<div style="text-align:center;padding:20px;color:var(--success);"><div style="font-size:32px;margin-bottom:8px;">üéâ</div><p>Great job! No weak areas</p></div>';
            
            // All topics table
            document.getElementById('topicsTableBody').innerHTML = topics.map(t => {
                const colorClass = t.accuracy >= 70 ? 'green' : t.accuracy >= 50 ? 'yellow' : 'red';
                return `
                    <tr>
                        <td><strong>${t.name}</strong></td>
                        <td>${t.count}</td>
                        <td>${t.questions}</td>
                        <td><span class="badge ${t.accuracy >= 70 ? 'badge-success' : t.accuracy >= 50 ? 'badge-warning' : 'badge-danger'}">${t.accuracy}%</span></td>
                        <td>${t.avgTime}m</td>
                        <td style="width:150px;">
                            <div class="progress-bar" style="height:8px;"><div class="progress-fill ${colorClass}" style="width:${t.accuracy}%"></div></div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // FIX #2: IMPROVED QUIZ HISTORY LOADING WITH ERROR HANDLING
        // Now includes View Solutions button for revision
        async function loadQuizHistory() {
            console.log('üìö Loading quiz history for user:', currentUser.id);

            try {
                const { data: quizzes, error } = await supabaseClient.from('quiz_results')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('‚ùå Error loading history:', error);
                    document.getElementById('historyTableBody').innerHTML =
                        `<tr><td colspan="7" style="text-align:center;color:var(--danger);padding:40px;">Error: ${error.message}</td></tr>`;
                    return;
                }

                console.log('‚úÖ Loaded', quizzes?.length || 0, 'quiz records');

                // Check if user is expired student - limit to last 3 quizzes
                let displayQuizzes = quizzes;
                let isLocked = false;

                if (isSubscriptionExpired() && !isInGracePeriod() && currentUser.role === 'student') {
                    displayQuizzes = quizzes.slice(0, 3);
                    isLocked = true;
                    console.log('üîí Student account expired - limiting to last 3 quizzes');
                }

                // Store quizzes globally for viewing solutions
                window.quizHistoryData = displayQuizzes;

                if (!displayQuizzes || displayQuizzes.length === 0) {
                    document.getElementById('historyTableBody').innerHTML =
                        '<tr><td colspan="7" style="text-align:center;color:var(--gray);padding:40px;">No quiz history yet. Take a quiz to see your progress!</td></tr>';
                    return;
                }

                // Show lockout banner if applicable
                const historyPage = document.getElementById('historyPage');
                const existingBanner = historyPage.querySelector('.lockout-banner');
                if (existingBanner) existingBanner.remove();

                if (isLocked && quizzes.length > 3) {
                    const banner = document.createElement('div');
                    banner.className = 'lockout-banner';
                    banner.style.cssText = 'background:linear-gradient(135deg,#f59e0b,#ea580c);color:white;padding:15px 20px;border-radius:10px;margin-bottom:20px;text-align:center;';
                    banner.innerHTML = `
                        <div style="font-size:16px;font-weight:600;margin-bottom:5px;">üîí Limited Access</div>
                        <div style="font-size:14px;opacity:0.9;margin-bottom:10px;">
                            Your ${currentUser.subscription_tier === 'free' ? 'trial' : 'subscription'} has expired. Showing only your last 3 quizzes (${quizzes.length - 3} hidden).
                        </div>
                        <button class="btn" onclick="showPage('pricing', event)" style="background:white;color:#ea580c;padding:8px 20px;font-size:14px;font-weight:600;">
                            Upgrade to Access All ${quizzes.length} Quizzes
                        </button>
                    `;
                    const cardElement = historyPage.querySelector('.card');
                    if (cardElement) {
                        cardElement.parentNode.insertBefore(banner, cardElement);
                    }
                }
                
                document.getElementById('historyTableBody').innerHTML = displayQuizzes.map((q, index) => {
                    const percent = Math.round(q.score / q.total_questions * 100);
                    const badgeClass = percent >= 70 ? 'success' : percent >= 50 ? 'warning' : 'danger';
                    const diffBadge = q.difficulty === 'hard' ? 'danger' : q.difficulty === 'medium' ? 'warning' : 'success';
                    return `
                        <tr>
                            <td>${formatDate(q.created_at)}</td>
                            <td>${q.topic || 'Quiz'}</td>
                            <td><span class="badge badge-${diffBadge}">${(q.difficulty || 'medium').charAt(0).toUpperCase() + (q.difficulty || 'medium').slice(1)}</span></td>
                            <td><span class="badge badge-${badgeClass}">${q.score}/${q.total_questions} (${percent}%)</span></td>
                            <td>${formatTime(q.time_taken || 0)}</td>
                            <td>+${q.points_earned || 0}</td>
                            <td>
                                <div style="display:flex;gap:5px;">
                                    <button onclick="viewPastQuizSolutions(${index})" style="padding:6px 12px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
                                        üìñ View
                                    </button>
                                    <button onclick="loadQuizLeaderboard('${q.topic}', '${q.difficulty || 'medium'}')" style="padding:6px 12px;background:var(--warning);color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
                                        üèÜ Leaderboard
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('‚ùå Exception in loadQuizHistory:', e);
            }
        }

        // Load assigned quizzes for student
        async function loadAssignedQuizzes() {
            console.log('========================================');
            console.log('üìã Loading assigned quizzes for student:', currentUser.id, currentUser.name);
            console.log('========================================');

            try {
                // Get student's batches
                const { data: studentBatches, error: batchError } = await supabaseClient.from('batch_students')
                    .select('batch_id')
                    .eq('student_id', currentUser.id);

                console.log('1Ô∏è‚É£ Student batches query result:', studentBatches, 'Error:', batchError);

                if (!studentBatches || studentBatches.length === 0) {
                    console.log('‚ùå Student is NOT in any batches');
                    document.getElementById('assignedQuizzesContainer').innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray);">You are not in any batches yet. Ask your tutor to add you.</div>';
                    return;
                }

                const batchIds = studentBatches.map(b => b.batch_id);
                console.log('2Ô∏è‚É£ Student is in batches:', batchIds);

                // Get assigned quizzes for these batches (simplified query)
                const { data: assignments, error: assignError } = await supabaseClient
                    .from('quiz_assignments')
                    .select('*')
                    .in('batch_id', batchIds)
                    .order('deadline', { ascending: true });

                console.log('3Ô∏è‚É£ Quiz assignments found:', assignments?.length || 0, 'Error:', assignError);
                console.log('   Assignments data:', assignments);

                if (!assignments || assignments.length === 0) {
                    console.log('‚ùå No quiz assignments for these batches');
                    document.getElementById('assignedQuizzesContainer').innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray);">No quizzes assigned yet</div>';
                    return;
                }

                // Get quiz details separately
                const quizIds = assignments.map(a => a.quiz_id).filter(Boolean);
                const { data: quizzes } = await supabaseClient
                    .from('saved_quizzes')
                    .select('*')
                    .in('id', quizIds);
                
                const quizMap = {};
                quizzes?.forEach(q => quizMap[q.id] = q);

                // Get batch names
                const { data: batchesData } = await supabaseClient
                    .from('batches')
                    .select('id, name')
                    .in('id', batchIds);
                
                const batchMap = {};
                batchesData?.forEach(b => batchMap[b.id] = b.name);

                // Get tutor names
                const tutorIds = assignments.map(a => a.tutor_id).filter(Boolean);
                const { data: tutors } = await supabaseClient
                    .from('users')
                    .select('id, name')
                    .in('id', tutorIds);
                
                const tutorMap = {};
                tutors?.forEach(t => tutorMap[t.id] = t.name);

                // Check completion status - ONLY for current user
                console.log('üîç Checking completions for user:', currentUser.id);
                const { data: completions, error: completionError } = await supabaseClient.from('quiz_results')
                    .select('shared_quiz_id, score, total_questions')
                    .eq('user_id', currentUser.id);

                console.log('üìã User completions:', completions, 'Error:', completionError);
                
                const completedQuizIds = new Set(completions?.map(c => c.shared_quiz_id).filter(Boolean) || []);
                console.log('‚úÖ Completed quiz IDs for this user:', [...completedQuizIds]);

                // Render assigned quizzes
                const html = assignments.map(assignment => {
                    const quiz = quizMap[assignment.quiz_id] || {};
                    const batchName = batchMap[assignment.batch_id] || 'Unknown Batch';
                    const tutorName = tutorMap[assignment.tutor_id] || 'Unknown Tutor';
                    const isCompleted = completedQuizIds.has(assignment.quiz_id);
                    const dueDate = assignment.deadline ? new Date(assignment.deadline) : null;
                    const isOverdue = !isCompleted && dueDate && dueDate < new Date();

                    return `
                        <div style="border:1px solid #e5e7eb;border-radius:10px;padding:15px;margin-bottom:15px;background:${isCompleted ? '#f0fdf4' : isOverdue ? '#fef2f2' : 'white'};">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                                <div>
                                    <h3 style="margin:0 0 5px 0;color:var(--dark);">${quiz.title || 'Quiz'}</h3>
                                    <div style="font-size:13px;color:var(--gray);">
                                        <span>üìö ${batchName}</span> ‚Ä¢
                                        <span>üë®‚Äçüè´ ${tutorName}</span>
                                    </div>
                                </div>
                                <div>
                                    ${isCompleted
                                        ? '<span style="background:#d1fae5;color:#065f46;padding:4px 10px;border-radius:20px;font-size:12px;">‚úÖ Completed</span>'
                                        : isOverdue
                                            ? '<span style="background:#fee2e2;color:#991b1b;padding:4px 10px;border-radius:20px;font-size:12px;">‚ö†Ô∏è Overdue</span>'
                                            : '<span style="background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:20px;font-size:12px;">‚è≥ Pending</span>'
                                    }
                                </div>
                            </div>
                            <div style="font-size:13px;margin-bottom:10px;">
                                <strong>Due:</strong> <span style="color:${isOverdue ? 'var(--danger)' : 'var(--dark)'};">${dueDate ? formatDate(assignment.deadline) : 'No deadline'}</span>
                            </div>
                            ${assignment.instructions ? `<div style="font-size:13px;color:var(--gray);margin-bottom:10px;font-style:italic;">${assignment.instructions}</div>` : ''}
                            <button
                                onclick="startAssignedQuiz('${assignment.quiz_id}')"
                                class="btn ${isCompleted ? 'btn-secondary' : ''}"
                                style="width:100%;margin-top:10px;">
                                ${isCompleted ? '‚úÖ View Results' : '‚ñ∂Ô∏è Start Quiz'}
                            </button>
                        </div>
                    `;
                }).join('');

                document.getElementById('assignedQuizzesContainer').innerHTML = html;
                console.log('‚úÖ Loaded', assignments.length, 'assigned quizzes');
            } catch (error) {
                console.error('‚ùå Error loading assigned quizzes:', error);
                document.getElementById('assignedQuizzesContainer').innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger);">Error loading assigned quizzes</div>';
            }
        }

        // Start an assigned quiz
        async function startAssignedQuiz(quizId) {
            console.log('‚ñ∂Ô∏è Starting assigned quiz:', quizId);

            try {
                const { data: quiz } = await supabaseClient.from('saved_quizzes')
                    .select('*')
                    .eq('id', quizId)
                    .single();

                if (!quiz || !quiz.questions) {
                    showToast('Quiz not found or has no questions', 'error');
                    return;
                }

                // Set up quiz
                currentQuiz = quiz.questions;
                currentQuestionIndex = 0;
                quizScore = 0;
                window.currentQuizMetadata = {
                    topic: quiz.topic,
                    subject: quiz.subject,
                    difficulty: quiz.difficulty,
                    sharedQuizId: quiz.id
                };
                
                console.log('üìå Set sharedQuizId:', quiz.id);
                console.log('üìå currentQuizMetadata:', window.currentQuizMetadata);

                // Navigate to quiz page (use 'newQuiz' not 'newQuizPage')
                showPage('newQuiz');
                startQuizUI();
                showToast('Quiz started!', 'success');
            } catch (error) {
                console.error('‚ùå Error starting assigned quiz:', error);
                showToast('Error starting quiz: ' + error.message, 'error');
            }
        }

        async function loadLeaderboard(timeFilter = 'all') {
            console.log('========================================');
            console.log('üìä Loading leaderboard with filter:', timeFilter);
            console.log('========================================');

            // Update button styles
            ['today', 'week', 'month', 'all'].forEach(f => {
                const btn = document.getElementById(`leaderboard-${f}`);
                if (btn) {
                    btn.className = f === timeFilter ? 'btn btn-success' : 'btn';
                }
            });

            // Calculate date filter
            let dateFilter = null;
            if (timeFilter !== 'all') {
                const now = new Date();
                if (timeFilter === 'today') {
                    dateFilter = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
                } else if (timeFilter === 'week') {
                    now.setDate(now.getDate() - 7);
                    dateFilter = now.toISOString();
                } else if (timeFilter === 'month') {
                    now.setDate(now.getDate() - 30);
                    dateFilter = now.toISOString();
                }
            }

            try {
                // Get all students
                const { data: students, error: studentsError } = await supabaseClient.from('users')
                    .select('id, name, email')
                    .eq('role', 'student');

                console.log('üìö Students found:', students?.length, 'Error:', studentsError);
                console.log('Students:', students);

                if (!students || students.length === 0) {
                    document.getElementById('leaderboardBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--gray);">No students found</td></tr>';
                    return;
                }

                // Get quiz results with date filter
                let query = supabaseClient.from('quiz_results').select('*');
                if (dateFilter) {
                    query = query.gte('created_at', dateFilter);
                }
                const { data: allResults, error: resultsError } = await query;

                console.log('üìù Quiz results found:', allResults?.length, 'Error:', resultsError);

                // Calculate stats for each student
                const leaderboard = students.map(student => {
                    const studentResults = allResults?.filter(r => r.user_id === student.id) || [];
                    const points = studentResults.reduce((sum, r) => sum + (r.points_earned || r.score * 10), 0);
                    const quizzes = studentResults.length;
                    const avgScore = quizzes > 0
                        ? Math.round(studentResults.reduce((sum, r) => sum + (r.score / r.total_questions * 100), 0) / quizzes)
                        : 0;
                    
                    // Balanced Ranking Score Formula:
                    // (Average Score % √ó 0.5) + (Total Points √ó 0.3) + (Quiz Count √ó 20 √ó 0.2)
                    const rankingScore = Math.round((avgScore * 0.5) + (points * 0.3) + (quizzes * 20 * 0.2));

                    return {
                        ...student,
                        points,
                        quizzes,
                        avgScore,
                        rankingScore
                    };
                }).filter(s => s.quizzes > 0 || timeFilter === 'all')
                  .sort((a, b) => b.rankingScore - a.rankingScore)
                  .slice(0, 50);

                console.log('üèÜ Leaderboard data:', leaderboard);

                if (leaderboard.length === 0) {
                    document.getElementById('leaderboardBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--gray);">No quiz activity in this time period</td></tr>';
                    return;
                }

                // Render leaderboard
                document.getElementById('leaderboardBody').innerHTML = leaderboard.map((student, i) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = i < 3 ? medals[i] : '';
                    const isCurrentUser = student.id === currentUser.id;

                    return `
                        <tr style="${isCurrentUser ? 'background:#f0fdf4;font-weight:500;' : ''}">
                            <td><span style="font-weight:600;${i < 3 ? 'color:var(--warning);font-size:18px;' : ''}">${medal || (i + 1)}</span></td>
                            <td>${student.name}${isCurrentUser ? ' <span style="color:var(--success);">(You)</span>' : ''}</td>
                            <td><strong style="color:var(--primary);">${student.rankingScore}</strong></td>
                            <td>${student.points}</td>
                            <td>${student.quizzes}</td>
                            <td><span style="color:${student.avgScore >= 70 ? 'var(--success)' : student.avgScore >= 50 ? 'var(--warning)' : 'var(--danger)'};">${student.avgScore}%</span></td>
                        </tr>
                    `;
                }).join('');

                console.log('‚úÖ Leaderboard loaded:', leaderboard.length, 'students');
            } catch (error) {
                console.error('‚ùå Error loading leaderboard:', error);
                document.getElementById('leaderboardBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--danger);">Error loading leaderboard</td></tr>';
            }
        }

        // Load quiz-specific leaderboard
        async function loadQuizLeaderboard(topic, difficulty) {
            console.log('üèÜ Loading quiz leaderboard for:', topic, difficulty);

            document.getElementById('quizLeaderboardTitle').textContent = `${topic} - ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`;
            document.getElementById('quizLeaderboardModal').style.display = 'flex';

            try {
                const { data: results, error } = await supabaseClient.from('quiz_results')
                    .select('*, users!inner(name)')
                    .eq('topic', topic)
                    .eq('difficulty', difficulty)
                    .order('score', { ascending: false });

                if (error) throw error;

                if (!results || results.length === 0) {
                    document.getElementById('quizLeaderboardBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--gray);">No one has taken this quiz yet</td></tr>';
                    return;
                }

                // Sort by score DESC, then time ASC (faster time breaks ties)
                results.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return (a.time_taken || 999999) - (b.time_taken || 999999);
                });

                const top20 = results.slice(0, 20);

                document.getElementById('quizLeaderboardBody').innerHTML = top20.map((r, i) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = i < 3 ? medals[i] : '';
                    const isCurrentUser = r.user_id === currentUser.id;

                    return `
                        <tr style="${isCurrentUser ? 'background:#f0fdf4;font-weight:500;' : ''}">
                            <td><span style="font-weight:600;${i < 3 ? 'color:var(--warning);font-size:18px;' : ''}">${medal || (i + 1)}</span></td>
                            <td>${r.users?.name || 'Unknown'}${isCurrentUser ? ' <span style="color:var(--success);">(You)</span>' : ''}</td>
                            <td><span style="color:var(--success);font-weight:600;">${r.score}/${r.total_questions}</span></td>
                            <td>${formatTime(r.time_taken || 0)}</td>
                            <td>${formatDate(r.created_at)}</td>
                        </tr>
                    `;
                }).join('');

                console.log('‚úÖ Quiz leaderboard loaded:', top20.length, 'entries');
            } catch (error) {
                console.error('‚ùå Error loading quiz leaderboard:', error);
                document.getElementById('quizLeaderboardBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--danger);">Error loading leaderboard</td></tr>';
            }
        }

        // ========================================
        // CHARTS
        // ========================================
        function initCharts() {
            // Score Trend Chart
            const ctx1 = document.getElementById('scoreTrendChart')?.getContext('2d');
            if (ctx1) {
                charts.scoreTrend = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: ['Quiz 1', 'Quiz 2', 'Quiz 3', 'Quiz 4', 'Quiz 5'],
                        datasets: [{
                            label: 'Score %',
                            data: [0, 0, 0, 0, 0],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }
            
            // Accuracy Chart
            const ctx2 = document.getElementById('accuracyChart')?.getContext('2d');
            if (ctx2) {
                charts.accuracy = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['Easy', 'Medium', 'Hard'],
                        datasets: [{
                            label: 'Accuracy %',
                            data: [75, 60, 45],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            }
            
            // Time Chart
            const ctx3 = document.getElementById('timeChart')?.getContext('2d');
            if (ctx3) {
                charts.time = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['Easy', 'Medium', 'Hard'],
                        datasets: [{
                            label: 'Avg Time (sec)',
                            data: [45, 60, 90],
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // ========================================
        // NAVIGATION
        // ========================================
        function showPage(pageId, event) {
            // Check feature lockout for expired users
            const lockedFeatures = ['performance', 'topics', 'leaderboard'];
            if (lockedFeatures.includes(pageId) && !hasFeatureAccess('analytics')) {
                showUpgradeModal('feature_locked');
                return;
            }

            document.querySelectorAll('#studentApp .page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('#studentApp .nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(pageId + 'Page').classList.add('active');
            if (event && event.target) event.target.classList.add('active');

            // Load data for specific pages
            if (pageId === 'performance') {
                updateBlockFilter();
                loadEnhancedAnalytics();
            }
            if (pageId === 'topics') loadStudentTopicsAnalysis();
            if (pageId === 'leaderboard') loadLeaderboard('all');
            if (pageId === 'history') loadQuizHistory();
            if (pageId === 'pricing') loadPricingPageData();
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
        }

        // ========================================
        // IMAGE HANDLING
        // ========================================
        function setupImageUpload() {
            const zone = document.getElementById('imageUploadZone');
            const input = document.getElementById('imageInput');
            
            zone?.addEventListener('click', (e) => {
                if (!e.target.closest('.remove-btn')) input?.click();
            });
            
            input?.addEventListener('change', (e) => handleFiles(Array.from(e.target.files), false));
            
            // Paste handler
            document.addEventListener('paste', async (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;
                
                const files = [];
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.startsWith('image/')) {
                        files.push(items[i].getAsFile());
                    }
                }
                
                if (files.length > 0) {
                    e.preventDefault();
                    handleFiles(files, false);
                }
            });
        }

        async function handleFiles(files, isTutor) {
            const images = isTutor ? tutorUploadedImages : uploadedImages;
            const grid = document.getElementById(isTutor ? 'tutorImagePreviewGrid' : 'imagePreviewGrid');
            const zone = document.getElementById(isTutor ? 'tutorImageUploadZone' : 'imageUploadZone');
            
            for (const file of files) {
                if (images.length >= 5) { showToast('Maximum 5 images', 'error'); break; }
                if (!file.type.startsWith('image/')) continue;
                
                showLoading('Compressing...');
                const compressed = await compressImage(file);
                hideLoading();
                
                images.push(compressed);
                
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `
                    <img src="${compressed}" alt="Preview">
                    <button class="remove-btn" onclick="removeImage(${images.length - 1}, ${isTutor})">&times;</button>
                `;
                grid.appendChild(item);
            }
            
            if (images.length > 0) zone.classList.add('has-image');
            showToast(`${files.length} image(s) added`, 'success');
            
            // Auto-save image state for recovery
            if (!isTutor && images.length > 0) {
                saveImageState();
            }
        }

        function removeImage(index, isTutor) {
            const images = isTutor ? tutorUploadedImages : uploadedImages;
            const grid = document.getElementById(isTutor ? 'tutorImagePreviewGrid' : 'imagePreviewGrid');
            const zone = document.getElementById(isTutor ? 'tutorImageUploadZone' : 'imageUploadZone');
            
            images.splice(index, 1);
            grid.innerHTML = '';
            images.forEach((img, i) => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `<img src="${img}"><button class="remove-btn" onclick="removeImage(${i}, ${isTutor})">&times;</button>`;
                grid.appendChild(item);
            });
            
            if (images.length === 0) zone.classList.remove('has-image');
        }

        // ========================================
        // QUIZ
        // ========================================
        // ========================================
        // SUBJECT & CHAPTER HELPERS
        // ========================================
        function toggleTutorOtherSubject() {
            const subject = document.getElementById('tutorQuizSubject').value;
            const otherGroup = document.getElementById('tutorOtherSubjectGroup');
            if (subject === 'Other') {
                otherGroup.style.display = 'block';
            } else {
                otherGroup.style.display = 'none';
            }
        }
        
        function getTutorSubject() {
            const subject = document.getElementById('tutorQuizSubject').value;
            if (subject === 'Other') {
                return document.getElementById('tutorOtherSubject').value.trim() || 'General';
            }
            return subject;
        }
        
        function toggleOtherSubject() {
            const subject = document.getElementById('quizSubject').value;
            const otherGroup = document.getElementById('otherSubjectGroup');
            const chapterGroup = document.getElementById('chapterGroup');
            
            if (subject === 'Other') {
                otherGroup.style.display = 'block';
                chapterGroup.classList.remove('form-group');
                chapterGroup.style.marginTop = '15px';
            } else {
                otherGroup.style.display = 'none';
            }
            
            updateQuizTitlePreview();
        }
        
        function updateQuizTitlePreview() {
            const subject = document.getElementById('quizSubject').value;
            const otherSubject = document.getElementById('otherSubjectInput')?.value || '';
            const chapter = document.getElementById('quizChapter')?.value || '';
            const difficulty = document.getElementById('quizDifficulty')?.value || 'medium';
            
            const finalSubject = subject === 'Other' ? otherSubject : subject;
            
            let preview = 'Select subject and enter chapter name...';
            if (finalSubject && chapter) {
                preview = `${chapter} - ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} (${finalSubject})`;
            } else if (chapter) {
                preview = `${chapter} - ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`;
            }
            
            document.getElementById('quizTitlePreview').textContent = preview;
            document.getElementById('quizTitlePreview').style.color = (finalSubject && chapter) ? 'var(--primary)' : 'var(--gray)';
        }
        
        // Add event listeners for live preview
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('quizChapter')?.addEventListener('input', updateQuizTitlePreview);
            document.getElementById('quizDifficulty')?.addEventListener('change', updateQuizTitlePreview);
            document.getElementById('otherSubjectInput')?.addEventListener('input', updateQuizTitlePreview);
        });
        
        function getQuizMetadata() {
            const subject = document.getElementById('quizSubject').value;
            const otherSubject = document.getElementById('otherSubjectInput')?.value || '';
            const chapter = document.getElementById('quizChapter')?.value?.trim() || '';
            const difficulty = document.getElementById('quizDifficulty').value;
            
            const finalSubject = subject === 'Other' ? otherSubject : subject;
            const title = chapter ? `${chapter} - ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}` : `Quiz - ${difficulty}`;
            
            return {
                subject: finalSubject,
                chapter: chapter,
                topic: chapter || 'General', // Use chapter as topic
                title: title,
                difficulty: difficulty
            };
        }
        
        function validateQuizSetup(requireImages = false) {
            const subject = document.getElementById('quizSubject').value;
            const otherSubject = document.getElementById('otherSubjectInput')?.value?.trim();
            const chapter = document.getElementById('quizChapter')?.value?.trim();
            
            if (!subject) {
                showToast('Please select a subject', 'error');
                return false;
            }
            
            if (subject === 'Other' && !otherSubject) {
                showToast('Please enter the subject name', 'error');
                return false;
            }
            
            if (!chapter) {
                showToast('Please enter the chapter/topic name', 'error');
                return false;
            }
            
            if (requireImages && uploadedImages.length === 0) {
                showToast('Please add images first', 'error');
                return false;
            }
            
            return true;
        }
        
        // ========================================
        // IMAGE STORAGE (Supabase)
        // ========================================
        async function uploadImagesToSupabase(images) {
            const uploadedUrls = [];
            
            for (let i = 0; i < images.length; i++) {
                try {
                    // Convert base64 to blob
                    const base64Data = images[i].split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let j = 0; j < byteCharacters.length; j++) {
                        byteNumbers[j] = byteCharacters.charCodeAt(j);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'image/jpeg' });
                    
                    // Generate unique filename
                    const filename = `quiz-images/${currentUser.id}/${Date.now()}_${i}.jpg`;
                    
                    // Upload to Supabase storage
                    const { data, error } = await supabaseClient.storage
                        .from('quiz-images')
                        .upload(filename, blob, { contentType: 'image/jpeg' });
                    
                    if (error) {
                        console.error('Image upload error:', error);
                        // If bucket doesn't exist or permission error, just save base64 reference
                        uploadedUrls.push({ type: 'base64', index: i });
                    } else {
                        // Get public URL
                        const { data: urlData } = supabaseClient.storage.from('quiz-images').getPublicUrl(filename);
                        uploadedUrls.push({ type: 'url', url: urlData.publicUrl });
                    }
                } catch (e) {
                    console.error('Error uploading image:', e);
                    uploadedUrls.push({ type: 'base64', index: i });
                }
            }
            
            return uploadedUrls;
        }

        async function startQuizFromImages() {
            if (!validateQuizSetup(true)) return;

            // Check quiz creation limits
            const limitCheck = canCreateQuiz();
            if (!limitCheck.canCreate) {
                showUpgradeModal(limitCheck.reason);
                return;
            }

            // ========================================
            // CRITICAL: Clear previous quiz state before generating new quiz
            // ========================================
            console.log('üßπ CLEARING PREVIOUS QUIZ STATE (startQuizFromImages)');
            console.log('Previous currentQuiz length:', currentQuiz.length);
            console.log('Previous metadata:', window.currentQuizMetadata);

            currentQuiz = [];
            currentQuestionIndex = 0;
            quizScore = 0;
            window.currentQuizMetadata = null;
            window.currentQuizImageRefs = [];

            console.log('‚úÖ State cleared, starting fresh quiz generation');
            // ========================================

            const metadata = getQuizMetadata();
            const count = document.getElementById('quizCount').value;

            showLoading('Generating quiz from images...');

            try {
                // Upload images to storage (optional - continues even if fails)
                let imageRefs = [];
                try {
                    imageRefs = await uploadImagesToSupabase(uploadedImages);
                    console.log('Images uploaded:', imageRefs);
                } catch (e) {
                    console.log('Image storage skipped:', e);
                }

                // Store image refs for saving with quiz result
                window.currentQuizImageRefs = imageRefs;
                window.currentQuizMetadata = metadata;

                console.log('üìù NEW QUIZ METADATA SET:', metadata);
                
                // Build content array for vision model
                const contentParts = [];
                
                // Add images
                for (const img of uploadedImages) {
                    contentParts.push({
                        type: 'image_url',
                        image_url: { url: img }
                    });
                }
                
                // Get blocks for the subject
                const blocks = getBlocksForSubject(metadata.subject);
                const blocksPrompt = blocks.length > 1
                    ? `Also classify each question into one of these blocks based on the content: ${blocks.join(', ')}`
                    : '';

                // FIX #3: Enhanced difficulty for image-based quizzes
                let difficultyPrompt = metadata.difficulty === 'hard'
                    ? 'HARD MODE: Questions must require multi-step reasoning, have no obvious answers, test edge cases, and all 4 options must be plausible.'
                    : metadata.difficulty === 'easy'
                    ? 'EASY MODE: Simple recall questions with one clearly correct answer.'
                    : 'MEDIUM MODE: Application-based questions requiring understanding.';

                // Add text prompt
                contentParts.push({
                    type: 'text',
                    text: `Create ${count} MCQ questions at ${metadata.difficulty.toUpperCase()} difficulty from these images about "${metadata.chapter}" (Subject: ${metadata.subject}).

${difficultyPrompt}

${blocksPrompt}

Provide detailed explanations for each answer.

Return ONLY JSON: [{"question":"Q","options":["A","B","C","D"],"correct":0,"explanation":"Detailed explanation","block":"${blocks[0] || 'General'}"}]

The "block" field should be one of: ${blocks.join(', ')}`
                });

                // Try vision model (Llama 4 Scout supports vision)
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'meta-llama/llama-4-scout-17b-16e-instruct',
                        messages: [{ role: 'user', content: contentParts }],
                        temperature: 0.7,
                        max_tokens: 4000
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                let content2 = data.choices[0].message.content;
                content2 = content2.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();

                // Try to extract JSON array
                const match = content2.match(/\[[\s\S]*\]/);
                if (match) content2 = match[0];

                // Fix common JSON issues
                content2 = content2.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
                content2 = content2.replace(/'/g, '"');
                content2 = content2.replace(/(\w+):/g, '"$1":');
                content2 = content2.replace(/""(\w+)"":/g, '"$1":');

                try {
                    currentQuiz = JSON.parse(content2);

                    console.log('========================================');
                    console.log('‚úÖ CURRENTQUIZ UPDATED (IMAGE-BASED)!');
                    console.log('========================================');
                    console.log('üìä NEW quiz array length:', currentQuiz.length);
                    console.log('üìä NEW quiz first question:', currentQuiz[0]?.question);
                    console.log('üìä NEW quiz topic:', metadata.chapter);
                    console.log('========================================');

                    // Ensure each question has a block
                    currentQuiz.forEach(q => {
                        if (!q.block || !blocks.includes(q.block)) {
                            q.block = blocks[0] || 'General';
                        }
                    });
                } catch (parseError) {
                    console.error('JSON parse error, trying to fix...', parseError);
                    // Try a more aggressive fix
                    const jsonMatch = content2.match(/\[\s*\{[\s\S]*\}\s*\]/);
                    if (jsonMatch) {
                        currentQuiz = JSON.parse(jsonMatch[0]);
                        // Ensure each question has a block
                        currentQuiz.forEach(q => {
                            if (!q.block || !blocks.includes(q.block)) {
                                q.block = blocks[0] || 'General';
                            }
                        });
                    } else {
                        throw new Error('Could not parse quiz data from AI response');
                    }
                }
                
                hideLoading();
                startQuizUI();
                
            } catch (error) {
                hideLoading();
                showToast('Failed to generate quiz: ' + error.message, 'error');
            }
        }

        async function startQuizFromTopic() {
            if (!validateQuizSetup(false)) return;

            // Check quiz creation limits
            const limitCheck = canCreateQuiz();
            if (!limitCheck.canCreate) {
                showUpgradeModal(limitCheck.reason);
                return;
            }

            // ========================================
            // CRITICAL: Clear previous quiz state before generating new quiz
            // ========================================
            console.log('üßπ CLEARING PREVIOUS QUIZ STATE (startQuizFromTopic)');
            console.log('Previous currentQuiz length:', currentQuiz.length);
            console.log('Previous metadata:', window.currentQuizMetadata);

            currentQuiz = [];
            currentQuestionIndex = 0;
            quizScore = 0;
            window.currentQuizMetadata = null;
            window.currentQuizImageRefs = [];

            console.log('‚úÖ State cleared, starting fresh quiz generation');
            // ========================================

            const metadata = getQuizMetadata();
            const count = document.getElementById('quizCount').value;

            // Store metadata for saving
            window.currentQuizMetadata = metadata;
            window.currentQuizImageRefs = [];

            console.log('üìù NEW QUIZ METADATA SET:', metadata);

            showLoading(`Generating quiz about "${metadata.chapter}"...`);

            try {
                // Get blocks for the subject
                const blocks = getBlocksForSubject(metadata.subject);
                const blocksPrompt = blocks.length > 1
                    ? `Also classify each question into one of these blocks based on the content: ${blocks.join(', ')}`
                    : '';

                // FIX #3: DIFFICULTY-SPECIFIC PROMPTS - HARD IS NOW ACTUALLY HARD
                let difficultyPrompt = '';

                if (metadata.difficulty === 'easy') {
                    difficultyPrompt = `EASY DIFFICULTY: Create simple questions testing basic recall and definitions.
                    - One answer should be clearly correct
                    - Questions should be straightforward
                    - Test fundamental concepts only`;
                } else if (metadata.difficulty === 'medium') {
                    difficultyPrompt = `MEDIUM DIFFICULTY: Create questions requiring understanding and application.
                    - Questions should require thinking, not just memorization
                    - Include some scenario-based questions
                    - Distractors should be plausible but distinguishable`;
                } else if (metadata.difficulty === 'hard') {
                    difficultyPrompt = `HARD/EXPERT DIFFICULTY - MAKE THESE GENUINELY CHALLENGING:

                    REQUIREMENTS:
                    1. MULTI-STEP REASONING: Every question MUST require 2-3 logical steps to solve
                    2. NO OBVIOUS ANSWERS: All 4 options must seem plausible to non-experts
                    3. EDGE CASES: Test exceptions, boundary conditions, and unusual scenarios
                    4. CONCEPT INTEGRATION: Combine 2-3 related concepts that are often confused
                    5. TRICKY DISTRACTORS: Wrong answers should represent common misconceptions
                    6. ANALYSIS REQUIRED: Use "which is LEAST likely", "what is the SECONDARY effect", "which would NOT apply when..."
                    7. EXPERT KNOWLEDGE: Include nuances only someone who deeply understands the topic would know

                    QUESTION STYLES TO USE:
                    - "If X occurs while Y is true, what would be the effect on Z?"
                    - "Which of the following is an EXCEPTION to the rule that...?"
                    - "A student claims [misconception]. Why is this incorrect?"
                    - "Which scenario would LEAST likely result in...?"
                    - "What is the SECONDARY consequence of...?"

                    TARGET: A well-prepared student should score 40-60%. These should challenge experts.`;
                }

                console.log('========================================');
                console.log('ü§ñ QUIZ GENERATION - GROQ API CALL');
                console.log('========================================');
                console.log('Topic:', metadata.chapter);
                console.log('Subject:', metadata.subject);
                console.log('Difficulty:', metadata.difficulty);
                console.log('Question Count:', count);
                console.log('GROQ API Key:', GROQ_API_KEY ? `‚úÖ SET (${GROQ_API_KEY.substring(0, 15)}...)` : '‚ùå NOT SET');

                // Check if API key is configured
                if (!GROQ_API_KEY || GROQ_API_KEY === 'YOUR_GROQ_API_KEY') {
                    console.error('‚ùå GROQ API KEY NOT CONFIGURED');
                    throw new Error('GROQ API key is not configured. Please set it in browser console:\nlocalStorage.setItem("GROQ_API_KEY", "gsk_your_key_here")');
                }

                console.log('üì° Sending request to GROQ API...');
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [{
                            role: 'user',
                            content: `Create ${count} multiple choice questions about "${metadata.chapter}" (Subject: ${metadata.subject}).

${difficultyPrompt}

${blocksPrompt}

FOR EACH QUESTION provide a detailed explanation that:
1. States the correct answer clearly
2. Explains WHY it's correct
3. Explains why each wrong option is incorrect

Return ONLY a valid JSON array in this exact format:
[{"question":"Question text here","options":["Option A","Option B","Option C","Option D"],"correct":0,"explanation":"Detailed explanation here","block":"${blocks[0] || 'General'}"}]

The "correct" field is the index (0-3) of the correct option.
The "block" field should be one of: ${blocks.join(', ')}`
                        }],
                        temperature: metadata.difficulty === 'hard' ? 0.8 : 0.7,
                        max_tokens: 4000
                    })
                });

                console.log('üì• Response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API ERROR RESPONSE:', errorText);
                    throw new Error(`GROQ API error (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('üì¶ Full API Response:', data);

                if (data.error) {
                    console.error('‚ùå API returned error:', data.error);
                    throw new Error(data.error.message || 'GROQ API error');
                }

                if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                    console.error('‚ùå Invalid API response structure:', data);
                    throw new Error('Invalid response structure from GROQ API');
                }

                let content = data.choices[0].message.content;
                console.log('üìù Raw AI Response (first 500 chars):', content.substring(0, 500));
                console.log('üìù Raw AI Response (full):', content);

                // Clean up the response
                content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
                const match = content.match(/\[[\s\S]*\]/);
                if (match) {
                    content = match[0];
                    console.log('‚úÖ Extracted JSON array from response');
                } else {
                    console.warn('‚ö†Ô∏è Could not find JSON array in response, using full content');
                }

                // Fix common JSON issues
                content = content.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
                console.log('üîß Cleaned content (first 500 chars):', content.substring(0, 500));

                try {
                    console.log('üîÑ Attempting to parse JSON...');
                    currentQuiz = JSON.parse(content);
                    console.log('========================================');
                    console.log('‚úÖ CURRENTQUIZ UPDATED WITH NEW DATA!');
                    console.log('========================================');
                    console.log('üìä NEW quiz array length:', currentQuiz.length);
                    console.log('üìä NEW quiz first question:', currentQuiz[0].question);
                    console.log('üìä NEW quiz topic:', metadata.chapter);
                    console.log('üìä Full new quiz data:', JSON.stringify(currentQuiz).substring(0, 200) + '...');
                    console.log('========================================');

                    // Validate quiz structure
                    if (!Array.isArray(currentQuiz)) {
                        throw new Error('Parsed content is not an array');
                    }

                    if (currentQuiz.length === 0) {
                        throw new Error('Parsed array is empty');
                    }

                    // Validate first question structure
                    const firstQ = currentQuiz[0];
                    if (!firstQ.question || !firstQ.options || !Array.isArray(firstQ.options)) {
                        console.error('‚ùå Invalid question structure:', firstQ);
                        throw new Error('Invalid question structure - missing required fields');
                    }

                    // Ensure each question has a block
                    currentQuiz.forEach((q, index) => {
                        if (!q.block || !blocks.includes(q.block)) {
                            q.block = blocks[0] || 'General';
                            console.log(`Fixed block for question ${index + 1}:`, q.block);
                        }
                    });

                    console.log('‚úÖ Quiz validation passed!');
                    console.log('========================================');
                } catch (parseError) {
                    console.error('========================================');
                    console.error('‚ùå JSON PARSING FAILED');
                    console.error('========================================');
                    console.error('Parse Error:', parseError.message);
                    console.error('Error Stack:', parseError.stack);
                    console.error('---');
                    console.error('Content we tried to parse:');
                    console.error(content);
                    console.error('---');
                    console.error('Expected format:');
                    console.error('[{"question":"...", "options":["A","B","C","D"], "correct":0, "explanation":"...", "block":"..."}]');
                    console.error('========================================');
                    throw new Error(`AI returned invalid quiz format. ${parseError.message}\n\nCheck browser console (F12) for details.`);
                }

                hideLoading();
                startQuizUI();

            } catch (error) {
                hideLoading();
                showToast('Failed: ' + error.message, 'error');
            }
        }

        function startQuizUI() {
            document.getElementById('quizSetupCard').style.display = 'none';
            document.getElementById('activeQuizArea').style.display = 'block';

            currentQuestionIndex = 0;
            quizScore = 0;
            quizTimeRemaining = 720;
            quizStartTime = Date.now();
            questionTimes = [];

            // Reset lifeline counters for new quiz
            lifelinesUsed = 0;
            const tierConfig = getUserTierConfig();
            lifelinesAvailable = tierConfig.features.lifelines || 0;

            // Clear saved image state since quiz has started
            clearImageState();

            startTimer();
            showCurrentQuestion();
        }

        function startTimer() {
            const timerEl = document.getElementById('quizTimer');
            quizTimer = setInterval(() => {
                quizTimeRemaining--;
                timerEl.textContent = '‚è±Ô∏è ' + formatTime(quizTimeRemaining);
                
                if (quizTimeRemaining <= 60) timerEl.className = 'quiz-timer danger';
                else if (quizTimeRemaining <= 180) timerEl.className = 'quiz-timer warning';
                
                if (quizTimeRemaining <= 0) {
                    clearInterval(quizTimer);
                    endQuiz();
                }
            }, 1000);
        }

        function showCurrentQuestion() {
            if (currentQuestionIndex >= currentQuiz.length) {
                endQuiz();
                return;
            }
            
            const q = currentQuiz[currentQuestionIndex];
            const progress = ((currentQuestionIndex) / currentQuiz.length) * 100;
            
            document.getElementById('quizProgressFill').style.width = progress + '%';
            document.getElementById('quizProgressText').textContent = `Question ${currentQuestionIndex + 1} of ${currentQuiz.length}`;
            document.getElementById('quizScoreDisplay').textContent = `Score: ${quizScore}`;
            
            document.getElementById('questionNumber').textContent = `Question ${currentQuestionIndex + 1}`;
            document.getElementById('questionText').innerHTML = q.question;
            
            document.getElementById('optionsList').innerHTML = q.options.map((opt, i) => `
                <div class="option-item" onclick="selectOption(${i})">
                    <div class="option-letter">${String.fromCharCode(65 + i)}</div>
                    <div>${opt}</div>
                </div>
            `).join('');
            
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('skipBtn').style.display = 'block';
            
            questionTimes.push(Date.now());
            
            // Save quiz state for resume functionality
            saveQuizState();
            
            // Render math equations if KaTeX is available
            try {
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(document.getElementById('questionCard'), {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }
            } catch (e) {
                console.log('KaTeX rendering skipped');
            }

            // Show/hide lifeline button based on user tier and usage
            updateLifelineButton();
        }

        // ========================================
        // LIFELINE FUNCTIONS
        // ========================================

        function updateLifelineButton() {
            const container = document.getElementById('lifelineContainer');
            const btn = document.getElementById('fiftyFiftyBtn');
            const countSpan = document.getElementById('lifelineCount');

            // Check if user has access to lifelines
            const tierConfig = getUserTierConfig();
            const maxLifelines = tierConfig.features.lifelines || 0;

            if (maxLifelines === 0 || currentUser.subscription_tier === 'free') {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            const remaining = maxLifelines - lifelinesUsed;
            countSpan.textContent = `(${remaining} left)`;

            if (remaining <= 0) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            } else {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        }

        async function useFiftyFifty() {
            const tierConfig = getUserTierConfig();
            const maxLifelines = tierConfig.features.lifelines || 0;

            // Check if lifelines are available
            if (lifelinesUsed >= maxLifelines) {
                showToast('No lifelines remaining!', 'error');
                return;
            }

            // Check if already answered
            const q = currentQuiz[currentQuestionIndex];
            if (q.userAnswer !== undefined) {
                showToast('Already answered this question!', 'error');
                return;
            }

            // Check if already used on this question
            if (q.lifelineUsed) {
                showToast('Already used lifeline on this question!', 'error');
                return;
            }

            // Eliminate 2 wrong answers
            const correctIdx = q.correct;
            const wrongIndices = [0, 1, 2, 3].filter(i => i !== correctIdx);

            // Randomly keep one wrong answer
            const keepIdx = wrongIndices[Math.floor(Math.random() * wrongIndices.length)];
            const eliminateIndices = wrongIndices.filter(i => i !== keepIdx);

            // Hide eliminated options
            const options = document.querySelectorAll('.option-item');
            eliminateIndices.forEach(idx => {
                options[idx].style.opacity = '0.3';
                options[idx].style.pointerEvents = 'none';
                options[idx].style.textDecoration = 'line-through';
            });

            // Mark lifeline as used
            lifelinesUsed++;
            q.lifelineUsed = true;

            // Save lifeline usage to database
            if (currentQuizId) {
                try {
                    await supabaseClient.from('lifeline_usage').insert({
                        user_id: currentUser.id,
                        quiz_id: currentQuizId,
                        lifeline_type: 'fifty_fifty',
                        question_index: currentQuestionIndex
                    });
                } catch (e) {
                    console.error('Error saving lifeline usage:', e);
                }
            }

            updateLifelineButton();
            showToast('‚ö° 50/50 used! 2 wrong answers eliminated', 'success');
        }

        function selectOption(idx) {
            const q = currentQuiz[currentQuestionIndex];
            const options = document.querySelectorAll('.option-item');
            
            // Store user's answer for review
            q.userAnswer = idx;
            
            options.forEach((opt, i) => {
                opt.onclick = null;
                if (i === q.correct) opt.classList.add('correct');
                else if (i === idx) opt.classList.add('incorrect');
            });
            
            // FIX #4: Only show simple Correct/Incorrect - NO explanation during quiz
            if (idx === q.correct) {
                quizScore++;
                showToast('Correct! üéâ', 'success');
            } else {
                showToast('Incorrect ‚ùå', 'error');
            }
            
            document.getElementById('nextBtn').style.display = 'block';
            document.getElementById('skipBtn').style.display = 'none';
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showCurrentQuestion();
        }

        function skipQuestion() {
            currentQuestionIndex++;
            showCurrentQuestion();
        }

        async function endQuiz() {
            clearInterval(quizTimer);
            clearQuizState(); // Clear saved state since quiz is complete
            
            const timeTaken = Math.round((Date.now() - quizStartTime) / 1000);
            const pointsEarned = quizScore * 10;
            
            // Get metadata from stored values or form
            const metadata = window.currentQuizMetadata || getQuizMetadata();
            const imageRefs = window.currentQuizImageRefs || [];
            
            // Store user answers in quiz for review
            currentQuiz.forEach((q, i) => {
                if (q.userAnswer === undefined) q.userAnswer = -1;
            });
            
            document.getElementById('activeQuizArea').style.display = 'none';
            document.getElementById('quizResultsArea').style.display = 'block';
            
            // Pre-select current difficulty and question count for retake
            if (metadata.difficulty) {
                document.getElementById('retakeDifficulty').value = metadata.difficulty;
            }
            document.getElementById('retakeCount').value = currentQuiz.length.toString();
            
            const percent = Math.round(quizScore / currentQuiz.length * 100);
            document.getElementById('resultScore').textContent = `${quizScore}/${currentQuiz.length}`;
            document.getElementById('resultPercentage').textContent = `${percent}%`;
            document.getElementById('resultCorrect').textContent = quizScore;
            document.getElementById('resultWrong').textContent = currentQuiz.length - quizScore;
            document.getElementById('resultTime').textContent = formatTime(timeTaken);
            document.getElementById('resultPoints').textContent = `+${pointsEarned}`;
            
            // FIX #1: ENHANCED DATABASE SAVING WITH COMPREHENSIVE ERROR LOGGING
            try {
                console.log('========================================');
                console.log('üíæ SAVING QUIZ RESULT TO DATABASE');
                console.log('========================================');
                console.log('User ID:', currentUser.id);
                console.log('Score:', quizScore, '/', currentQuiz.length);
                console.log('Topic:', metadata.topic || metadata.chapter);
                console.log('Subject:', metadata.subject);
                console.log('Difficulty:', metadata.difficulty);
                console.log('Time taken:', timeTaken, 'seconds');
                console.log('Points earned:', pointsEarned);
                console.log('üîë sharedQuizId:', metadata.sharedQuizId);
                console.log('üì¶ Full metadata:', metadata);
                console.log('---');
                console.log('üìù QUIZ QUESTIONS BEING SAVED:');
                console.log('  Total questions:', currentQuiz.length);
                console.log('  First question:', currentQuiz[0]?.question);
                console.log('  Last question:', currentQuiz[currentQuiz.length - 1]?.question);
                console.log('  Questions preview:', JSON.stringify(currentQuiz.map(q => q.question)).substring(0, 200) + '...');
                console.log('========================================');

                const quizData = {
                    user_id: currentUser.id,
                    score: quizScore,
                    total_questions: currentQuiz.length,
                    subject: metadata.subject || 'General',
                    topic: metadata.topic || metadata.chapter || 'General',
                    difficulty: metadata.difficulty || 'medium',
                    time_taken: timeTaken,
                    points_earned: pointsEarned,
                    questions: currentQuiz,
                    image_refs: imageRefs.length > 0 ? imageRefs : null,
                    image_urls: uploadedImageUrls.length > 0 ? uploadedImageUrls : null,
                    shared_quiz_id: metadata.sharedQuizId || null
                };
                
                console.log('üìù Quiz data to insert:', quizData);
                
                const { data: insertedResult, error: insertError } = await supabaseClient.from('quiz_results')
                    .insert([quizData])
                    .select();
                
                if (insertError) {
                    console.error('‚ùå DATABASE INSERT ERROR:', insertError);
                    showToast('Error saving quiz: ' + insertError.message, 'error');
                } else {
                    console.log('‚úÖ QUIZ SAVED SUCCESSFULLY:', insertedResult);
                    showToast('Quiz saved!', 'success');

                    // Store quiz ID for lifeline tracking
                    if (insertedResult && insertedResult[0]) {
                        currentQuizId = insertedResult[0].id;
                    }

                    // Increment quiz creation counters (wrapped in try-catch to not break flow)
                    try {
                        await incrementQuizCounters();
                    } catch (counterError) {
                        console.warn('‚ö†Ô∏è Failed to update quiz counters:', counterError);
                    }

                    // Update streak (wrapped in try-catch)
                    try {
                        await updateStreak();
                    } catch (streakError) {
                        console.warn('‚ö†Ô∏è Failed to update streak:', streakError);
                    }

                    // Update daily challenges (wrapped in try-catch)
                    try {
                        await updateDailyChallengeProgress({
                            score: quizScore,
                            total: currentQuiz.length,
                            time: timeTaken
                        });
                    } catch (challengeError) {
                        console.warn('‚ö†Ô∏è Failed to update daily challenges:', challengeError);
                    }

                    // Check for new milestones (wrapped in try-catch)
                    try {
                        await checkAndAwardMilestones();
                    } catch (milestoneError) {
                        console.warn('‚ö†Ô∏è Failed to check milestones:', milestoneError);
                    }
                }
                
                const newPoints = (currentUser.points || 0) + pointsEarned;
                const newAttempts = (currentUser.quiz_attempts || 0) + 1;
                
                const { error: updateError } = await supabaseClient.from('users').update({ 
                    points: newPoints, 
                    quiz_attempts: newAttempts 
                }).eq('id', currentUser.id);
                
                if (updateError) {
                    console.error('‚ùå Error updating user:', updateError);
                } else {
                    console.log('‚úÖ User stats updated');
                    currentUser.points = newPoints;
                    currentUser.quiz_attempts = newAttempts;
                    document.getElementById('totalPoints').textContent = newPoints;
                }
                
                console.log('========================================');
                
            } catch (e) {
                console.error('‚ùå Exception saving quiz:', e);
                showToast('Error saving quiz results', 'error');
            }
            
            // Don't clear metadata yet - needed for share and retake
        }

        // Retake quiz with same images but fresh questions
        async function retakeQuizWithOptions() {
            console.log('üîÑ Retaking quiz with new options');
            const difficulty = document.getElementById('retakeDifficulty').value;
            const count = document.getElementById('retakeCount').value;
            const metadata = window.currentQuizMetadata || getQuizMetadata();

            console.log('Retake settings:', { difficulty, count, uploadedImages: uploadedImages.length });

            // Update metadata with new settings
            metadata.difficulty = difficulty;
            window.currentQuizMetadata = metadata;

            showLoading(`Generating ${count} ${difficulty} questions...`);

            try {
                // If we have base64 images, use vision model
                if (uploadedImages.length > 0) {
                    console.log('‚úÖ Using', uploadedImages.length, 'uploaded images for retake');
                    const contentParts = [];
                    
                    for (const img of uploadedImages) {
                        contentParts.push({
                            type: 'image_url',
                            image_url: { url: img }
                        });
                    }
                    
                    let difficultyPrompt = difficulty === 'hard' 
                        ? 'HARD MODE: Questions must require multi-step reasoning, have no obvious answers, test edge cases.'
                        : difficulty === 'easy'
                        ? 'EASY MODE: Simple recall questions with one clearly correct answer.'
                        : 'MEDIUM MODE: Application-based questions requiring understanding.';
                    
                    contentParts.push({
                        type: 'text',
                        text: `Create ${count} NEW and DIFFERENT MCQ questions at ${difficulty.toUpperCase()} difficulty from these images about "${metadata.chapter || metadata.topic}" (Subject: ${metadata.subject}).

${difficultyPrompt}

Make these questions DIFFERENT from previous ones. Provide detailed explanations.

Return ONLY JSON: [{"question":"Q","options":["A","B","C","D"],"correct":0,"explanation":"Detailed explanation"}]`
                    });
                    
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'meta-llama/llama-4-scout-17b-16e-instruct',
                            messages: [{ role: 'user', content: contentParts }],
                            temperature: 0.9,
                            max_tokens: 4000
                        })
                    });
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    let content = data.choices[0].message.content;
                    content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
                    const match = content.match(/\[[\s\S]*\]/);
                    if (match) content = match[0];
                    content = content.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
                    
                    currentQuiz = JSON.parse(content);
                    
                } else {
                    // No images - use topic-based generation
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'llama-3.3-70b-versatile',
                            messages: [{ 
                                role: 'user', 
                                content: `Create ${count} NEW multiple choice questions about "${metadata.chapter || metadata.topic}" (Subject: ${metadata.subject}) at ${difficulty.toUpperCase()} difficulty.

${difficulty === 'hard' ? 'HARD: Multi-step reasoning, tricky options, no obvious answers.' : difficulty === 'easy' ? 'EASY: Simple recall, clear correct answer.' : 'MEDIUM: Application-based, requires understanding.'}

Return ONLY JSON: [{"question":"Q","options":["A","B","C","D"],"correct":0,"explanation":"Why this is correct"}]`
                            }],
                            temperature: 0.9,
                            max_tokens: 4000
                        })
                    });
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    let content = data.choices[0].message.content;
                    content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
                    const match = content.match(/\[[\s\S]*\]/);
                    if (match) content = match[0];
                    
                    currentQuiz = JSON.parse(content);
                }
                
                hideLoading();
                startQuizUI();
                showToast(`${count} ${difficulty} questions generated!`, 'success');
                
            } catch (error) {
                hideLoading();
                showToast('Failed: ' + error.message, 'error');
            }
        }

        async function retakeQuizWithSameImages() {
            if (uploadedImageUrls.length === 0 && uploadedImages.length === 0) {
                showToast('No images to regenerate from', 'error');
                resetQuiz();
                return;
            }
            
            const metadata = window.currentQuizMetadata || getQuizMetadata();
            const count = currentQuiz.length || 10;
            
            showLoading('Generating fresh questions from same images...');
            
            try {
                // If we have stored URLs, use those
                if (uploadedImageUrls.length > 0) {
                    // Generate new questions using the topic
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'llama-3.3-70b-versatile',
                            messages: [{ 
                                role: 'user', 
                                content: `Create ${count} NEW and DIFFERENT multiple choice questions about "${metadata.topic}" (Subject: ${metadata.subject}) at ${metadata.difficulty} difficulty. Make these questions different from typical questions - focus on different aspects of the topic.
                                
Return ONLY JSON: [{"question":"Q","options":["A","B","C","D"],"correct":0,"explanation":"Why"}]`
                            }],
                            temperature: 0.9, // Higher temperature for more variety
                            max_tokens: 4000
                        })
                    });
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    let content = data.choices[0].message.content;
                    content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
                    const match = content.match(/\[[\s\S]*\]/);
                    if (match) content = match[0];
                    
                    currentQuiz = JSON.parse(content);
                    hideLoading();
                    startQuizUI();
                    showToast('Fresh quiz generated!', 'success');
                    
                } else {
                    // Fall back to using base64 images
                    hideLoading();
                    showToast('Regenerating with original images...', 'info');
                    await startQuizFromImages();
                }
                
            } catch (error) {
                hideLoading();
                showToast('Failed: ' + error.message, 'error');
            }
        }

        function resetQuiz() {
            document.getElementById('quizSetupCard').style.display = 'block';
            document.getElementById('activeQuizArea').style.display = 'none';
            document.getElementById('quizResultsArea').style.display = 'none';
            
            currentQuiz = [];
            currentQuestionIndex = 0;
            quizScore = 0;
            uploadedImages = [];
            
            // Reset form fields
            document.getElementById('imagePreviewGrid').innerHTML = '';
            document.getElementById('imageUploadZone').classList.remove('has-image');
            document.getElementById('quizSubject').value = '';
            document.getElementById('quizChapter').value = '';
            document.getElementById('otherSubjectInput').value = '';
            document.getElementById('otherSubjectGroup').style.display = 'none';
            document.getElementById('quizTitlePreview').textContent = 'Select subject and enter chapter name...';
            document.getElementById('quizTitlePreview').style.color = 'var(--gray)';
            document.getElementById('quizTopic').value = '';
            document.getElementById('quizTimer').className = 'quiz-timer';
            
            loadStudentStats();
            loadQuizHistory();
        }

        // FIX #5 & #6: Explanations shown ONLY here via Review button, with better format
        function reviewQuiz() {
            console.log('========================================');
            console.log('üìñ REVIEWING QUIZ - SHOWING EXPLANATIONS');
            console.log('========================================');
            console.log('currentQuiz length:', currentQuiz.length);
            console.log('First question in review:', currentQuiz[0]?.question);
            console.log('Last question in review:', currentQuiz[currentQuiz.length - 1]?.question);
            console.log('Metadata:', window.currentQuizMetadata);
            console.log('========================================');

            const container = document.getElementById('quizResultsArea');

            const reviewHtml = currentQuiz.map((q, i) => {
                const userAnswer = q.userAnswer;
                const isCorrect = userAnswer === q.correct;
                const wasSkipped = userAnswer === undefined || userAnswer === -1;
                
                // Get letter representations
                const correctLetter = String.fromCharCode(65 + q.correct);
                const correctText = q.options[q.correct];
                const userLetter = (!wasSkipped && userAnswer >= 0) ? String.fromCharCode(65 + userAnswer) : 'None';
                const userText = (!wasSkipped && userAnswer >= 0) ? q.options[userAnswer] : 'Skipped';
                
                // FIX #6: Better explanation format
                let explanationBox = `
                    <div style="margin-top:15px;padding:20px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:12px;border-left:4px solid #4f46e5;">
                        <div style="color:#065f46;font-weight:600;font-size:15px;margin-bottom:10px;">
                            ‚úÖ Correct Answer: (${correctLetter}) ${correctText}
                        </div>
                `;
                
                if (isCorrect) {
                    explanationBox += `<div style="color:#065f46;margin-bottom:10px;">üéâ You got this right!</div>`;
                } else {
                    explanationBox += `
                        <div style="color:#991b1b;margin-bottom:10px;">
                            ‚ùå You selected: (${userLetter}) ${userText}
                        </div>
                    `;
                }
                
                if (q.explanation) {
                    explanationBox += `
                        <div style="border-top:1px solid #bfdbfe;padding-top:12px;margin-top:10px;color:#1f2937;line-height:1.6;">
                            <strong style="color:#4f46e5;">üìñ Explanation:</strong><br>
                            ${q.explanation}
                        </div>
                    `;
                }
                
                explanationBox += '</div>';
                
                const statusColor = isCorrect ? '#10b981' : '#ef4444';
                const statusText = isCorrect ? '‚úì Correct' : wasSkipped ? '‚äò Skipped' : '‚úó Incorrect';
                
                return `
                    <div class="question-card" style="margin-bottom:20px;border-left:4px solid ${statusColor};">
                        <div class="question-number" style="color:${statusColor};font-weight:600;">
                            Question ${i + 1} ‚Äî ${statusText}
                        </div>
                        <div class="question-text" style="margin:15px 0;">${q.question}</div>
                        <div class="options-list">
                            ${q.options.map((opt, j) => {
                                let optStyle = '';
                                let indicator = '';
                                
                                if (j === q.correct) {
                                    optStyle = 'background:#d1fae5;border-color:#10b981;';
                                    indicator = '<span style="margin-left:auto;color:#065f46;font-weight:600;">‚úì Correct</span>';
                                } else if (j === userAnswer && !isCorrect && !wasSkipped) {
                                    optStyle = 'background:#fee2e2;border-color:#ef4444;';
                                    indicator = '<span style="margin-left:auto;color:#991b1b;font-weight:600;">‚úó Your answer</span>';
                                }
                                
                                return `
                                    <div class="option-item" style="cursor:default;${optStyle}">
                                        <div class="option-letter">${String.fromCharCode(65 + j)}</div>
                                        <span>${opt}</span>
                                        ${indicator}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${explanationBox}
                    </div>
                `;
            }).join('');
            
            const percent = Math.round(quizScore / currentQuiz.length * 100);
            const scoreColor = percent >= 70 ? '#10b981' : percent >= 50 ? '#f59e0b' : '#ef4444';
            
            container.innerHTML = `
                <div class="quiz-container">
                    <div class="card">
                        <div class="card-header" style="border-bottom:2px solid #e5e7eb;padding-bottom:20px;margin-bottom:20px;">
                            <div class="card-title" style="font-size:1.3rem;">üìñ Review Your Answers</div>
                            <div style="text-align:right;">
                                <div style="font-size:2.5rem;font-weight:700;color:${scoreColor};">${quizScore}/${currentQuiz.length}</div>
                                <div style="color:#6b7280;">Score: ${percent}%</div>
                            </div>
                        </div>
                        ${reviewHtml}
                        <div style="display:flex;gap:15px;margin-top:25px;padding-top:20px;border-top:2px solid #e5e7eb;">
                            <button class="btn btn-success" style="flex:1;" onclick="resetQuiz()">üöÄ Take Another Quiz</button>
                            <button class="btn btn-secondary" style="flex:1;" onclick="showPage('dashboard'); resetQuiz();">üìä Go to Dashboard</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========================================
        // TUTOR FUNCTIONS
        // ========================================
        let tutorGeneratedQuiz = [];
        let currentBatchId = null;
        let currentStudentId = null;
        let allStudentsData = [];
        
        async function loadTutorStats() {
            const { data: batches } = await supabaseClient.from('batches').select('*').eq('tutor_id', currentUser.id);
            document.getElementById('tutorStatBatches').textContent = batches?.length || 0;
            
            // Load batch dropdowns (quiz creation, assign, and leaderboard)
            const select = document.getElementById('tutorQuizBatch');
            const assignSelect = document.getElementById('assignBatchSelect');
            const dashboardBatchSelect = document.getElementById('dashboardBatchSelect');
            
            if (batches && batches.length > 0) {
                const options = '<option value="">Select Batch</option>' + 
                    batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
                if (select) select.innerHTML = options;
                if (assignSelect) assignSelect.innerHTML = options;
                if (dashboardBatchSelect) dashboardBatchSelect.innerHTML = options;
            }
            
            // Count students
            const { data: batchStudents } = await supabaseClient.from('batch_students').select('*');
            const tutorBatchIds = batches?.map(b => b.id) || [];
            const studentCount = batchStudents?.filter(bs => tutorBatchIds.includes(bs.batch_id)).length || 0;
            document.getElementById('tutorStatStudents').textContent = studentCount;
            
            // Count saved quizzes
            const { data: quizzes } = await supabaseClient.from('saved_quizzes').select('*').eq('tutor_id', currentUser.id);
            document.getElementById('tutorStatQuizzes').textContent = quizzes?.length || 0;
            
            // Avg student score
            const { data: results } = await supabaseClient.from('quiz_results').select('*');
            if (results && results.length > 0) {
                const avgScore = Math.round(results.reduce((a, r) => a + (r.score / r.total_questions * 100), 0) / results.length);
                document.getElementById('tutorStatAvgScore').textContent = avgScore + '%';
            }
            
            // Load recent activity
            loadTutorRecentActivity();
            
            // Load batch performance chart
            loadBatchPerformanceChart(batches, batchStudents);
        }
        
        async function loadBatchPerformanceChart(batches, batchStudents) {
            if (!batches || batches.length === 0) return;
            
            const batchData = await Promise.all(batches.map(async batch => {
                const studentsInBatch = batchStudents?.filter(bs => bs.batch_id === batch.id) || [];
                const studentIds = studentsInBatch.map(bs => bs.student_id);
                
                if (studentIds.length === 0) return { name: batch.name, avg: 0 };
                
                const { data: results } = await supabaseClient.from('quiz_results')
                    .select('*')
                    .in('user_id', studentIds);
                
                const avg = results && results.length > 0
                    ? Math.round(results.reduce((a, r) => a + (r.score / r.total_questions * 100), 0) / results.length)
                    : 0;
                
                return { name: batch.name, avg };
            }));
            
            const ctx = document.getElementById('batchPerformanceChart');
            if (!ctx) return;
            
            if (charts.batchPerformance) charts.batchPerformance.destroy();
            
            charts.batchPerformance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: batchData.map(b => b.name),
                    datasets: [{
                        label: 'Avg Score %',
                        data: batchData.map(b => b.avg),
                        backgroundColor: batchData.map(b => 
                            b.avg >= 70 ? '#10b981' : b.avg >= 50 ? '#f59e0b' : '#ef4444'
                        ),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }
        
        async function loadBatchLeaderboard() {
            console.log('üìä Loading batch leaderboard...');
            const batchId = document.getElementById('dashboardBatchSelect')?.value;
            console.log('Selected batch ID:', batchId);
            
            if (!batchId) {
                document.getElementById('batchLeaderboardBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:30px;">Select a batch to view leaderboard</td></tr>';
                return;
            }
            
            // Get students in batch
            const { data: batchStudents, error: bsError } = await supabaseClient.from('batch_students')
                .select('*, users(*)')
                .eq('batch_id', batchId);
            
            console.log('Batch students:', batchStudents, 'Error:', bsError);
            
            if (!batchStudents || batchStudents.length === 0) {
                document.getElementById('batchLeaderboardBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:30px;">No students in this batch</td></tr>';
                return;
            }
            
            // Get quiz results for each student
            const leaderboardData = await Promise.all(batchStudents.map(async bs => {
                const { data: results } = await supabaseClient.from('quiz_results')
                    .select('*')
                    .eq('user_id', bs.student_id);
                
                const quizCount = results?.length || 0;
                const points = results?.reduce((sum, r) => sum + (r.points_earned || r.score * 10), 0) || 0;
                const avgScore = quizCount > 0 
                    ? Math.round(results.reduce((a, r) => a + (r.score / r.total_questions * 100), 0) / quizCount)
                    : 0;
                const bestScore = quizCount > 0
                    ? Math.max(...results.map(r => Math.round(r.score / r.total_questions * 100)))
                    : 0;
                
                // Balanced Ranking Score Formula
                const rankingScore = Math.round((avgScore * 0.5) + (points * 0.3) + (quizCount * 20 * 0.2));
                
                return {
                    name: bs.users?.name || 'Unknown',
                    points,
                    quizCount,
                    avgScore,
                    bestScore,
                    rankingScore,
                    id: bs.student_id
                };
            }));
            
            // Sort by ranking score
            leaderboardData.sort((a, b) => b.rankingScore - a.rankingScore);
            
            document.getElementById('batchLeaderboardBody').innerHTML = leaderboardData.map((s, i) => {
                const rankBg = i === 0 ? '#fef3c7' : i === 1 ? '#f3f4f6' : i === 2 ? '#fed7aa' : '#ffffff';
                const rankIcon = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1);
                
                return `
                    <tr style="cursor:pointer;" onclick="viewStudentDetails('${s.id}')">
                        <td><span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:${rankBg};border-radius:50%;font-weight:600;">${rankIcon}</span></td>
                        <td><strong>${s.name}</strong></td>
                        <td><strong style="color:var(--primary);">${s.rankingScore}</strong></td>
                        <td>${s.quizCount}</td>
                        <td><span class="badge ${s.avgScore >= 70 ? 'badge-success' : s.avgScore >= 50 ? 'badge-warning' : 'badge-danger'}">${s.avgScore}%</span></td>
                        <td><span class="badge badge-success">${s.bestScore}%</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadTutorRecentActivity() {
            const { data: results } = await supabaseClient.from('quiz_results')
                .select('*, users(name)')
                .order('created_at', { ascending: false })
                .limit(10);
            
            if (!results || results.length === 0) {
                document.getElementById('tutorRecentActivity').innerHTML = '<div class="empty-state" style="padding:20px;"><p>No student activity yet</p></div>';
                return;
            }
            
            const html = results.map(r => {
                const percent = Math.round(r.score / r.total_questions * 100);
                const scoreClass = percent >= 70 ? 'good' : percent >= 50 ? 'avg' : 'poor';
                return `
                    <div class="activity-item">
                        <div class="activity-icon cq">${r.users?.name?.charAt(0) || 'S'}</div>
                        <div class="activity-details">
                            <div class="activity-title">${r.users?.name || 'Student'}</div>
                            <div class="activity-meta">${r.topic || 'Quiz'} ‚Ä¢ ${formatDate(r.created_at)}</div>
                        </div>
                        <div class="activity-score ${scoreClass}">${percent}%</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('tutorRecentActivity').innerHTML = html;
        }

        async function loadBatches() {
            const { data: batches } = await supabaseClient.from('batches').select('*').eq('tutor_id', currentUser.id);
            
            if (!batches || batches.length === 0) {
                document.getElementById('batchesGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <h3>No batches yet</h3>
                        <p>Create your first batch to get started</p>
                    </div>
                `;
                return;
            }
            
            // Get student counts for each batch
            const { data: batchStudents } = await supabaseClient.from('batch_students').select('*');
            
            document.getElementById('batchesGrid').innerHTML = batches.map(b => {
                const studentCount = batchStudents?.filter(bs => bs.batch_id === b.id).length || 0;
                return `
                    <div class="card" style="cursor:pointer;" onclick="viewBatchDetails('${b.id}')">
                        <div class="card-title">${b.name}</div>
                        <p style="color:var(--gray);font-size:14px;margin:10px 0;">${b.description || 'No description'}</p>
                        <div style="display:flex;gap:20px;margin-top:15px;">
                            <div>
                                <div style="font-size:1.5rem;font-weight:700;color:var(--primary);">${studentCount}</div>
                                <div style="font-size:12px;color:var(--gray);">Students</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" style="width:100%;margin-top:15px;padding:10px;">View Details ‚Üí</button>
                    </div>
                `;
            }).join('');
        }

        function showCreateBatchModal() {
            document.getElementById('createBatchModal').classList.add('active');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
            }
        }

        // Open assign quiz modal
        async function openAssignQuizModal(quizId) {
            console.log('üìã Opening assign quiz modal for:', quizId);
            document.getElementById('assignQuizId').value = quizId;

            // Load batches for dropdown
            const { data: batches } = await supabaseClient.from('batches')
                .select('id, name')
                .eq('tutor_id', currentUser.id)
                .order('name');

            const select = document.getElementById('assignBatchSelect');
            select.innerHTML = '<option value="">Select a batch</option>' +
                (batches || []).map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            document.getElementById('assignDueDate').value = '';
            document.getElementById('assignInstructions').value = '';
            document.getElementById('assignQuizModal').style.display = 'flex';
        }

        async function createBatch(e) {
            e.preventDefault();
            
            const name = document.getElementById('batchName').value;
            const description = document.getElementById('batchDescription').value;
            
            const { error } = await supabaseClient.from('batches').insert([{
                name, description, tutor_id: currentUser.id
            }]);
            
            if (error) {
                showToast('Error creating batch: ' + error.message, 'error');
                return;
            }
            
            showToast('Batch created!', 'success');
            closeModal('createBatchModal');
            document.getElementById('batchName').value = '';
            document.getElementById('batchDescription').value = '';
            loadBatches();
            loadTutorStats();
        }
        
        async function viewBatchDetails(batchId) {
            currentBatchId = batchId;
            showTutorPage('batchDetail');
            
            const { data: batch } = await supabaseClient.from('batches').select('*').eq('id', batchId).single();
            document.getElementById('batchDetailTitle').textContent = batch?.name || 'Batch Details';
            
            // Load students in batch
            const { data: batchStudents } = await supabaseClient.from('batch_students')
                .select('*, users(*)')
                .eq('batch_id', batchId);
            
            document.getElementById('batchStudentCount').textContent = batchStudents?.length || 0;
            
            if (batchStudents && batchStudents.length > 0) {
                let totalScore = 0;
                let totalQuizzes = 0;
                
                const rows = await Promise.all(batchStudents.map(async bs => {
                    const { data: results } = await supabaseClient.from('quiz_results')
                        .select('*')
                        .eq('user_id', bs.student_id);
                    
                    const quizCount = results?.length || 0;
                    const avgScore = quizCount > 0 
                        ? Math.round(results.reduce((a, r) => a + (r.score / r.total_questions * 100), 0) / quizCount)
                        : 0;
                    
                    totalScore += avgScore;
                    totalQuizzes += quizCount;
                    
                    return `
                        <tr>
                            <td>${bs.users?.name || 'Unknown'}</td>
                            <td>${quizCount}</td>
                            <td><span class="badge ${avgScore >= 70 ? 'badge-success' : avgScore >= 50 ? 'badge-warning' : 'badge-danger'}">${avgScore}%</span></td>
                            <td>
                                <button class="btn btn-secondary" style="width:auto;padding:5px 10px;font-size:12px;" onclick="viewStudentDetails('${bs.student_id}')">View</button>
                                <button class="btn btn-secondary" style="width:auto;padding:5px 10px;font-size:12px;background:var(--danger);" onclick="removeStudentFromBatch('${bs.id}')">Remove</button>
                            </td>
                        </tr>
                    `;
                }));
                
                document.getElementById('batchStudentsBody').innerHTML = rows.join('');
                document.getElementById('batchAvgScore').textContent = batchStudents.length > 0 
                    ? Math.round(totalScore / batchStudents.length) + '%' 
                    : '0%';
            } else {
                document.getElementById('batchStudentsBody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--gray);padding:20px;">No students yet</td></tr>';
            }
            
            // Load assigned quizzes
            const { data: assignments } = await supabaseClient.from('quiz_assignments')
                .select('*, saved_quizzes(*)')
                .eq('batch_id', batchId);
            
            document.getElementById('batchQuizCount').textContent = assignments?.length || 0;
            
            if (assignments && assignments.length > 0) {
                document.getElementById('batchAssignedQuizzes').innerHTML = assignments.map(a => `
                    <div class="activity-item">
                        <div class="activity-icon topic">üìù</div>
                        <div class="activity-details">
                            <div class="activity-title">${a.saved_quizzes?.title || 'Quiz'}</div>
                            <div class="activity-meta">${a.deadline ? 'Due: ' + formatDate(a.deadline) : 'No deadline'}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('batchAssignedQuizzes').innerHTML = '<div class="empty-state" style="padding:20px;"><p>No quizzes assigned</p></div>';
            }
        }
        
        function showAddStudentModal() {
            document.getElementById('addStudentModal').classList.add('active');
        }
        
        async function addStudentToBatch(e) {
            e.preventDefault();
            const email = document.getElementById('addStudentEmail').value.trim().toLowerCase();
            
            // Find student by email
            const { data: student } = await supabaseClient.from('users').select('*').eq('email', email).single();
            
            if (!student) {
                showToast('Student not found. They must register first.', 'error');
                return;
            }
            
            if (student.role !== 'student') {
                showToast('This user is not a student', 'error');
                return;
            }
            
            // Check if already in batch
            const { data: existing } = await supabaseClient.from('batch_students')
                .select('*')
                .eq('batch_id', currentBatchId)
                .eq('student_id', student.id)
                .single();
            
            if (existing) {
                showToast('Student already in this batch', 'error');
                return;
            }
            
            const { error } = await supabaseClient.from('batch_students').insert([{
                batch_id: currentBatchId,
                student_id: student.id
            }]);
            
            if (error) {
                showToast('Error adding student: ' + error.message, 'error');
                return;
            }
            
            showToast('Student added!', 'success');
            closeModal('addStudentModal');
            document.getElementById('addStudentEmail').value = '';
            viewBatchDetails(currentBatchId);
        }
        
        async function bulkAddStudents() {
            const emails = document.getElementById('bulkStudentEmails').value
                .split('\n')
                .map(e => e.trim().toLowerCase())
                .filter(e => e);
            
            if (emails.length === 0) {
                showToast('Enter at least one email', 'error');
                return;
            }
            
            let added = 0;
            let failed = 0;
            
            for (const email of emails) {
                const { data: student } = await supabaseClient.from('users').select('*').eq('email', email).single();
                
                if (!student || student.role !== 'student') {
                    failed++;
                    continue;
                }
                
                const { data: existing } = await supabaseClient.from('batch_students')
                    .select('*')
                    .eq('batch_id', currentBatchId)
                    .eq('student_id', student.id)
                    .single();
                
                if (existing) {
                    failed++;
                    continue;
                }
                
                const { error } = await supabaseClient.from('batch_students').insert([{
                    batch_id: currentBatchId,
                    student_id: student.id
                }]);
                
                if (!error) added++;
                else failed++;
            }
            
            showToast(`Added ${added} students. ${failed} failed.`, added > 0 ? 'success' : 'error');
            document.getElementById('bulkStudentEmails').value = '';
            closeModal('addStudentModal');
            viewBatchDetails(currentBatchId);
        }
        
        async function removeStudentFromBatch(batchStudentId) {
            if (!confirm('Remove this student from the batch?')) return;
            
            await supabaseClient.from('batch_students').delete().eq('id', batchStudentId);
            showToast('Student removed', 'success');
            viewBatchDetails(currentBatchId);
        }

        // ========================================
        // TUTOR QUIZ CREATION
        // ========================================
        function setupTutorImageUpload() {
            const zone = document.getElementById('tutorImageUploadZone');
            const input = document.getElementById('tutorImageInput');
            
            if (!zone || !input) return;
            
            input.addEventListener('change', (e) => handleTutorImages(e.target.files));
            
            document.addEventListener('paste', (e) => {
                if (currentUser?.role !== 'tutor') return;
                const items = e.clipboardData?.items;
                if (!items) return;
                
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) handleTutorImages([file]);
                    }
                }
            });
        }
        
        async function handleTutorImages(files) {
            for (const file of files) {
                const compressed = await compressImage(file);
                tutorUploadedImages.push(compressed);
            }
            renderTutorImagePreviews();
            
            // Auto-save tutor image state for recovery
            if (tutorUploadedImages.length > 0) {
                saveTutorImageState();
            }
        }
        
        function renderTutorImagePreviews() {
            const grid = document.getElementById('tutorImagePreviewGrid');
            const zone = document.getElementById('tutorImageUploadZone');
            
            if (tutorUploadedImages.length > 0) {
                zone.classList.add('has-image');
                grid.innerHTML = tutorUploadedImages.map((img, i) => `
                    <div class="preview-item">
                        <img src="${img}" alt="Preview">
                        <button class="remove-btn" onclick="removeTutorImage(${i})">√ó</button>
                    </div>
                `).join('');
            } else {
                zone.classList.remove('has-image');
                grid.innerHTML = '';
            }
        }
        
        function removeTutorImage(index) {
            tutorUploadedImages.splice(index, 1);
            renderTutorImagePreviews();
        }
        
        async function generateQuizFromTopic(topic, difficulty, count, subject = 'General') {
            console.log('generateQuizFromTopic called:', { topic, difficulty, count, subject });

            let difficultyPrompt = '';
            if (difficulty === 'easy') {
                difficultyPrompt = 'EASY: Simple recall questions with one clearly correct answer.';
            } else if (difficulty === 'hard') {
                difficultyPrompt = 'HARD: Multi-step reasoning, tricky options, no obvious answers.';
            } else {
                difficultyPrompt = 'MEDIUM: Application-based questions requiring understanding.';
            }

            // Get blocks for the subject
            const blocks = getBlocksForSubject(subject);
            console.log('Blocks for subject:', blocks);
            const blocksPrompt = blocks.length > 1
                ? `Also classify each question into one of these blocks based on the content: ${blocks.join(', ')}`
                : '';

            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'llama-3.3-70b-versatile',
                    messages: [{ 
                        role: 'user', 
                        content: `Create ${count} multiple choice questions about "${topic}" (Subject: ${subject}) at ${difficulty.toUpperCase()} difficulty.

${difficultyPrompt}

${blocksPrompt}

For each question provide a detailed explanation.

Return ONLY a valid JSON array in this exact format:
[{"question":"Question text here","options":["Option A","Option B","Option C","Option D"],"correct":0,"explanation":"Detailed explanation here","block":"${blocks[0] || 'General'}"}]

The "correct" field is the index (0-3) of the correct option.
The "block" field should be one of: ${blocks.join(', ')}`
                    }],
                    temperature: 0.7,
                    max_tokens: 4000
                })
            });
            
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            let content = data.choices[0].message.content;
            content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
            const match = content.match(/\[[\s\S]*\]/);
            if (match) content = match[0];
            content = content.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
            
            const questions = JSON.parse(content);

            // Ensure each question has a block
            questions.forEach(q => {
                if (!q.block || !blocks.includes(q.block)) {
                    q.block = blocks[0] || 'General';
                }
            });

            console.log('generateQuizFromTopic returning:', questions.length, 'questions');
            return questions;
        }
        
        async function generateQuizFromImages(images, difficulty, count) {
            console.log('generateQuizFromImages called:', { imageCount: images.length, difficulty, count });

            const contentParts = [];

            for (const img of images) {
                contentParts.push({
                    type: 'image_url',
                    image_url: { url: img }
                });
            }

            let difficultyPrompt = '';
            if (difficulty === 'easy') {
                difficultyPrompt = 'EASY: Simple recall questions with one clearly correct answer.';
            } else if (difficulty === 'hard') {
                difficultyPrompt = 'HARD: Multi-step reasoning, tricky options, no obvious answers.';
            } else {
                difficultyPrompt = 'MEDIUM: Application-based questions requiring understanding.';
            }
            
            contentParts.push({
                type: 'text',
                text: `Create ${count} MCQ questions at ${difficulty.toUpperCase()} difficulty from these images.

${difficultyPrompt}

Provide detailed explanations for each answer.

Return ONLY JSON: [{"question":"Q","options":["A","B","C","D"],"correct":0,"explanation":"Detailed explanation"}]`
            });
            
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'meta-llama/llama-4-scout-17b-16e-instruct',
                    messages: [{ role: 'user', content: contentParts }],
                    temperature: 0.7,
                    max_tokens: 4000
                })
            });
            
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            let content = data.choices[0].message.content;
            content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
            const match = content.match(/\[[\s\S]*\]/);
            if (match) content = match[0];
            content = content.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');

            const questions = JSON.parse(content);
            console.log('generateQuizFromImages returning:', questions.length, 'questions');
            return questions;
        }

        async function generateTutorQuiz() {
            console.log('========================================');
            console.log('üöÄ generateTutorQuiz STARTED');
            console.log('========================================');

            // Check quiz creation limits
            const limitCheck = canCreateQuiz();
            if (!limitCheck.canCreate) {
                showUpgradeModal(limitCheck.reason);
                return;
            }

            try {
                const topicEl = document.getElementById('tutorQuizTopic');
                const difficultyEl = document.getElementById('tutorQuizDifficulty');
                const countEl = document.getElementById('tutorQuizCount');

                console.log('Elements found:', {
                    topicEl: !!topicEl,
                    difficultyEl: !!difficultyEl,
                    countEl: !!countEl
                });

                const topic = topicEl?.value?.trim() || '';
                const subject = typeof getTutorSubject === 'function' ? getTutorSubject() : 'General';
                const difficulty = difficultyEl?.value || 'medium';
                const count = parseInt(countEl?.value) || 10;

                console.log('Quiz params:', { topic, subject, difficulty, count });
                console.log('Images uploaded:', tutorUploadedImages?.length || 0);

                if ((!tutorUploadedImages || tutorUploadedImages.length === 0) && !topic) {
                    showToast('Upload an image or enter a topic', 'error');
                    return;
                }

                showLoading('Generating quiz with AI...');

                let questions;

                if (tutorUploadedImages && tutorUploadedImages.length > 0) {
                    console.log('üì∑ Generating from images...');
                    questions = await generateQuizFromImages(tutorUploadedImages, difficulty, count);
                } else {
                    console.log('üìù Generating from topic...');
                    questions = await generateQuizFromTopic(topic, difficulty, count, subject);
                }

                console.log('‚úÖ Generated questions:', questions?.length || 0);
                
                if (!questions || questions.length === 0) {
                    throw new Error('No questions generated');
                }
                
                tutorGeneratedQuiz = questions;
                renderTutorQuizPreview(questions);
                
                const actionsEl = document.getElementById('tutorQuizActions');
                if (actionsEl) {
                    actionsEl.style.display = 'block';
                }

                // Clear saved image state since quiz is generated
                if (typeof clearTutorImageState === 'function') {
                    clearTutorImageState();
                }

                hideLoading();
                showToast('Quiz generated! Review and save.', 'success');
                console.log('========================================');
                console.log('‚úÖ generateTutorQuiz COMPLETED');
                console.log('========================================');
            } catch (error) {
                console.error('‚ùå Error in generateTutorQuiz:', error);
                console.error('Stack:', error.stack);
                hideLoading();
                showToast('Error generating quiz: ' + error.message, 'error');
            }
        }
        
        function renderTutorQuizPreview(questions) {
            const container = document.getElementById('tutorQuizPreview');
            
            container.innerHTML = questions.map((q, i) => `
                <div style="margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #e5e7eb;">
                    <div style="font-weight:600;color:var(--primary);font-size:13px;margin-bottom:8px;">Question ${i + 1}</div>
                    <div style="margin-bottom:12px;">${q.question}</div>
                    <div style="display:grid;gap:6px;">
                        ${q.options.map((opt, j) => `
                            <div style="padding:8px 12px;background:${j === q.correct ? '#d1fae5' : '#f3f4f6'};border-radius:6px;font-size:14px;">
                                ${String.fromCharCode(65 + j)}. ${opt} ${j === q.correct ? '‚úì' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        async function saveTutorQuiz() {
            console.log('saveTutorQuiz called');
            const title = document.getElementById('tutorQuizTitle').value.trim() || 'Untitled Quiz';
            const topic = document.getElementById('tutorQuizTopic').value.trim() || title;
            const subject = getTutorSubject();
            const difficulty = document.getElementById('tutorQuizDifficulty').value;
            const batchId = document.getElementById('tutorQuizBatch').value;
            const deadline = document.getElementById('tutorQuizDeadline').value;

            console.log('Save quiz data:', {
                title, topic, subject, difficulty, batchId, deadline,
                questionCount: tutorGeneratedQuiz.length,
                tutorId: currentUser.id
            });

            showLoading('Saving quiz...');

            try {
                // Save quiz
                const { data: savedQuiz, error } = await supabaseClient.from('saved_quizzes').insert([{
                    tutor_id: currentUser.id,
                    title,
                    topic,
                    subject,
                    difficulty,
                    question_count: tutorGeneratedQuiz.length,
                    questions: tutorGeneratedQuiz
                }]).select().single();
                
                if (error) throw error;
                console.log('‚úÖ Quiz saved:', savedQuiz);
                
                // Assign to batch if selected
                if (batchId && savedQuiz) {
                    const { error: assignError } = await supabaseClient.from('quiz_assignments').insert([{
                        quiz_id: savedQuiz.id,
                        batch_id: batchId,
                        deadline: deadline || null
                    }]);
                    
                    if (assignError) {
                        console.error('‚ùå Error assigning quiz:', assignError);
                    } else {
                        console.log('‚úÖ Quiz assigned to batch:', batchId);
                    }
                }
                
                hideLoading();
                showToast('Quiz saved!', 'success');
                clearTutorQuiz();
                loadTutorStats();
                loadSavedQuizzes();
            } catch (error) {
                hideLoading();
                showToast('Error saving: ' + error.message, 'error');
            }
        }
        
        function clearTutorQuiz() {
            tutorGeneratedQuiz = [];
            tutorUploadedImages = [];
            document.getElementById('tutorQuizPreview').innerHTML = `
                <div class="empty-state">
                    <div class="icon">üìù</div>
                    <h3>Quiz Preview</h3>
                    <p>Generated questions will appear here</p>
                </div>
            `;
            document.getElementById('tutorQuizActions').style.display = 'none';
            document.getElementById('tutorImagePreviewGrid').innerHTML = '';
            document.getElementById('tutorImageUploadZone').classList.remove('has-image');
            document.getElementById('tutorQuizTitle').value = '';
            document.getElementById('tutorQuizTopic').value = '';
            document.getElementById('tutorQuizSubject').value = 'Mathematics';
            document.getElementById('tutorOtherSubjectGroup').style.display = 'none';
            document.getElementById('tutorQuizDeadline').value = '';
        }
        
        // ========================================
        // SAVED QUIZZES
        // ========================================
        let allQuizzesData = [];
        let currentQuizFilter = 'all';
        
        async function loadSavedQuizzes() {
            const { data: quizzes } = await supabaseClient.from('saved_quizzes')
                .select('*, quiz_assignments(id, batch_id, deadline, created_at, batches(name))')
                .eq('tutor_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            if (!quizzes || quizzes.length === 0) {
                document.getElementById('savedQuizzesBody').innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--gray);padding:40px;">No saved quizzes yet. Create your first quiz!</td></tr>';
                document.getElementById('quizUsageHistoryBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:30px;">No usage history yet</td></tr>';
                updateQuizLibraryStats([], []);
                return;
            }
            
            allQuizzesData = quizzes;
            
            // Calculate stats
            const totalQuizzes = quizzes.length;
            const assignedQuizzes = quizzes.filter(q => q.quiz_assignments && q.quiz_assignments.length > 0).length;
            const unassignedQuizzes = totalQuizzes - assignedQuizzes;
            const multiBatchQuizzes = quizzes.filter(q => q.quiz_assignments && q.quiz_assignments.length > 1).length;
            
            updateQuizLibraryStats(totalQuizzes, assignedQuizzes, unassignedQuizzes, multiBatchQuizzes);
            
            // Filter quizzes
            let filteredQuizzes = quizzes;
            if (currentQuizFilter === 'assigned') {
                filteredQuizzes = quizzes.filter(q => q.quiz_assignments && q.quiz_assignments.length > 0);
            } else if (currentQuizFilter === 'unassigned') {
                filteredQuizzes = quizzes.filter(q => !q.quiz_assignments || q.quiz_assignments.length === 0);
            }
            
            // Render quiz table
            document.getElementById('savedQuizzesBody').innerHTML = filteredQuizzes.length > 0 
                ? filteredQuizzes.map(q => {
                    const assignments = q.quiz_assignments || [];
                    const batchNames = assignments.map(a => a.batches?.name).filter(Boolean);
                    const batchDisplay = batchNames.length > 0 
                        ? (batchNames.length > 2 ? `${batchNames.slice(0,2).join(', ')} +${batchNames.length - 2}` : batchNames.join(', '))
                        : '-';
                    const timesUsed = assignments.length;
                    
                    return `
                        <tr class="quiz-row" data-title="${q.title.toLowerCase()}" data-topic="${(q.topic || '').toLowerCase()}">
                            <td><strong>${q.title}</strong></td>
                            <td>${q.topic || '-'}</td>
                            <td><span class="badge badge-${q.difficulty === 'hard' ? 'danger' : q.difficulty === 'medium' ? 'warning' : 'success'}">${q.difficulty}</span></td>
                            <td>${q.question_count}</td>
                            <td title="${batchNames.join(', ')}">${batchDisplay}</td>
                            <td><span class="badge ${timesUsed > 1 ? 'badge-success' : timesUsed === 1 ? 'badge-warning' : ''}">${timesUsed}</span></td>
                            <td>${formatDate(q.created_at)}</td>
                            <td>
                                <button class="btn btn-secondary" style="width:auto;padding:5px 10px;font-size:12px;" onclick="viewQuiz('${q.id}')">View</button>
                                <button class="btn btn-secondary" style="width:auto;padding:5px 10px;font-size:12px;background:var(--primary);" onclick="openAssignQuizModal('${q.id}')">üìã Assign</button>
                                <button class="btn btn-secondary" style="width:auto;padding:5px 10px;font-size:12px;background:var(--danger);" onclick="deleteQuiz('${q.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('')
                : '<tr><td colspan="8" style="text-align:center;color:var(--gray);padding:40px;">No quizzes match this filter</td></tr>';
            
            // Render usage history
            loadQuizUsageHistory(quizzes);
        }
        
        function updateQuizLibraryStats(total, assigned, unassigned, multiBatch) {
            document.getElementById('quizLibraryTotal').textContent = total || 0;
            document.getElementById('quizLibraryAssigned').textContent = assigned || 0;
            document.getElementById('quizLibraryUnassigned').textContent = unassigned || 0;
            document.getElementById('quizLibraryReused').textContent = multiBatch || 0;
        }
        
        async function loadQuizUsageHistory(quizzes) {
            // Flatten all assignments
            const allAssignments = [];
            quizzes.forEach(q => {
                (q.quiz_assignments || []).forEach(a => {
                    allAssignments.push({
                        quizId: q.id,
                        quizTitle: q.title,
                        batchId: a.batch_id,
                        batchName: a.batches?.name || 'Unknown',
                        assignedDate: a.created_at,
                        deadline: a.deadline
                    });
                });
            });
            
            if (allAssignments.length === 0) {
                document.getElementById('quizUsageHistoryBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:30px;">No usage history yet. Assign quizzes to batches to see history.</td></tr>';
                return;
            }
            
            // Sort by assigned date (newest first)
            allAssignments.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
            
            // Get completion stats for each assignment
            const historyRows = await Promise.all(allAssignments.slice(0, 20).map(async a => {
                // Get students in this batch
                const { data: batchStudents } = await supabaseClient.from('batch_students')
                    .select('student_id')
                    .eq('batch_id', a.batchId);
                
                const studentIds = batchStudents?.map(bs => bs.student_id) || [];
                const totalStudents = studentIds.length;
                
                // Get quiz results for these students (approximation - by topic match)
                let completedCount = 0;
                let avgScore = 0;
                
                if (studentIds.length > 0) {
                    const { data: quiz } = await supabaseClient.from('saved_quizzes').select('topic').eq('id', a.quizId).single();
                    if (quiz?.topic) {
                        const { data: results } = await supabaseClient.from('quiz_results')
                            .select('*')
                            .in('user_id', studentIds)
                            .eq('topic', quiz.topic);
                        
                        completedCount = results?.length || 0;
                        avgScore = completedCount > 0 
                            ? Math.round(results.reduce((acc, r) => acc + (r.score / r.total_questions * 100), 0) / completedCount)
                            : 0;
                    }
                }
                
                return `
                    <tr>
                        <td><strong>${a.quizTitle}</strong></td>
                        <td>${a.batchName}</td>
                        <td>${formatDate(a.assignedDate)}</td>
                        <td>${a.deadline ? formatDate(a.deadline) : '-'}</td>
                        <td>${completedCount}/${totalStudents}</td>
                        <td><span class="badge ${avgScore >= 70 ? 'badge-success' : avgScore >= 50 ? 'badge-warning' : avgScore > 0 ? 'badge-danger' : ''}">${avgScore > 0 ? avgScore + '%' : '-'}</span></td>
                    </tr>
                `;
            }));
            
            document.getElementById('quizUsageHistoryBody').innerHTML = historyRows.join('');
        }
        
        function filterQuizzes(filter, element) {
            currentQuizFilter = filter;
            
            // Update active tab
            document.querySelectorAll('#savedQuizzesPage .filter-tab').forEach(t => t.classList.remove('active'));
            if (element) element.classList.add('active');
            
            loadSavedQuizzes();
        }
        
        function searchQuizzes() {
            const query = document.getElementById('quizSearchInput')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#savedQuizzesBody .quiz-row');
            
            rows.forEach(row => {
                const title = row.dataset.title || '';
                const topic = row.dataset.topic || '';
                row.style.display = (title.includes(query) || topic.includes(query)) ? '' : 'none';
            });
        }
        
        async function viewQuiz(quizId) {
            const { data: quiz } = await supabaseClient.from('saved_quizzes').select('*').eq('id', quizId).single();
            
            if (!quiz) return;
            
            document.getElementById('viewQuizTitle').textContent = quiz.title;
            document.getElementById('viewQuizContent').innerHTML = quiz.questions.map((q, i) => `
                <div style="margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #e5e7eb;">
                    <div style="font-weight:600;color:var(--primary);font-size:13px;margin-bottom:8px;">Question ${i + 1}</div>
                    <div style="margin-bottom:12px;">${q.question}</div>
                    <div style="display:grid;gap:6px;">
                        ${q.options.map((opt, j) => `
                            <div style="padding:8px 12px;background:${j === q.correct ? '#d1fae5' : '#f3f4f6'};border-radius:6px;font-size:14px;">
                                ${String.fromCharCode(65 + j)}. ${opt} ${j === q.correct ? '‚úì' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('viewQuizModal').classList.add('active');
        }
        
        function showAssignModal(quizId) {
            document.getElementById('assignQuizId').value = quizId;
            document.getElementById('assignDeadline').value = '';
            document.getElementById('assignQuizModal').classList.add('active');
        }
        
        async function assignQuizToBatch(e) {
            e.preventDefault();
            console.log('üìù Assigning quiz to batch');

            const quizId = document.getElementById('assignQuizId').value;
            const batchId = document.getElementById('assignBatchSelect').value;
            const dueDate = document.getElementById('assignDueDate').value;
            const instructions = document.getElementById('assignInstructions').value;

            if (!batchId) {
                showToast('Please select a batch', 'error');
                return;
            }

            if (!dueDate) {
                showToast('Please select a due date', 'error');
                return;
            }

            try {
                // Check if already assigned to this batch
                const { data: existing } = await supabaseClient.from('quiz_assignments')
                    .select('*')
                    .eq('quiz_id', quizId)
                    .eq('batch_id', batchId)
                    .single();

                if (existing) {
                    showToast('Quiz already assigned to this batch', 'error');
                    return;
                }

                const { error } = await supabaseClient.from('quiz_assignments').insert([{
                    quiz_id: quizId,
                    batch_id: batchId,
                    tutor_id: currentUser.id,
                    deadline: dueDate,
                    instructions: instructions || null
                }]);

                if (error) throw error;

                showToast('Quiz assigned to batch!', 'success');
                closeModal('assignQuizModal');
                loadSavedQuizzes();
                console.log('‚úÖ Quiz assigned successfully');
            } catch (error) {
                console.error('‚ùå Error assigning quiz:', error);
                showToast('Error assigning quiz: ' + error.message, 'error');
            }
        }
        
        async function deleteQuiz(quizId) {
            if (!confirm('Delete this quiz? This cannot be undone.')) return;
            
            await supabaseClient.from('quiz_assignments').delete().eq('quiz_id', quizId);
            await supabaseClient.from('saved_quizzes').delete().eq('id', quizId);
            
            showToast('Quiz deleted', 'success');
            loadSavedQuizzes();
            loadTutorStats();
        }

        // ========================================
        // ALL STUDENTS (TUTOR VIEW)
        // ========================================
        async function loadAllStudents() {
            const { data: batches } = await supabaseClient.from('batches').select('*').eq('tutor_id', currentUser.id);
            const batchIds = batches?.map(b => b.id) || [];
            
            if (batchIds.length === 0) {
                document.getElementById('studentsTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--gray);padding:40px;">Create a batch first and add students</td></tr>';
                return;
            }
            
            const { data: batchStudents } = await supabaseClient.from('batch_students')
                .select('*, users(*), batches(name)')
                .in('batch_id', batchIds);
            
            if (!batchStudents || batchStudents.length === 0) {
                document.getElementById('studentsTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--gray);padding:40px;">No students yet. Add students to your batches.</td></tr>';
                return;
            }
            
            allStudentsData = batchStudents;
            
            const rows = await Promise.all(batchStudents.map(async bs => {
                const { data: results } = await supabaseClient.from('quiz_results')
                    .select('*')
                    .eq('user_id', bs.student_id);
                
                const quizCount = results?.length || 0;
                const avgScore = quizCount > 0 
                    ? Math.round(results.reduce((a, r) => a + (r.score / r.total_questions * 100), 0) / quizCount)
                    : 0;
                
                return `
                    <tr>
                        <td><strong>${bs.users?.name || 'Unknown'}</strong></td>
                        <td>${bs.users?.email || '-'}</td>
                        <td>${bs.batches?.name || '-'}</td>
                        <td>${quizCount}</td>
                        <td><span class="badge ${avgScore >= 70 ? 'badge-success' : avgScore >= 50 ? 'badge-warning' : 'badge-danger'}">${avgScore}%</span></td>
                        <td>${bs.users?.points || 0}</td>
                        <td>
                            <button class="btn btn-secondary" style="width:auto;padding:5px 10px;font-size:12px;" onclick="viewStudentDetails('${bs.student_id}')">View Details</button>
                        </td>
                    </tr>
                `;
            }));
            
            document.getElementById('studentsTableBody').innerHTML = rows.join('');
        }
        
        function searchStudents() {
            const query = document.getElementById('studentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }
        
        async function viewStudentDetails(studentId) {
            currentStudentId = studentId;
            showTutorPage('studentDetail');
            
            const { data: student } = await supabaseClient.from('users').select('*').eq('id', studentId).single();
            document.getElementById('studentDetailTitle').textContent = student?.name || 'Student Details';
            document.getElementById('studentPoints').textContent = student?.points || 0;
            document.getElementById('studentStreak').textContent = student?.streak || 0;
            
            const { data: results } = await supabaseClient.from('quiz_results')
                .select('*')
                .eq('user_id', studentId)
                .order('created_at', { ascending: false });
            
            const quizCount = results?.length || 0;
            const avgScore = quizCount > 0 
                ? Math.round(results.reduce((a, r) => a + (r.score / r.total_questions * 100), 0) / quizCount)
                : 0;
            
            document.getElementById('studentQuizCount').textContent = quizCount;
            document.getElementById('studentAvgScore').textContent = avgScore + '%';
            
            // Quiz history table
            if (results && results.length > 0) {
                document.getElementById('studentQuizHistoryBody').innerHTML = results.map(r => {
                    const percent = Math.round(r.score / r.total_questions * 100);
                    return `
                        <tr>
                            <td>${formatDate(r.created_at)}</td>
                            <td>${r.topic || 'Quiz'}</td>
                            <td><span class="badge badge-${r.difficulty === 'hard' ? 'danger' : r.difficulty === 'medium' ? 'warning' : 'success'}">${r.difficulty}</span></td>
                            <td><span class="badge ${percent >= 70 ? 'badge-success' : percent >= 50 ? 'badge-warning' : 'badge-danger'}">${r.score}/${r.total_questions} (${percent}%)</span></td>
                            <td>${formatTime(r.time_taken || 0)}</td>
                            <td>+${r.points_earned || 0}</td>
                        </tr>
                    `;
                }).join('');
                
                // Topic performance
                const topicStats = {};
                results.forEach(r => {
                    if (!r.topic) return;
                    if (!topicStats[r.topic]) topicStats[r.topic] = { total: 0, correct: 0 };
                    topicStats[r.topic].total += r.total_questions;
                    topicStats[r.topic].correct += r.score;
                });
                
                const topics = Object.entries(topicStats).map(([name, stats]) => ({
                    name,
                    accuracy: Math.round(stats.correct / stats.total * 100)
                })).sort((a, b) => b.accuracy - a.accuracy);
                
                document.getElementById('studentTopicPerformance').innerHTML = topics.map(t => `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-label">${t.name}</span>
                            <span class="progress-value">${t.accuracy}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${t.accuracy >= 70 ? 'green' : t.accuracy >= 50 ? 'yellow' : 'red'}" style="width:${t.accuracy}%"></div>
                        </div>
                    </div>
                `).join('') || '<div class="empty-state" style="padding:20px;"><p>No topic data yet</p></div>';
                
                // Trend chart
                initStudentTrendChart(results);
            } else {
                document.getElementById('studentQuizHistoryBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:20px;">No quizzes yet</td></tr>';
                document.getElementById('studentTopicPerformance').innerHTML = '<div class="empty-state" style="padding:20px;"><p>No data yet</p></div>';
            }
        }
        
        function initStudentTrendChart(results) {
            const ctx = document.getElementById('studentTrendChart');
            if (!ctx) return;
            
            if (charts.studentTrend) charts.studentTrend.destroy();
            
            const last10 = results.slice(0, 10).reverse();
            
            charts.studentTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last10.map((_, i) => `Quiz ${i + 1}`),
                    datasets: [{
                        label: 'Score %',
                        data: last10.map(r => Math.round(r.score / r.total_questions * 100)),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        // ========================================
        // TUTOR PAGE NAVIGATION
        // ========================================
        function showTutorPage(page) {
            document.querySelectorAll('#tutorApp .page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('#tutorApp .nav-item').forEach(n => n.classList.remove('active'));
            
            const pageEl = document.getElementById(page + 'Page');
            if (pageEl) pageEl.classList.add('active');
            
            // Highlight nav item
            const navItems = document.querySelectorAll('#tutorApp .nav-item');
            navItems.forEach(n => {
                if (n.textContent.toLowerCase().includes(page.replace('tutor', '').toLowerCase())) {
                    n.classList.add('active');
                }
            });
            
            // Load data for specific pages
            if (page === 'savedQuizzes') loadSavedQuizzes();
            if (page === 'batches') loadBatches();
            if (page === 'students') loadAllStudents();
            if (page === 'tutorDashboard') loadTutorStats();
            if (page === 'analytics') loadAnalytics();
        }
        
        // ========================================
        // QUICK WEAKNESS FINDER (Tutor)
        // ========================================
        function updateWeaknessBlocks() {
            const subject = document.getElementById('weaknessSubject')?.value;
            const blockSelect = document.getElementById('weaknessBlock');
            if (!blockSelect) return;
            
            blockSelect.innerHTML = '<option value="">All Blocks</option>';
            
            if (subject && SUBJECT_BLOCKS[subject]) {
                SUBJECT_BLOCKS[subject].forEach(block => {
                    blockSelect.innerHTML += `<option value="${block}">${block}</option>`;
                });
            }
        }
        
        async function findWeakStudents() {
            console.log('findWeakStudents called');
            const subject = document.getElementById('weaknessSubject')?.value;
            const block = document.getElementById('weaknessBlock')?.value;
            const threshold = parseInt(document.getElementById('weaknessThreshold')?.value || '60');

            console.log('Weakness finder params:', { subject, block, threshold });

            if (!subject) {
                showToast('Please select a subject', 'error');
                return;
            }

            showLoading('Finding students...');

            try {
                // Get all students in tutor's batches
                console.log('Step 1: Getting tutor batches for user:', currentUser.id);
                const { data: batches } = await supabaseClient.from('batches').select('id').eq('tutor_id', currentUser.id);
                console.log('Step 1 result: Batches found:', batches?.length || 0);
                if (!batches || batches.length === 0) {
                    hideLoading();
                    showToast('No batches found', 'error');
                    return;
                }

                const batchIds = batches.map(b => b.id);
                console.log('Batch IDs:', batchIds);

                // Get students in these batches
                console.log('Step 2: Getting students in batches');
                const { data: batchStudents } = await supabaseClient.from('batch_students')
                    .select('student_id')
                    .in('batch_id', batchIds);

                console.log('Step 2 result: Student entries found:', batchStudents?.length || 0);
                if (!batchStudents || batchStudents.length === 0) {
                    hideLoading();
                    showToast('No students found in batches', 'error');
                    return;
                }

                const studentIds = [...new Set(batchStudents.map(bs => bs.student_id))];
                console.log('Unique student IDs:', studentIds.length);

                // Get quiz results for these students in the selected subject
                console.log('Step 3: Getting quiz results for subject:', subject);
                const { data: results } = await supabaseClient.from('quiz_results')
                    .select('*')
                    .in('user_id', studentIds)
                    .eq('subject', subject);

                console.log('Step 3 result: Quiz results found:', results?.length || 0);

                // Get student names
                console.log('Step 4: Getting student details');
                const { data: students } = await supabaseClient.from('users')
                    .select('id, name, email')
                    .in('id', studentIds);

                console.log('Step 4 result: Students found:', students?.length || 0);
                
                const studentMap = {};
                students?.forEach(s => studentMap[s.id] = s);
                
                // Calculate per-student accuracy
                const studentStats = {};
                
                results?.forEach(r => {
                    // If block filter is set, we need to check questions
                    let matchingQuestions = r.total_questions;
                    let matchingCorrect = r.score;
                    
                    if (block && r.questions && Array.isArray(r.questions)) {
                        const blockQuestions = r.questions.filter(q => q.block === block);
                        matchingQuestions = blockQuestions.length;
                        matchingCorrect = blockQuestions.filter(q => q.userAnswer === q.correct).length;
                    }
                    
                    if (matchingQuestions > 0) {
                        if (!studentStats[r.user_id]) {
                            studentStats[r.user_id] = { total: 0, correct: 0 };
                        }
                        studentStats[r.user_id].total += matchingQuestions;
                        studentStats[r.user_id].correct += matchingCorrect;
                    }
                });
                
                // Find weak students
                const weakStudents = [];
                Object.entries(studentStats).forEach(([userId, stats]) => {
                    const accuracy = Math.round(stats.correct / stats.total * 100);
                    if (accuracy < threshold && studentMap[userId]) {
                        weakStudents.push({
                            ...studentMap[userId],
                            accuracy,
                            questions: stats.total
                        });
                    }
                });
                
                // Sort by accuracy (lowest first)
                weakStudents.sort((a, b) => a.accuracy - b.accuracy);
                
                hideLoading();
                
                // Display results
                const resultsDiv = document.getElementById('weakStudentsResults');
                const listDiv = document.getElementById('weakStudentsList');
                
                if (weakStudents.length === 0) {
                    resultsDiv.style.display = 'block';
                    listDiv.innerHTML = '<div style="color:#065f46;padding:10px;background:#d1fae5;border-radius:8px;">‚úÖ Great! No students below ' + threshold + '% in ' + subject + (block ? ' - ' + block : '') + '</div>';
                } else {
                    resultsDiv.style.display = 'block';
                    listDiv.innerHTML = weakStudents.map(s => `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:white;border-radius:8px;margin-bottom:8px;border:1px solid #fbbf24;">
                            <div>
                                <div style="font-weight:600;color:var(--dark);">${s.name}</div>
                                <div style="font-size:12px;color:var(--gray);">${s.questions} questions attempted</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:15px;">
                                <div style="font-weight:700;color:#dc2626;font-size:1.2rem;">${s.accuracy}%</div>
                                <button class="btn btn-secondary" onclick="viewStudentDetails('${s.id}')" style="padding:6px 12px;font-size:12px;">View</button>
                                <button class="btn" onclick="assignRemedialQuiz('${s.id}', '${subject}', '${block}')" style="padding:6px 12px;font-size:12px;">Assign Quiz</button>
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error finding weak students:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        function viewStudentDetails(studentId) {
            // TODO: Open student detail modal
            showToast('Student details coming soon!', 'info');
        }
        
        function assignRemedialQuiz(studentId, subject, block) {
            // TODO: Open assign quiz modal pre-filled with subject/block
            showToast('Remedial quiz assignment coming soon!', 'info');
        }
        
        // ========================================
        // ANALYTICS (Scholaranium-Style)
        // ========================================
        async function loadAnalytics() {
            const batchFilter = document.getElementById('analyticsBatchFilter')?.value || 'all';
            const timeFilter = document.getElementById('analyticsTimeFilter')?.value || '30';
            
            // Get tutor's batches
            const { data: batches } = await supabaseClient.from('batches').select('*').eq('tutor_id', currentUser.id);
            
            // Populate batch filter dropdown
            const batchSelect = document.getElementById('analyticsBatchFilter');
            if (batchSelect && batches) {
                batchSelect.innerHTML = '<option value="all">All Batches</option>' + 
                    batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            }
            
            // Get students in tutor's batches
            const batchIds = batches?.map(b => b.id) || [];
            if (batchIds.length === 0) {
                showEmptyAnalytics();
                return;
            }
            
            const { data: batchStudents } = await supabaseClient.from('batch_students')
                .select('*, users(*), batches(name)')
                .in('batch_id', batchFilter === 'all' ? batchIds : [batchFilter]);
            
            const studentIds = batchStudents?.map(bs => bs.student_id) || [];
            if (studentIds.length === 0) {
                showEmptyAnalytics();
                return;
            }
            
            // Build date filter
            let dateFilter = null;
            if (timeFilter !== 'all') {
                const days = parseInt(timeFilter);
                dateFilter = new Date();
                dateFilter.setDate(dateFilter.getDate() - days);
            }
            
            // Get quiz results
            let query = supabaseClient.from('quiz_results')
                .select('*, users(name)')
                .in('user_id', studentIds)
                .order('created_at', { ascending: false });
            
            if (dateFilter) {
                query = query.gte('created_at', dateFilter.toISOString());
            }
            
            const { data: results } = await query;
            
            if (!results || results.length === 0) {
                showEmptyAnalytics();
                return;
            }
            
            // Calculate summary stats
            const totalQuizzes = results.length;
            const avgAccuracy = Math.round(results.reduce((a, r) => a + (r.score / r.total_questions * 100), 0) / totalQuizzes);
            const avgTime = Math.round(results.reduce((a, r) => a + (r.time_taken || 0), 0) / totalQuizzes / 60);
            const activeStudents = [...new Set(results.map(r => r.user_id))].length;
            
            document.getElementById('analyticsQuizzesTaken').textContent = totalQuizzes;
            document.getElementById('analyticsAvgAccuracy').textContent = avgAccuracy + '%';
            document.getElementById('analyticsAvgTime').textContent = avgTime + 'm';
            document.getElementById('analyticsActiveStudents').textContent = activeStudents;
            
            // Accuracy by Difficulty
            renderAccuracyByDifficulty(results);
            
            // Time by Difficulty
            renderTimeByDifficulty(results);
            
            // Performance Trend
            renderPerformanceTrend(results);
            
            // Topic Analysis
            renderTopicAnalysis(results);
            
            // Struggling Students
            renderStrugglingStudents(results, batchStudents);
            
            // Top Performers
            renderTopPerformers(results, batchStudents);
        }
        
        function showEmptyAnalytics() {
            document.getElementById('analyticsQuizzesTaken').textContent = '0';
            document.getElementById('analyticsAvgAccuracy').textContent = '0%';
            document.getElementById('analyticsAvgTime').textContent = '0m';
            document.getElementById('analyticsActiveStudents').textContent = '0';
            document.getElementById('difficultyBreakdown').innerHTML = '<p style="color:var(--gray);text-align:center;">No data yet</p>';
            document.getElementById('timeBreakdown').innerHTML = '<p style="color:var(--gray);text-align:center;">No data yet</p>';
            document.getElementById('topicAnalysis').innerHTML = '<div class="empty-state" style="padding:20px;"><p>No topic data yet</p></div>';
            document.getElementById('strugglingStudents').innerHTML = '<div class="empty-state" style="padding:20px;"><p>No data yet</p></div>';
            document.getElementById('topPerformersBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--gray);padding:20px;">No data yet</td></tr>';
        }
        
        function renderAccuracyByDifficulty(results) {
            const byDifficulty = { easy: { total: 0, correct: 0, count: 0 }, medium: { total: 0, correct: 0, count: 0 }, hard: { total: 0, correct: 0, count: 0 } };
            
            results.forEach(r => {
                const diff = r.difficulty || 'medium';
                if (byDifficulty[diff]) {
                    byDifficulty[diff].total += r.total_questions;
                    byDifficulty[diff].correct += r.score;
                    byDifficulty[diff].count++;
                }
            });
            
            const easyAcc = byDifficulty.easy.total > 0 ? Math.round(byDifficulty.easy.correct / byDifficulty.easy.total * 100) : 0;
            const mediumAcc = byDifficulty.medium.total > 0 ? Math.round(byDifficulty.medium.correct / byDifficulty.medium.total * 100) : 0;
            const hardAcc = byDifficulty.hard.total > 0 ? Math.round(byDifficulty.hard.correct / byDifficulty.hard.total * 100) : 0;
            
            // Chart
            const ctx = document.getElementById('accuracyByDifficultyChart');
            if (charts.accuracyByDifficulty) charts.accuracyByDifficulty.destroy();
            
            charts.accuracyByDifficulty = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Easy', 'Medium', 'Hard'],
                    datasets: [{
                        label: 'Accuracy %',
                        data: [easyAcc, mediumAcc, hardAcc],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
            
            // Breakdown text
            document.getElementById('difficultyBreakdown').innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;">
                    <div style="padding:10px;background:#d1fae5;border-radius:8px;">
                        <div style="font-weight:700;color:#065f46;">${easyAcc}%</div>
                        <div style="font-size:12px;color:#065f46;">Easy (${byDifficulty.easy.count})</div>
                    </div>
                    <div style="padding:10px;background:#fef3c7;border-radius:8px;">
                        <div style="font-weight:700;color:#92400e;">${mediumAcc}%</div>
                        <div style="font-size:12px;color:#92400e;">Medium (${byDifficulty.medium.count})</div>
                    </div>
                    <div style="padding:10px;background:#fee2e2;border-radius:8px;">
                        <div style="font-weight:700;color:#991b1b;">${hardAcc}%</div>
                        <div style="font-size:12px;color:#991b1b;">Hard (${byDifficulty.hard.count})</div>
                    </div>
                </div>
            `;
        }
        
        function renderTimeByDifficulty(results) {
            const byDifficulty = { easy: { time: 0, count: 0 }, medium: { time: 0, count: 0 }, hard: { time: 0, count: 0 } };
            
            results.forEach(r => {
                const diff = r.difficulty || 'medium';
                if (byDifficulty[diff]) {
                    byDifficulty[diff].time += r.time_taken || 0;
                    byDifficulty[diff].count++;
                }
            });
            
            const easyTime = byDifficulty.easy.count > 0 ? Math.round(byDifficulty.easy.time / byDifficulty.easy.count / 60) : 0;
            const mediumTime = byDifficulty.medium.count > 0 ? Math.round(byDifficulty.medium.time / byDifficulty.medium.count / 60) : 0;
            const hardTime = byDifficulty.hard.count > 0 ? Math.round(byDifficulty.hard.time / byDifficulty.hard.count / 60) : 0;
            
            // Chart
            const ctx = document.getElementById('timeByDifficultyChart');
            if (charts.timeByDifficulty) charts.timeByDifficulty.destroy();
            
            charts.timeByDifficulty = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Easy', 'Medium', 'Hard'],
                    datasets: [{
                        label: 'Avg Time (min)',
                        data: [easyTime, mediumTime, hardTime],
                        backgroundColor: ['#60a5fa', '#a78bfa', '#f472b6'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            
            // Breakdown text
            document.getElementById('timeBreakdown').innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;">
                    <div style="padding:10px;background:#dbeafe;border-radius:8px;">
                        <div style="font-weight:700;color:#1e40af;">${easyTime}m</div>
                        <div style="font-size:12px;color:#1e40af;">Easy</div>
                    </div>
                    <div style="padding:10px;background:#ede9fe;border-radius:8px;">
                        <div style="font-weight:700;color:#5b21b6;">${mediumTime}m</div>
                        <div style="font-size:12px;color:#5b21b6;">Medium</div>
                    </div>
                    <div style="padding:10px;background:#fce7f3;border-radius:8px;">
                        <div style="font-weight:700;color:#9d174d;">${hardTime}m</div>
                        <div style="font-size:12px;color:#9d174d;">Hard</div>
                    </div>
                </div>
            `;
        }
        
        function renderPerformanceTrend(results) {
            // Group by date
            const byDate = {};
            results.forEach(r => {
                const date = new Date(r.created_at).toLocaleDateString();
                if (!byDate[date]) byDate[date] = { total: 0, correct: 0, count: 0 };
                byDate[date].total += r.total_questions;
                byDate[date].correct += r.score;
                byDate[date].count++;
            });
            
            const dates = Object.keys(byDate).reverse().slice(-14); // Last 14 days with data
            const accuracies = dates.map(d => Math.round(byDate[d].correct / byDate[d].total * 100));
            const counts = dates.map(d => byDate[d].count);
            
            const ctx = document.getElementById('performanceTrendChart');
            if (charts.performanceTrend) charts.performanceTrend.destroy();
            
            charts.performanceTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Accuracy %',
                            data: accuracies,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Quizzes',
                            data: counts,
                            borderColor: '#10b981',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { type: 'linear', position: 'left', beginAtZero: true, max: 100, title: { display: true, text: 'Accuracy %' } },
                        y1: { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Quiz Count' } }
                    }
                }
            });
        }
        
        function renderTopicAnalysis(results) {
            const topicStats = {};
            results.forEach(r => {
                const topic = r.topic || 'General';
                if (!topicStats[topic]) topicStats[topic] = { total: 0, correct: 0, time: 0, count: 0 };
                topicStats[topic].total += r.total_questions;
                topicStats[topic].correct += r.score;
                topicStats[topic].time += r.time_taken || 0;
                topicStats[topic].count++;
            });
            
            const topics = Object.entries(topicStats)
                .map(([name, stats]) => ({
                    name,
                    accuracy: Math.round(stats.correct / stats.total * 100),
                    avgTime: Math.round(stats.time / stats.count / 60),
                    count: stats.count
                }))
                .sort((a, b) => b.count - a.count);
            
            if (topics.length === 0) {
                document.getElementById('topicAnalysis').innerHTML = '<div class="empty-state" style="padding:20px;"><p>No topic data yet</p></div>';
                return;
            }
            
            document.getElementById('topicAnalysis').innerHTML = topics.map(t => {
                const colorClass = t.accuracy >= 70 ? 'green' : t.accuracy >= 50 ? 'yellow' : 'red';
                return `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-label">${t.name}</span>
                            <span class="progress-value">${t.accuracy}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${colorClass}" style="width:${t.accuracy}%"></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--gray);margin-top:5px;">
                            <span>${t.count} quizzes</span>
                            <span>Avg ${t.avgTime}m</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderStrugglingStudents(results, batchStudents) {
            // Calculate per-student stats
            const studentStats = {};
            results.forEach(r => {
                if (!studentStats[r.user_id]) studentStats[r.user_id] = { total: 0, correct: 0, count: 0 };
                studentStats[r.user_id].total += r.total_questions;
                studentStats[r.user_id].correct += r.score;
                studentStats[r.user_id].count++;
            });
            
            const struggling = Object.entries(studentStats)
                .map(([userId, stats]) => {
                    const student = batchStudents.find(bs => bs.student_id === userId);
                    return {
                        userId,
                        name: student?.users?.name || 'Unknown',
                        batch: student?.batches?.name || '-',
                        accuracy: Math.round(stats.correct / stats.total * 100),
                        count: stats.count
                    };
                })
                .filter(s => s.accuracy < 50)
                .sort((a, b) => a.accuracy - b.accuracy);
            
            if (struggling.length === 0) {
                document.getElementById('strugglingStudents').innerHTML = `
                    <div style="text-align:center;padding:30px;color:var(--success);">
                        <div style="font-size:48px;margin-bottom:10px;">üéâ</div>
                        <p>All students are performing well!</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('strugglingStudents').innerHTML = struggling.map(s => `
                <div class="activity-item" style="cursor:pointer;" onclick="viewStudentDetails('${s.userId}')">
                    <div class="activity-icon" style="background:#fee2e2;color:#991b1b;">${s.name.charAt(0)}</div>
                    <div class="activity-details">
                        <div class="activity-title">${s.name}</div>
                        <div class="activity-meta">${s.batch} ‚Ä¢ ${s.count} quizzes</div>
                    </div>
                    <div class="activity-score poor">${s.accuracy}%</div>
                </div>
            `).join('');
        }
        
        function renderTopPerformers(results, batchStudents) {
            // Calculate per-student stats
            const studentStats = {};
            results.forEach(r => {
                if (!studentStats[r.user_id]) studentStats[r.user_id] = { total: 0, correct: 0, time: 0, count: 0, points: 0 };
                studentStats[r.user_id].total += r.total_questions;
                studentStats[r.user_id].correct += r.score;
                studentStats[r.user_id].time += r.time_taken || 0;
                studentStats[r.user_id].count++;
                studentStats[r.user_id].points += r.points_earned || 0;
            });
            
            const topPerformers = Object.entries(studentStats)
                .map(([userId, stats]) => {
                    const student = batchStudents.find(bs => bs.student_id === userId);
                    return {
                        userId,
                        name: student?.users?.name || 'Unknown',
                        batch: student?.batches?.name || '-',
                        accuracy: Math.round(stats.correct / stats.total * 100),
                        avgTime: Math.round(stats.time / stats.count / 60),
                        count: stats.count,
                        points: stats.points
                    };
                })
                .sort((a, b) => b.accuracy - a.accuracy || b.points - a.points)
                .slice(0, 10);
            
            if (topPerformers.length === 0) {
                document.getElementById('topPerformersBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--gray);padding:20px;">No data yet</td></tr>';
                return;
            }
            
            document.getElementById('topPerformersBody').innerHTML = topPerformers.map((s, i) => `
                <tr style="cursor:pointer;" onclick="viewStudentDetails('${s.userId}')">
                    <td><span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;background:${i < 3 ? '#fef3c7' : '#f3f4f6'};border-radius:50%;font-weight:600;font-size:13px;">${i + 1}</span></td>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.batch}</td>
                    <td>${s.count}</td>
                    <td><span class="badge ${s.accuracy >= 70 ? 'badge-success' : s.accuracy >= 50 ? 'badge-warning' : 'badge-danger'}">${s.accuracy}%</span></td>
                    <td>${s.avgTime}m</td>
                    <td><strong>${s.points}</strong></td>
                </tr>
            `).join('');
        }
        
        // ========================================
        // WHITE LABELING & SETTINGS FUNCTIONS
        // ========================================
        
        async function loadBrandingSettings() {
            if (!currentUser || currentUser.role !== 'tutor') return;
            
            try {
                const { data: tutor } = await supabaseClient.from('users')
                    .select('institute_name, institute_tagline')
                    .eq('id', currentUser.id)
                    .single();
                
                if (tutor) {
                    if (tutor.institute_name) {
                        document.getElementById('instituteName').value = tutor.institute_name;
                        currentUser.institute_name = tutor.institute_name;
                    }
                    if (tutor.institute_tagline) {
                        document.getElementById('instituteTagline').value = tutor.institute_tagline;
                        currentUser.institute_tagline = tutor.institute_tagline;
                    }
                    updateBrandingPreview();
                    updateHeaderBranding();
                }
            } catch (error) {
                console.error('Error loading branding:', error);
            }
        }
        
        function updateBrandingPreview() {
            const name = document.getElementById('instituteName')?.value || 'FamLearn Pro';
            const tagline = document.getElementById('instituteTagline')?.value || 'AI-Powered Learning Analytics';
            
            const previewName = document.getElementById('previewInstituteName');
            const previewTagline = document.getElementById('previewTagline');
            
            if (previewName) previewName.textContent = 'üéì ' + name;
            if (previewTagline) previewTagline.textContent = tagline;
        }
        
        function updateHeaderBranding() {
            const name = currentUser?.institute_name || 'FamLearn Pro';
            const tagline = currentUser?.institute_tagline || '';
            
            // Update tutor sidebar header
            const tutorHeader = document.querySelector('#tutorApp .sidebar-header h2');
            if (tutorHeader) {
                tutorHeader.innerHTML = 'üéì ' + name;
            }
        }
        
        async function saveBrandingSettings() {
            const instituteName = document.getElementById('instituteName').value.trim();
            const instituteTagline = document.getElementById('instituteTagline').value.trim();
            
            if (!instituteName) {
                showToast('Please enter institute name', 'error');
                return;
            }
            
            showLoading('Saving branding settings...');
            
            try {
                const { error } = await supabaseClient.from('users')
                    .update({
                        institute_name: instituteName,
                        institute_tagline: instituteTagline
                    })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                currentUser.institute_name = instituteName;
                currentUser.institute_tagline = instituteTagline;
                
                updateHeaderBranding();
                hideLoading();
                showToast('Branding settings saved!', 'success');
            } catch (error) {
                hideLoading();
                showToast('Error saving settings: ' + error.message, 'error');
            }
        }
        
        // Add input listeners for live preview
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('instituteName');
            const taglineInput = document.getElementById('instituteTagline');
            
            if (nameInput) nameInput.addEventListener('input', updateBrandingPreview);
            if (taglineInput) taglineInput.addEventListener('input', updateBrandingPreview);
        });
        
        // ========================================
        // NON-ATTEMPT TRACKING FUNCTIONS
        // ========================================
        
        async function loadNonAttemptStudents() {
            const batchId = document.getElementById('trackingBatchSelect')?.value;
            const container = document.getElementById('nonAttemptList');
            
            if (!batchId) {
                container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--gray);">Select a batch to view tracking</div>';
                return;
            }
            
            container.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading-spinner"></div> Loading...</div>';
            
            try {
                // Get students in batch
                const { data: batchStudents } = await supabaseClient.from('batch_students')
                    .select('student_id, users(id, name, email)')
                    .eq('batch_id', batchId);
                
                // Get quiz assignments for this batch
                const { data: assignments } = await supabaseClient.from('quiz_assignments')
                    .select('*, saved_quizzes(title, topic)')
                    .eq('batch_id', batchId);
                
                if (!assignments || assignments.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--gray);">No quizzes assigned to this batch yet</div>';
                    return;
                }
                
                // Get all quiz results for students in this batch
                const studentIds = batchStudents?.map(bs => bs.student_id) || [];
                const { data: results } = await supabaseClient.from('quiz_results')
                    .select('user_id, shared_quiz_id')
                    .in('user_id', studentIds);
                
                // Build tracking data
                let html = '';
                
                for (const assignment of assignments) {
                    const quizTitle = assignment.saved_quizzes?.title || 'Unknown Quiz';
                    const quizId = assignment.quiz_id;
                    
                    // Find students who haven't attempted this quiz
                    const nonAttemptStudents = batchStudents?.filter(bs => {
                        const hasAttempted = results?.some(r => 
                            r.user_id === bs.student_id && r.shared_quiz_id === quizId
                        );
                        return !hasAttempted;
                    }) || [];
                    
                    const attemptedCount = (batchStudents?.length || 0) - nonAttemptStudents.length;
                    const totalStudents = batchStudents?.length || 0;
                    const completionPercent = totalStudents > 0 ? Math.round((attemptedCount / totalStudents) * 100) : 0;
                    
                    html += `
                        <div style="border:1px solid #e5e7eb;border-radius:10px;padding:15px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                <h4 style="margin:0;">${quizTitle}</h4>
                                <span class="badge ${completionPercent === 100 ? 'badge-success' : completionPercent >= 50 ? 'badge-warning' : 'badge-danger'}">
                                    ${attemptedCount}/${totalStudents} completed (${completionPercent}%)
                                </span>
                            </div>
                            ${nonAttemptStudents.length > 0 ? `
                                <div style="background:#fef2f2;padding:10px;border-radius:6px;">
                                    <strong style="color:#991b1b;">‚ùå Not Attempted:</strong>
                                    <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;">
                                        ${nonAttemptStudents.map(s => `
                                            <span style="background:white;padding:4px 10px;border-radius:20px;font-size:13px;border:1px solid #fecaca;">
                                                ${s.users?.name || 'Unknown'}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div style="background:#f0fdf4;padding:10px;border-radius:6px;color:#065f46;">
                                    ‚úÖ All students have attempted this quiz!
                                </div>
                            `}
                        </div>
                    `;
                }
                
                container.innerHTML = html || '<div style="text-align:center;padding:30px;color:var(--gray);">No data available</div>';
                
            } catch (error) {
                console.error('Error loading non-attempt data:', error);
                container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--danger);">Error loading data</div>';
            }
        }
        
        // ========================================
        // STUDENT PROGRESS REPORT FUNCTIONS
        // ========================================
        
        async function loadStudentsForReport() {
            const batchId = document.getElementById('reportBatchSelect')?.value;
            const studentSelect = document.getElementById('reportStudentSelect');
            
            if (!batchId) {
                studentSelect.innerHTML = '<option value="">Select Batch First</option>';
                return;
            }
            
            try {
                const { data: batchStudents } = await supabaseClient.from('batch_students')
                    .select('student_id, users(id, name)')
                    .eq('batch_id', batchId);
                
                studentSelect.innerHTML = '<option value="">Select Student</option>' +
                    (batchStudents || []).map(bs => 
                        `<option value="${bs.student_id}">${bs.users?.name || 'Unknown'}</option>`
                    ).join('');
                    
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }
        
        async function generateProgressReport() {
            const studentId = document.getElementById('reportStudentSelect')?.value;
            const period = document.getElementById('reportPeriod')?.value;
            const container = document.getElementById('reportPreview');
            
            if (!studentId) {
                showToast('Please select a student', 'error');
                return;
            }
            
            showLoading('Generating report...');
            
            try {
                // Get student info
                const { data: student } = await supabaseClient.from('users')
                    .select('name, email')
                    .eq('id', studentId)
                    .single();
                
                // Get quiz results with date filter
                let query = supabaseClient.from('quiz_results')
                    .select('*')
                    .eq('user_id', studentId)
                    .order('created_at', { ascending: false });
                
                if (period !== 'all') {
                    const days = parseInt(period);
                    const fromDate = new Date();
                    fromDate.setDate(fromDate.getDate() - days);
                    query = query.gte('created_at', fromDate.toISOString());
                }
                
                const { data: results } = await query;
                
                if (!results || results.length === 0) {
                    hideLoading();
                    container.style.display = 'block';
                    container.innerHTML = `
                        <div style="background:#fef3c7;padding:20px;border-radius:8px;text-align:center;">
                            <p style="margin:0;">No quiz data found for ${student?.name || 'this student'} in the selected period.</p>
                        </div>
                    `;
                    return;
                }
                
                // Calculate statistics
                const totalQuizzes = results.length;
                const totalQuestions = results.reduce((sum, r) => sum + r.total_questions, 0);
                const totalCorrect = results.reduce((sum, r) => sum + r.score, 0);
                const avgScore = Math.round((totalCorrect / totalQuestions) * 100);
                const totalTime = results.reduce((sum, r) => sum + (r.time_taken || 0), 0);
                const avgTimePerQuiz = Math.round(totalTime / totalQuizzes / 60);
                const totalPoints = results.reduce((sum, r) => sum + (r.points_earned || 0), 0);
                
                // Subject breakdown
                const subjectStats = {};
                results.forEach(r => {
                    const subject = r.subject || 'General';
                    if (!subjectStats[subject]) {
                        subjectStats[subject] = { correct: 0, total: 0, count: 0 };
                    }
                    subjectStats[subject].correct += r.score;
                    subjectStats[subject].total += r.total_questions;
                    subjectStats[subject].count++;
                });
                
                // Find strengths and weaknesses
                const subjectPerformance = Object.entries(subjectStats).map(([subject, stats]) => ({
                    subject,
                    accuracy: Math.round((stats.correct / stats.total) * 100),
                    quizzes: stats.count
                })).sort((a, b) => b.accuracy - a.accuracy);
                
                const strengths = subjectPerformance.filter(s => s.accuracy >= 70);
                const weaknesses = subjectPerformance.filter(s => s.accuracy < 50);
                
                // Generate report HTML
                const reportDate = new Date().toLocaleDateString('en-IN', { 
                    day: 'numeric', month: 'long', year: 'numeric' 
                });
                const periodText = period === 'all' ? 'All Time' : `Last ${period} Days`;
                
                container.style.display = 'block';
                container.innerHTML = `
                    <div style="border:2px solid var(--primary);border-radius:12px;overflow:hidden;">
                        <div style="background:linear-gradient(135deg, var(--primary), var(--secondary));color:white;padding:20px;text-align:center;">
                            <h2 style="margin:0 0 5px 0;">üìä Student Progress Report</h2>
                            <p style="margin:0;opacity:0.9;">${currentUser?.institute_name || 'FamLearn Pro'}</p>
                        </div>
                        
                        <div style="padding:20px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #e5e7eb;">
                                <div>
                                    <strong style="font-size:18px;">${student?.name || 'Student'}</strong>
                                    <div style="color:var(--gray);font-size:13px;">${student?.email || ''}</div>
                                </div>
                                <div style="text-align:right;font-size:13px;color:var(--gray);">
                                    <div>Report Generated: ${reportDate}</div>
                                    <div>Period: ${periodText}</div>
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:20px;">
                                <div style="background:#f0f9ff;padding:15px;border-radius:8px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:var(--primary);">${totalQuizzes}</div>
                                    <div style="font-size:12px;color:var(--gray);">Quizzes Taken</div>
                                </div>
                                <div style="background:#f0fdf4;padding:15px;border-radius:8px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:var(--success);">${avgScore}%</div>
                                    <div style="font-size:12px;color:var(--gray);">Avg Accuracy</div>
                                </div>
                                <div style="background:#fef3c7;padding:15px;border-radius:8px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:var(--warning);">${totalPoints}</div>
                                    <div style="font-size:12px;color:var(--gray);">Points Earned</div>
                                </div>
                                <div style="background:#fdf2f8;padding:15px;border-radius:8px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#db2777;">${avgTimePerQuiz}m</div>
                                    <div style="font-size:12px;color:var(--gray);">Avg Time/Quiz</div>
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                                <div>
                                    <h4 style="margin:0 0 10px 0;color:var(--success);">üí™ Strengths</h4>
                                    ${strengths.length > 0 ? strengths.map(s => `
                                        <div style="background:#f0fdf4;padding:10px;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;">
                                            <span>${s.subject}</span>
                                            <strong style="color:var(--success);">${s.accuracy}%</strong>
                                        </div>
                                    `).join('') : '<div style="color:var(--gray);font-size:13px;">Keep practicing to identify strengths!</div>'}
                                </div>
                                <div>
                                    <h4 style="margin:0 0 10px 0;color:var(--danger);">üéØ Needs Improvement</h4>
                                    ${weaknesses.length > 0 ? weaknesses.map(s => `
                                        <div style="background:#fef2f2;padding:10px;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;">
                                            <span>${s.subject}</span>
                                            <strong style="color:var(--danger);">${s.accuracy}%</strong>
                                        </div>
                                    `).join('') : '<div style="color:var(--gray);font-size:13px;">Great job! No weak areas identified.</div>'}
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="margin:0 0 10px 0;">üìö Subject-wise Performance</h4>
                                ${subjectPerformance.map(s => `
                                    <div style="margin-bottom:10px;">
                                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                            <span>${s.subject}</span>
                                            <span>${s.accuracy}% (${s.quizzes} quiz${s.quizzes > 1 ? 'zes' : ''})</span>
                                        </div>
                                        <div style="background:#e5e7eb;border-radius:4px;height:8px;overflow:hidden;">
                                            <div style="background:${s.accuracy >= 70 ? 'var(--success)' : s.accuracy >= 50 ? 'var(--warning)' : 'var(--danger)'};height:100%;width:${s.accuracy}%;"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="background:#f9fafb;padding:15px;text-align:center;font-size:12px;color:var(--gray);">
                            Generated by ${currentUser?.institute_name || 'FamLearn Pro'} ‚Ä¢ ${reportDate}
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="printReport()" style="width:100%;margin-top:15px;">
                        üñ®Ô∏è Print Report
                    </button>
                `;
                
                hideLoading();
                
            } catch (error) {
                hideLoading();
                console.error('Error generating report:', error);
                showToast('Error generating report: ' + error.message, 'error');
            }
        }
        
        function printReport() {
            const reportContent = document.getElementById('reportPreview').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Student Progress Report</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; }
                        .btn { display: none; }
                    </style>
                </head>
                <body>${reportContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        async function initTutorDashboard() {
            await loadTutorStats();
            await loadBatches();
            setupTutorImageUpload();
            
            // Load branding settings
            await loadBrandingSettings();
            
            // Populate settings page dropdowns
            populateSettingsDropdowns();
            
            // Check for saved tutor images
            setTimeout(() => checkForSavedTutorImages(), 500);
        }
        
        function populateSettingsDropdowns() {
            // Copy batch options to settings dropdowns
            const batchOptions = document.getElementById('tutorQuizBatch')?.innerHTML || '<option value="">No batches</option>';
            
            const trackingSelect = document.getElementById('trackingBatchSelect');
            const reportBatchSelect = document.getElementById('reportBatchSelect');
            
            if (trackingSelect) trackingSelect.innerHTML = batchOptions;
            if (reportBatchSelect) reportBatchSelect.innerHTML = batchOptions;
        }

        // ========================================
        // VIEW PAST QUIZ SOLUTIONS (for revision)
        // ========================================
        function viewPastQuizSolutions(index) {
            const quizData = window.quizHistoryData?.[index];
            if (!quizData || !quizData.questions) {
                showToast('Quiz data not available', 'error');
                return;
            }
            
            const questions = quizData.questions;
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.cssText = 'overflow-y:auto;';
            
            const reviewHtml = questions.map((q, i) => {
                const userAnswer = q.userAnswer;
                const isCorrect = userAnswer === q.correct;
                const wasSkipped = userAnswer === undefined || userAnswer === -1;
                
                const correctLetter = String.fromCharCode(65 + q.correct);
                const correctText = q.options[q.correct];
                const userLetter = (!wasSkipped && userAnswer >= 0) ? String.fromCharCode(65 + userAnswer) : 'None';
                const userText = (!wasSkipped && userAnswer >= 0) ? q.options[userAnswer] : 'Skipped';
                
                return `
                    <div style="margin-bottom:20px;padding:20px;background:#f9fafb;border-radius:12px;border-left:4px solid ${isCorrect ? '#10b981' : '#ef4444'};">
                        <div style="font-weight:600;color:${isCorrect ? '#10b981' : '#ef4444'};margin-bottom:10px;">
                            Question ${i + 1} ‚Äî ${isCorrect ? '‚úì Correct' : wasSkipped ? '‚äò Skipped' : '‚úó Incorrect'}
                        </div>
                        <div style="font-size:15px;margin-bottom:15px;">${q.question}</div>
                        <div style="margin-bottom:15px;">
                            ${q.options.map((opt, j) => {
                                let bg = '#fff';
                                let border = '#e5e7eb';
                                let indicator = '';
                                
                                if (j === q.correct) {
                                    bg = '#d1fae5';
                                    border = '#10b981';
                                    indicator = ' ‚úì';
                                } else if (j === userAnswer && !isCorrect) {
                                    bg = '#fee2e2';
                                    border = '#ef4444';
                                    indicator = ' ‚úó';
                                }
                                
                                return `<div style="padding:10px 15px;margin:5px 0;background:${bg};border:2px solid ${border};border-radius:8px;">
                                    <strong>${String.fromCharCode(65 + j)}.</strong> ${opt}${indicator}
                                </div>`;
                            }).join('')}
                        </div>
                        <div style="padding:15px;background:#e0f2fe;border-radius:8px;">
                            <div style="color:#065f46;font-weight:600;margin-bottom:8px;">‚úÖ Correct: (${correctLetter}) ${correctText}</div>
                            ${!isCorrect ? `<div style="color:#991b1b;margin-bottom:8px;">‚ùå You selected: (${userLetter}) ${userText}</div>` : ''}
                            ${q.explanation ? `<div style="color:#1f2937;margin-top:10px;"><strong>üìñ Explanation:</strong> ${q.explanation}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width:800px;max-height:90vh;overflow-y:auto;">
                    <div class="modal-header">
                        <h3 class="modal-title">üìñ ${quizData.topic || 'Quiz'} - Solutions</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="margin-bottom:20px;padding:15px;background:var(--light);border-radius:10px;display:flex;justify-content:space-around;text-align:center;">
                        <div><div style="font-size:1.5rem;font-weight:700;color:var(--primary);">${quizData.score}/${quizData.total_questions}</div><div style="font-size:12px;color:var(--gray);">Score</div></div>
                        <div><div style="font-size:1.5rem;font-weight:700;color:var(--success);">${Math.round(quizData.score/quizData.total_questions*100)}%</div><div style="font-size:12px;color:var(--gray);">Accuracy</div></div>
                        <div><div style="font-size:1.5rem;font-weight:700;color:var(--warning);">${formatTime(quizData.time_taken || 0)}</div><div style="font-size:12px;color:var(--gray);">Time</div></div>
                    </div>
                    ${reviewHtml}
                    <button class="btn" onclick="this.closest('.modal').remove()" style="margin-top:20px;">Close</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ========================================
        // INIT
        // ========================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                const { data: profile } = await supabaseClient.from('users').select('*').eq('id', session.user.id).single();
                if (profile) {
                    currentUser = await ensureSubscriptionFields(profile);
                    initApp();
                }
            }
        }

        checkAuth();
    </script>
</body>
</html>

